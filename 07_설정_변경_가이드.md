# 설정 변경 가이드 (비개발자용)

> **대상:** 운영팀, SCM 기획팀, 재무팀
> 개발팀 도움 없이 직접 바꿀 수 있는 설정만 모았습니다.
> 이 문서에 없는 변경은 개발팀에 요청해야 합니다.

---

## 시작 전 알아두기

### 설정 파일이란?
시스템의 동작 방식을 조정하는 텍스트 파일입니다.
프로젝트 폴더 안의 `config/` 폴더에 모여 있습니다.

```
프로젝트 폴더/
├── config/
│   ├── thresholds.yaml          ← 경고 임계값
│   ├── column_aliases.yaml      ← 컬럼명 별칭
│   └── policies/
│       └── charge_policy.yaml   ← 비용 유형 정의
```

### 파일 여는 방법
`.yaml` 파일은 **메모장** 또는 **VS Code** (무료) 로 열 수 있습니다.
- 파일 우클릭 → "연결 프로그램" → 메모장

### YAML 파일 작성 규칙 (꼭 지켜야 함)
- **들여쓰기는 반드시 스페이스** (탭 키 사용 금지)
- **콜론(`:`) 뒤에 스페이스** 필수: `key: value`
- **숫자는 따옴표 없이**: `90` (O), `"90"` (X)
- **문자는 따옴표 없이** 또는 따옴표로: `warn` 또는 `"warn"` 모두 가능

> **주의:** 들여쓰기나 문법이 틀리면 시스템 오류가 발생합니다.
> 변경 전 파일을 **복사본으로 백업**해두는 것을 권장합니다.

### 변경 후 적용 방법
설정을 저장한 뒤 아래 명령어를 실행하면 바뀐 설정이 즉시 적용됩니다:
```
python run.py --once
```
대시보드를 열어둔 경우 새로고침하면 반영됩니다.

---

## 1. 경고 임계값 조정

**파일 경로:** `config/thresholds.yaml`

경고가 너무 자주 뜨거나, 반대로 너무 늦게 뜬다면 이 파일의 숫자를 조정합니다.

---

### 1-1. 과재고 기준 (재고일수)

> "재고가 X일치 이상이면 과재고 경고"

```yaml
inventory:
  doh_overstock:
    RM: 120    # 원자재: 120일치 이상이면 과재고
    PM: 180    # 포장재: 180일치 이상이면 과재고
    WIP: 90    # 반제품: 90일치 이상이면 과재고
    FG: 90     # 완제품: 90일치 이상이면 과재고
```

**변경 예시:** 완제품 과재고 기준을 90일 → 60일로 엄격하게 하려면:
```yaml
    FG: 60     # 변경 후
```

| 카테고리 | 코드 | 의미 |
|---------|-----|-----|
| 원자재 | `RM` | Raw Material |
| 포장재 | `PM` | Packaging Material |
| 반제품 | `WIP` | Work In Progress |
| 완제품 | `FG` | Finished Goods |

---

### 1-2. 품절 위험 기준

> "재고가 X일치 미만이면 품절 위험 경고"

```yaml
inventory:
  stockout_days_cover:
    default: 7    # 기본: 7일치 미만이면 경고
    FG: 10        # 완제품은 더 엄격하게: 10일치 미만이면 경고
```

**변경 예시:** 기본 기준을 7일 → 14일로 높이려면:
```yaml
    default: 14
```

---

### 1-3. 유통기한 위험 구간

> "유통기한까지 X일 이하로 남으면 해당 버킷에 표시"

```yaml
expiry:
  buckets_days: [0, 30, 60, 90, 180, 365]
```

- `0`: 이미 만료된 재고
- `30`: 30일 이내 만료 예정
- `60`: 60일 이내 만료 예정
- ... 이하 동일

**변경 예시:** 45일 버킷을 추가하려면:
```yaml
  buckets_days: [0, 30, 45, 60, 90, 180, 365]
```

---

### 1-4. 최소 판매가능 잔여 유통기한

> "유통기한이 X일 미만 남으면 판매 불가로 간주"

```yaml
expiry:
  min_sellable_days_default:
    RM: 30     # 원자재: 30일 미만 남으면 판매 불가
    PM: 90     # 포장재: 90일 미만 남으면 판매 불가
    FG: 60     # 완제품: 60일 미만 남으면 판매 불가
```

---

### 1-5. 재고 대사 허용 오차

> "재고 조정 비율이 X%를 넘으면 경고/오류"

```yaml
reconciliation:
  inventory_adjustment_ratio_warn: 0.01    # 1% 초과 시 경고 (노랑)
  inventory_adjustment_ratio_high: 0.03    # 3% 초과 시 오류 (빨강)
```

**변경 예시:** 경고 기준을 2%로 완화하려면:
```yaml
  inventory_adjustment_ratio_warn: 0.02
```

---

### 1-6. 공급망 제약 경고 기준

```yaml
constraints:
  supply:
    late_po_ratio_high: 0.2          # 발주 지연율 20% 이상 → 경고
    supplier_delay_days_high: 7      # 납기 7일 이상 초과 → 경고

  warehouse_3pl:
    backlog_ship_orders_high: 200    # 미처리 주문 200건 이상 → 경고
    pick_pack_throughput_ratio_low: 0.8   # 처리량 80% 미만 → 경고

  logistics_customs:
    dwell_time_days_high: 5          # 통관 5일 이상 → 경고
    carrier_on_time_rate_low: 0.9    # 운송사 정시율 90% 미만 → 경고

  demand_channel:
    return_rate_spike_ratio_high: 1.5    # 반품율이 기준 1.5배 이상 → 경고
    promo_lift_ratio_high: 2.0           # 프로모션 수요가 2배 이상 → 경고
```

**자주 조정하는 항목:**

| 상황 | 조정할 항목 | 방향 |
|------|-----------|-----|
| 발주 지연 경고가 너무 자주 뜸 | `late_po_ratio_high` | 값을 높임 (예: 0.2 → 0.3) |
| 백로그 경고 기준을 높이고 싶음 | `backlog_ship_orders_high` | 값을 높임 (예: 200 → 300) |
| 반품율 경고를 더 민감하게 | `return_rate_spike_ratio_high` | 값을 낮춤 (예: 1.5 → 1.2) |

---

## 2. 컬럼명 별칭 추가

**파일 경로:** `config/column_aliases.yaml`

3PL, 쇼핑몰 등 소스 시스템이 우리 시스템과 다른 컬럼명을 사용할 때 추가합니다.

### 어떤 경우에 필요한가?

예를 들어, 새로운 3PL이 재고 파일의 창고 컬럼명으로 `"센터코드"`를 사용하는데
시스템은 `warehouse_id`를 인식하는 경우, `"센터코드"`를 별칭으로 등록하면 됩니다.

### 현재 등록된 별칭 예시

```yaml
aliases:
  fact_inventory_snapshot:
    warehouse_id: ["warehouse_id", "센터", "창고", "wh_id"]
    #                ↑ 기본값      ↑ 이미 등록된 한국어 별칭들
```

### 새 별칭 추가 방법

기존 목록 뒤에 `"새컬럼명"`을 추가합니다.

**변경 예시:** 재고 파일의 창고 컬럼명으로 `"센터코드"`를 추가하려면:

**변경 전:**
```yaml
    warehouse_id: ["warehouse_id", "센터", "창고", "wh_id"]
```

**변경 후:**
```yaml
    warehouse_id: ["warehouse_id", "센터", "창고", "wh_id", "센터코드"]
```

### 주요 테이블별 수정 가능 항목

| 데이터 파일 | YAML 섹션명 |
|-----------|-----------|
| 주문 파일 | `fact_order` |
| 출고 파일 | `fact_shipment` |
| 재고 파일 | `fact_inventory_snapshot` |
| 비용 파일 | `fact_charge_actual` |

> **팁:** 별칭은 **대소문자를 구분하지 않습니다.**
> `"WH_ID"`, `"wh_id"`, `"Wh_Id"` 모두 동일하게 인식됩니다.

---

## 3. 새 비용 유형 등록

**파일 경로:** `config/policies/charge_policy.yaml`

3PL이나 운송사에서 청구하는 새로운 비용 항목이 생겼을 때 등록합니다.
등록하지 않으면 해당 비용 코드가 포함된 파일이 **오류로 거부**됩니다.

### 새 비용 유형 추가 방법

파일 끝에 새 항목을 추가합니다. 4가지 값을 지정해야 합니다:

```yaml
  새_비용코드:
    charge_domain: 도메인
    cost_stage: 단계
    capitalizable_flag: false
    default_allocation_basis: 배분기준
    severity_if_missing: warn
```

### 도메인 (`charge_domain`) 선택

| 도메인 코드 | 의미 |
|-----------|-----|
| `logistics_transport` | 운송 관련 비용 |
| `3pl_billing` | 3PL 창고 관련 비용 |
| `customs` | 통관·관세 관련 비용 |
| `platform_fee` | 쇼핑몰 플랫폼 수수료 |
| `marketing` | 마케팅 비용 |

### 단계 (`cost_stage`) 선택

| 단계 코드 | 의미 |
|---------|-----|
| `inbound_landed` | 입고·통관 단계 비용 |
| `storage` | 창고 보관 비용 |
| `outbound` | 출고·배송 단계 비용 |
| `returns` | 반품 처리 비용 |
| `period` | 기간별 정액 비용 |

### 배분 기준 (`default_allocation_basis`) 선택

> "이 비용을 품목별로 나눌 때 어떤 기준으로 쪼갤 것인가"

| 배분 기준 코드 | 의미 |
|-------------|-----|
| `qty` | 수량 비례 |
| `weight` | 무게 비례 |
| `volume_cbm` | 부피(CBM) 비례 |
| `order_count` | 주문 건수 비례 |
| `line_count` | 주문 라인 수 비례 |
| `revenue` | 매출 비례 |
| `onhand_cbm_days` | 보관 부피 × 일수 비례 (보관비에 적합) |

### 변경 예시

새로운 "냉동 보관료" (`COLD_STORAGE_FEE`) 항목을 추가하려면:

```yaml
  COLD_STORAGE_FEE:
    charge_domain: 3pl_billing
    cost_stage: storage
    capitalizable_flag: false
    default_allocation_basis: onhand_cbm_days
    severity_if_missing: warn
```

> **비용 코드(`새_비용코드`)는 영어 대문자와 언더스코어(`_`)만 사용하세요.**
> 예: `COLD_STORAGE_FEE` (O), `냉동보관료` (X), `cold storage` (X)

> **이 비용 코드는 실제 파일의 `charge_type` 컬럼 값과 정확히 일치해야 합니다.**

---

## ⚠ 개발팀에 요청해야 하는 것

아래 변경 사항은 **절대 직접 수정하지 마세요.** 시스템 오류나 데이터 손상이 발생할 수 있습니다.

| 변경 내용 | 이유 |
|---------|-----|
| 새로운 컬럼 추가 (예: 상품에 새 속성 추가) | 데이터베이스 구조 변경 필요 |
| 새로운 KPI 계산식 추가 | 프로그램 코드(Python) 수정 필요 |
| 대시보드 탭 추가 또는 삭제 | 프로그램 코드(Python) 수정 필요 |
| 비용 배분 방식(알고리즘) 변경 | 복잡한 수식 코드 변경 필요 |
| P&L 마트 계산 로직 변경 | 데이터 무결성 위험 |
| 새로운 소스 시스템 연동 | 전체 파이프라인 영향 |

**개발팀 요청 시 제공할 정보:**
- 무엇을 추가/변경하고 싶은지
- 왜 필요한지 (비즈니스 이유)
- 참고 예시나 기존 비슷한 사례

---

## 설정 변경 후 체크리스트

변경을 마쳤으면 아래 순서대로 확인하세요:

- [ ] 파일을 저장했는가?
- [ ] YAML 문법이 맞는가? (들여쓰기, 콜론 뒤 스페이스)
- [ ] `python run.py --once` 를 실행했는가?
- [ ] 오류 메시지가 없는가?
- [ ] 대시보드를 새로고침하여 변경 사항이 반영되었는가?

> 오류가 발생했다면 백업해둔 파일로 되돌리고 개발팀에 문의하세요.

---

*더 자세한 기술 정보는 `docs/스키마_지표_커스터마이징.md`를 참고하세요.*
