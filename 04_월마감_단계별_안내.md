# 월 마감 단계별 안내

> **대상:** 재무/회계팀, 운영팀 담당자
> 매월 초에 전월 데이터를 확정하는 절차를 설명합니다.

---

## 마감이란 무엇인가요?

**비유:** 월말 결산처럼, 해당 월의 데이터를 "이것으로 확정"하고 봉인하는 작업입니다.

마감 후에는:
- 해당 월 데이터를 직접 수정할 수 없습니다
- 수정이 꼭 필요하면 별도 "조정" 절차를 통해야 합니다 (이력 남음)
- 손익 보고서, 비용 배분 등이 확정 수치로 고정됩니다

---

## 기간 상태 3가지

| 상태 | 의미 | 비유 |
|------|------|-----|
| **열림 (OPEN)** | 데이터 입력·수정 자유롭게 가능 | "영업 중인 가게" |
| **닫힘 (CLOSED)** | 직접 수정 불가. 조정은 이력과 함께 가능 | "마감 후, 영수증 수정은 별도 전표로" |
| **잠금 (LOCKED)** | 어떤 수정도 불가. 감사용으로 완전 봉인 | "감사 기간 중 문서 봉인" |

---

## 마감 전 준비 체크리스트

마감 실행 전에 아래 항목을 모두 확인하세요.

- [ ] **주문·출고·재고 데이터** — 해당 월 전체 날짜 데이터가 들어와 있는가?
- [ ] **구매발주·입고 데이터** — 해당 월 발생 건이 모두 입력되었는가?
- [ ] **정산 인보이스** — 3PL/운송사에서 받은 청구서가 입력되었는가?
- [ ] **비용 데이터** — 재무팀이 정리한 월별 비용이 입력되었는가?
- [ ] **환율** — 해당 월 사용 환율이 입력되었는가?
- [ ] **비용 구조** — 품목별 단위원가가 입력되었는가?
- [ ] **커버리지 100%** — 아래 명령어로 확인
  ```
  python run.py --status
  ```
  → "Coverage: 100%" 메시지가 나와야 합니다
- [ ] **오류 없음** — 빨간색 CRITICAL 오류가 없어야 합니다
- [ ] **손익 확인** — P&L 대시보드에서 매출·원가·마진 수치가 합리적인지 확인
- [ ] **이해관계자 승인** — 재무팀장 또는 CFO 최종 확인

---

## 마감 실행 방법

### 방법 A: 기술 담당자에게 요청 (권장)
체크리스트 완료 후 개발팀/기술 담당자에게 마감 실행을 요청합니다.

담당자에게 전달할 정보:
- 마감할 기간 (예: "2025년 1월")
- 담당자 이름 (기록용)
- 특이사항 (있다면)

### 방법 B: 직접 실행 (담당자 권한 있을 때)
명령 프롬프트에서 아래를 입력합니다:
```
python -c "
from src.db import get_connection
from src.period_close import close_period
con = get_connection()
close_period(con, '2025-01', '담당자이름', notes='1월 정기 마감')
print('마감 완료!')
con.close()
"
```
`2025-01`과 `담당자이름`을 실제 값으로 바꿔서 입력하세요.

### 마감이 거부될 때

커버리지가 100%가 아니거나 오류가 있으면 마감이 자동으로 거부됩니다.

```
오류 예시:
ValueError: Coverage check failed. Missing tables: fact_settlement, fact_exchange_rate
```

→ 누락된 데이터를 넣고 다시 시도하세요.

---

## 마감 후 수정이 필요할 때

마감 후에도 오류를 발견했다면, **조정(Adjustment)** 절차를 사용합니다.

**조정의 특징:**
- 변경 이력이 모두 기록됩니다 (누가, 언제, 왜 수정했는지)
- 감사 추적이 가능합니다
- 수정 후 자동으로 대시보드에 반영됩니다

조정은 기술 담당자에게 요청하고, 아래 정보를 제공하세요:
- 어떤 데이터를 수정해야 하는가
- 기존 값과 새로운 값
- 수정 이유 (상세히)

---

## 잠금 (LOCKED) 처리

CFO 또는 외부 감사 승인 후, 해당 기간을 완전히 봉인합니다.

**잠금 후에는:**
- 조정도 불가능합니다
- 오직 데이터베이스 직접 접근으로만 해제 가능 (일반 사용자 불가)

잠금 처리는 개발팀에 요청하세요.

---

## 마감 취소가 필요할 때 (긴급 상황)

마감 후 대규모 오류를 발견했을 때 마감을 되돌릴 수 있습니다.

> ⚠️ **주의:** 마감 취소는 긴급한 경우에만 사용합니다.

기술 담당자에게 요청하면서 아래 정보 제공:
- 마감을 취소해야 하는 이유
- 어떤 데이터를 수정해야 하는지

마감 취소 후에는 데이터를 수정하고 다시 처음부터 마감 절차를 진행합니다.

---

## 월별 마감 타임라인 예시

```
예시: 2025년 1월 마감

1월 1일 ~ 1월 31일
  └── 매일: 주문/출고/재고 데이터 입력
  └── 수시: 발주/입고/반품 입력

2월 1일 ~ 2월 3일 (마감 준비)
  ├── 3PL/운송사에서 1월 정산 인보이스 수령
  ├── 재무팀에서 비용·환율·비용구조 파일 준비
  └── inbox에 파일 넣고 python run.py --once 실행

2월 3일 (마감 실행)
  ├── python run.py --status 로 커버리지 100% 확인
  ├── P&L 대시보드에서 손익 검토
  ├── 이해관계자 승인
  └── close_period 실행 → 마감 완료!

2월 5일 (필요시 조정)
  └── 늦게 도착한 인보이스 등 조정 처리

2월 10일 (필요시 잠금)
  └── lock_period 실행 → 감사용 봉인
```

---

## 자주 묻는 질문

**Q. 마감을 꼭 해야 하나요?**
마감을 하지 않아도 일상 운영(재고·주문·출고 분석)은 계속됩니다. 다만 손익 보고서의 수치가 계속 변동되며 "확정값"이 없습니다. 재무 보고서 작성, 감사 대응을 위해 마감을 권장합니다.

**Q. 커버리지가 95%인데 마감해야 할 경우는요?**
일부 데이터가 불가피하게 늦을 경우, 개발팀에 "강제 마감" 처리를 요청할 수 있습니다. 단, 손익 수치가 PARTIAL(추정 포함)로 표시됩니다. 이 경우 메모에 사유를 남기는 것을 권장합니다.

**Q. 마감 후 P&L 숫자가 조금 달라진다면?**
마감 후 조정 처리가 있으면 수치가 변경될 수 있습니다. 모든 조정은 이력이 남으니 대시보드의 "감사 추적" 탭에서 확인 가능합니다.

---

*더 자세한 기술 정보는 `docs/기간마감_절차.md`를 참고하세요.*
