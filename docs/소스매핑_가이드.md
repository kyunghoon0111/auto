# 소스 매핑

> 소스 시스템에서 RAW, CORE, MART 레이어까지 데이터가 흐르는 방식.

---

## 소스 시스템

| 시스템 | 약칭 | 설명 | 일반 형식 |
|---|---|---|---|
| 주문 관리 시스템 | OMS | 판매 주문, 반품, 채널 데이터 | API JSON / CSV |
| 창고 관리 시스템 | WMS | 출고, 입고, 재고 스냅샷 | CSV / SFTP 플랫 파일 |
| 전사 자원 관리 | ERP | 구매 발주, 입고 전기, 코스트센터 | API JSON / CSV |
| 정산 / 청구 | STL | 3PL 인보이스, 운송사 인보이스, 단가표 | CSV / Excel |
| 시장 데이터 | MKT | 환율 | API JSON |

---

## 레이어별 역할

### RAW -- 원본 분리 보관

- 소스 파일 또는 API 엔드포인트당 하나의 raw 테이블.
- 소스에서 받은 컬럼명을 그대로 유지.
- 변환, 중복 제거, 타입 캐스팅 없음.
- 감사 컬럼 (`_raw_loaded_at`, `_raw_source_file`) 추가.
- 데이터는 **추가 전용**: 수정된 파일은 새 행을 생성하며, 기존 행을 덮어쓰지 않음.
- 목적: 원본 소스까지 완전한 추적성 확보.

### CORE -- 정규화

- 표준화된 컬럼명, 데이터 타입, 값 도메인.
- 비즈니스 키를 단일 정규 형태로 해석.
- 타입 강제 변환 적용 (문자열 → 날짜, 숫자 → `DECIMAL` 캐스팅).
- 선택적 PK 구성요소에 센티넬 `'__NONE__'` 삽입.
- 중복 제거: 동일 비즈니스 키가 여러 raw 행에 있으면 최신 `_raw_loaded_at`이 우선.
- 통화 금액은 원래 통화로 유지; `fact_exchange_rate`로 다운스트림에서 환산.

### MART -- 충돌 해결

- 교차 소스 대사: OMS와 WMS의 수량이 불일치하면 마트가 차이를 플래그 처리.
- 각 대시보드에 필요한 입도로 사전 집계.
- 매 파이프라인 실행 시 처음부터 재구축 (증분 상태 없음).
- 충돌 해결 규칙:
  - **수량 충돌**: WMS가 실물 재고의 권위 소스; OMS가 주문 의도의 권위 소스.
  - **일자 충돌**: 가장 이른 확인 일자가 우선 (예: OMS보다 WMS의 출고일).
  - **비용 충돌**: 정산 (인보이스)이 추정 비용보다 권위.

---

## 소스 → CORE 매핑

### OMS 소스

| Raw 테이블 | CORE 대상 | 키 매핑 | 비고 |
|---|---|---|---|
| `raw.oms_orders` | `core.fact_order` | `order_number` → `order_id`, `line_seq` → `order_line_id` | 상태값을 열거형으로 정규화 |
| `raw.oms_orders` | `core.dim_channel_store` | `channel_code` + `store_code` → `channel_store_id` | 키 기준 upsert |
| `raw.oms_returns` | `core.fact_return` | `return_number` → `return_id`, `line_seq` → `return_line_id` | 사유 코드를 조회 테이블로 매핑 |

### WMS 소스

| Raw 테이블 | CORE 대상 | 키 매핑 | 비고 |
|---|---|---|---|
| `raw.wms_shipments` | `core.fact_shipment` | `shipment_no` → `shipment_id`, `line_no` → `shipment_line_id` | 중량/부피를 KG/CBM으로 환산 |
| `raw.wms_receipts` | `core.fact_receipt` | `receipt_no` → `receipt_id`, `line_no` → `receipt_line_id` | `lot_id` 기본값 `'__NONE__'` |
| `raw.wms_inventory` | `core.fact_inventory_snapshot` | `snapshot_dt` → `snapshot_date`, `sku` → 조회를 통해 `item_id` | `lot_id` 센티넬 적용 |
| `raw.wms_receipts` | `core.dim_warehouse` | `site_code` → `warehouse_id` | 키 기준 upsert |

### ERP 소스

| Raw 테이블 | CORE 대상 | 키 매핑 | 비고 |
|---|---|---|---|
| `raw.erp_purchase_orders` | `core.fact_po` | `po_number` → `po_id`, `line_item` → `po_line_id` | 상태값 정규화 |
| `raw.erp_goods_receipts` | `core.fact_receipt` | `po_id` + 일자로 기존 입고와 매칭 | WMS 입고에 ERP 전기 데이터를 보충 |
| `raw.erp_purchase_orders` | `core.dim_partner` | `vendor_code` → `partner_id` | `partner_type = 'SUPPLIER'` |
| `raw.erp_cost_centers` | `core.dim_warehouse` | 설정을 통해 `cost_center` → `warehouse_id` 매핑 | 창고 마스터 보강 |

### 정산 소스

| Raw 테이블 | CORE 대상 | 키 매핑 | 비고 |
|---|---|---|---|
| `raw.stl_invoices` | `core.fact_settlement` | `invoice_no` → `settlement_id`, `line_no` → `settlement_line_id` | 비용 유형을 `dim_charge_policy` 기준으로 검증 |
| `raw.stl_rates` | `core.dim_charge_policy` | `rate_code` → `charge_type` | Upsert; YAML 기본값을 재정의 |

### 시장 데이터 소스

| Raw 테이블 | CORE 대상 | 키 매핑 | 비고 |
|---|---|---|---|
| `raw.fx_rates` | `core.fact_exchange_rate` | `date` → `rate_date`, `base` → `from_currency`, `quote` → `to_currency` | 역방향 환율도 생성 |

---

## 차원 로딩 전략

| 차원 | 전략 | 소스 우선순위 |
|---|---|---|
| `dim_item` | 품목 마스터 파일에서 전체 재적재 | ERP (주), OMS (신규 품목 보조) |
| `dim_partner` | `partner_id` 기준 upsert | ERP (공급업체), WMS (3PL 운영사), OMS (마켓플레이스 파트너) |
| `dim_channel_store` | `channel_store_id` 기준 upsert | OMS 단독 |
| `dim_warehouse` | `warehouse_id` 기준 upsert | WMS (주), ERP (보강) |
| `dim_uom_conversion` | 설정에서 전체 재적재 | 설정 YAML / ERP 마스터 |
| `dim_charge_policy` | 병합: YAML 기본 + 정산 단가 재정의 | `charge_policy.yaml` (기본), STL (재정의) |

---

## 데이터 흐름 다이어그램 (텍스트)

```
  OMS ──> raw.oms_orders ──────> core.fact_order ──────┐
  OMS ──> raw.oms_returns ─────> core.fact_return ─────┤
  WMS ──> raw.wms_shipments ───> core.fact_shipment ───┤
  WMS ──> raw.wms_receipts ────> core.fact_receipt ────┤── mart.*
  WMS ──> raw.wms_inventory ───> core.fact_inventory   │   (28개 테이블)
  ERP ──> raw.erp_purchase_orders > core.fact_po ──────┤
  ERP ──> raw.erp_goods_receipts ──> (입고 보강)       ┤
  STL ──> raw.stl_invoices ────> core.fact_settlement ─┤
  STL ──> raw.stl_rates ──────> core.dim_charge_policy │
  MKT ──> raw.fx_rates ───────> core.fact_exchange_rate┘
```
