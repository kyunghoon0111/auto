# 대사 (Reconciliation)

> 소스 시스템 간 데이터를 교차 검증하는 5개 대사 마트. 각 마트는 두 개 이상의 데이터 소스를 비교하여 불일치를 플래그 처리합니다.

---

## 개요

대사(reco) 마트는 OMS, WMS, ERP, 정산 시스템 간 데이터 불일치를 감지하는 핵심 메커니즘입니다. 매 파이프라인 실행 시 재구축되며 Streamlit 대시보드에 표시됩니다.

| # | 마트 테이블 | 비교 시스템 | 입도 |
|---|---|---|---|
| 1 | `mart.reco_inventory_movement` | WMS 스냅샷 vs 거래 산출 | 품목 x 창고 x 기간 |
| 2 | `mart.reco_oms_vs_wms` | OMS 주문 vs WMS 출고 | 주문 x 라인 |
| 3 | `mart.reco_erp_gr_vs_wms_receipt` | ERP 입고 전기 vs WMS 입고 | 발주 x 라인 |
| 4 | `mart.reco_settlement_vs_estimated` | 정산 인보이스 vs 단가 기반 추정 | 비용유형 x 거래처 x 기간 |
| 5 | `mart.reco_charges_invoice_vs_allocated` | 인보이스 총액 vs 배분된 비용 총액 | 비용유형 x 기간 |

---

## 1. 재고 이동 대사

**마트**: `mart.reco_inventory_movement`

### 비교 대상

재고 흐름의 수학적 항등식:

```
기말수량 = 기초수량 + 입고 - 출고 - 반품출고 + 반품입고 + 조정
```

마트는 거래에서 **예상** 기말 수량을 산출하고, WMS 재고 스냅샷의 **실제** 기말 수량과 비교합니다.

### 컬럼

| 컬럼 | 설명 |
|---|---|
| `item_id` | 품목 식별자 |
| `warehouse_id` | 창고 식별자 |
| `period_key` | YYYY-MM 기간 |
| `opening_qty` | 기간 시작 시 스냅샷 보유 수량 |
| `receipt_qty` | 기간 중 입고 수량 합계 |
| `shipment_qty` | 기간 중 출고 수량 합계 |
| `return_in_qty` | 창고로 돌아온 반품 |
| `return_out_qty` | 출고된 반품 (예: 공급업체 반송) |
| `adjustment_qty` | `ops_adjustment_log`의 수동 조정 |
| `expected_closing_qty` | 기초 + 입고 - 출고 - 반품출고 + 반품입고 + 조정 |
| `actual_closing_qty` | 기간 말 스냅샷 보유 수량 |
| `delta_qty` | 실제 - 예상 |
| `delta_pct` | abs(delta_qty) / actual_closing_qty * 100 |
| `status` | OK / WARN / FAIL |

### 임계값

| delta_pct 범위 | 상태 | 조치 |
|---|---|---|
| < 1% | `OK` | 조치 불필요 |
| 1% ~ < 3% | `WARN` | 시차 차이 검토 (운송 중, 입고 보류) |
| >= 3% | `FAIL` | 즉시 조사; 미기록 조정 또는 데이터 손실 가능성 |

---

## 2. OMS vs WMS 대사

**마트**: `mart.reco_oms_vs_wms`

### 비교 대상

OMS의 주문 수량과 WMS의 출고 수량 비교. 미이행 주문, 초과 출고, 유령 출고를 감지합니다.

### 컬럼

| 컬럼 | 설명 |
|---|---|
| `order_id` | 주문 식별자 |
| `order_line_id` | 주문 라인 식별자 |
| `item_id` | 품목 식별자 |
| `channel_store_id` | 판매 채널 |
| `oms_ordered_qty` | OMS 기준 주문 수량 |
| `wms_shipped_qty` | WMS 기준 출고 수량 (출고 없으면 0) |
| `delta_qty` | wms_shipped_qty - oms_ordered_qty |
| `fulfillment_rate` | wms_shipped_qty / oms_ordered_qty |
| `oms_status` | OMS 내 주문 상태 |
| `has_shipment` | 불리언: WMS에 출고 기록 존재 여부 |
| `status` | FULFILLED / PARTIAL / UNFULFILLED / OVER_SHIPPED |

### 임계값

| 조건 | 상태 | 조치 |
|---|---|---|
| fulfillment_rate = 1.0 | `FULFILLED` | 매칭 완료 |
| 0 < fulfillment_rate < 1.0 | `PARTIAL` | 미출고분 또는 분할 출고 확인 |
| fulfillment_rate = 0 이고 oms_status = SHIPPED | `UNFULFILLED` | WMS 데이터 누락 -- 조사 필요 |
| fulfillment_rate > 1.0 | `OVER_SHIPPED` | 중복 출고 또는 데이터 오류 가능성 |

### 허용 범위

- 실행일 기준 3영업일 이내 주문은 제외 (처리 지연 허용).
- 취소된 주문 (`oms_status = CANCELLED`)은 제외.

---

## 3. ERP 입고 전기 vs WMS 입고

**마트**: `mart.reco_erp_gr_vs_wms_receipt`

### 비교 대상

동일 발주에 대한 ERP 입고 전기와 WMS 입고 확인을 비교. 전기 누락, 수량 불일치, 시차 차이를 포착합니다.

### 컬럼

| 컬럼 | 설명 |
|---|---|
| `po_id` | 구매 발주 식별자 |
| `po_line_id` | 발주 라인 식별자 |
| `item_id` | 품목 식별자 |
| `warehouse_id` | 입고 창고 |
| `erp_received_qty` | ERP에 전기된 입고 수량 |
| `wms_received_qty` | WMS에서 확인된 입고 수량 |
| `delta_qty` | erp_received_qty - wms_received_qty |
| `erp_receipt_date` | ERP 전기 일자 |
| `wms_receipt_date` | WMS 확인 일자 |
| `date_delta_days` | abs(erp_receipt_date - wms_receipt_date) |
| `status` | MATCHED / QTY_MISMATCH / ERP_ONLY / WMS_ONLY |

### 임계값

| 조건 | 상태 | 조치 |
|---|---|---|
| delta_qty = 0 이고 date_delta_days <= 2 | `MATCHED` | 조치 불필요 |
| delta_qty != 0 | `QTY_MISMATCH` | 조사; 일반적 원인은 부분 입고 또는 단위 환산 |
| ERP 행 있고 WMS 행 없음 | `ERP_ONLY` | WMS 입고 미처리 또는 데이터 피드 지연 |
| WMS 행 있고 ERP 행 없음 | `WMS_ONLY` | ERP 전기 대기 중; 5영업일 초과 시 플래그 |

### 허용 범위

- 단위 환산 반올림으로 +/- 1개 수량 차이 허용.
- 시스템 간 전기 지연으로 최대 2영업일 일자 차이 허용.

---

## 4. 정산 vs 추정 비용

**마트**: `mart.reco_settlement_vs_estimated`

### 비교 대상

3PL/운송사 정산에서 실제 인보이스 금액과 계약 단가 및 거래량으로 산출한 추정 금액을 비교합니다.

```
estimated_amount = SUM(basis_qty * contracted_rate)   -- dim_charge_policy에서
invoiced_amount  = SUM(invoiced_amount)               -- fact_settlement에서
```

### 컬럼

| 컬럼 | 설명 |
|---|---|
| `charge_type` | 비용 유형 코드 |
| `partner_id` | 서비스 제공자 |
| `period_key` | YYYY-MM 기간 |
| `estimated_amount` | 단가 x 물량 산출 |
| `invoiced_amount` | 실제 정산 금액 |
| `variance_amount` | invoiced - estimated |
| `variance_pct` | abs(variance_amount) / estimated_amount * 100 |
| `status` | OK / WARN / INVESTIGATE |

### 임계값

| variance_pct 범위 | 상태 | 조치 |
|---|---|---|
| < 2% | `OK` | 예상 허용 범위 내 (반올림, 소량 조정) |
| 2% ~ < 5% | `WARN` | 검토; 단가 변경 또는 물량 분쟁 가능성 |
| >= 5% | `INVESTIGATE` | 심각한 차이; 재무팀과 3PL 파트너에게 에스컬레이션 |

---

## 5. 인보이스 vs 배분 비용

**마트**: `mart.reco_charges_invoice_vs_allocated`

### 비교 대상

비용 유형별 총 인보이스 금액과 `fact_charge_actual`의 배분된 비용 합계를 비교합니다. 이것은 배분 엔진의 보존 검사입니다.

```
invoice_total  = SUM(fact_settlement.invoiced_amount) per 비용유형, 기간
allocated_total = SUM(fact_charge_actual.allocated_amount) per 비용유형, 기간
```

### 컬럼

| 컬럼 | 설명 |
|---|---|
| `charge_type` | 비용 유형 코드 |
| `period_key` | YYYY-MM 기간 |
| `invoice_total` | 정산 인보이스 합계 |
| `allocated_total` | 배분된 비용 합계 |
| `delta` | invoice_total - allocated_total |
| `status` | BALANCED / UNBALANCED |

### 임계값

| 조건 | 상태 | 조치 |
|---|---|---|
| delta = 0 | `BALANCED` | 배분이 보존적; 조치 불필요 |
| delta != 0 | `UNBALANCED` | **CRITICAL** -- 배분 버그. 배분 과정에서 파이프라인이 이를 잡았어야 함. `ops.ops_issue_log`에서 배분 오류 조사. |

### 왜 제로 허용 범위인가?

헤어-니마이어 배분 알고리즘은 보존을 보장합니다 ([비용배분_규칙.md](./비용배분_규칙.md) 참조). 0이 아닌 차이는 배분 엔진의 버그 또는 동시 쓰기 시 데이터 경합 조건을 나타냅니다. 이는 항상 심각(CRITICAL)으로 처리됩니다.

---

## 대사 대시보드

Streamlit 대시보드는 대사 결과를 요약 뷰로 표시합니다:

| 섹션 | 시각화 | 핵심 지표 |
|---|---|---|
| 재고 이동 | 창고 x 품목 히트맵 | FAIL 상태 품목 비율 |
| OMS vs WMS | 이행률 막대 차트 | UNFULFILLED 주문 수 |
| ERP vs WMS 입고 | 불일치 테이블 | QTY_MISMATCH 행 수 |
| 정산 vs 추정 | 기간별 차이 추세선 | 평균 variance_pct |
| 인보이스 vs 배분 | 단일 상태 배지 | BALANCED / UNBALANCED |
