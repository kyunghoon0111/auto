# ìŠ¤í‚¤ë§ˆ & ì§€í‘œ ì»¤ìŠ¤í„°ë§ˆì´ì§• ì¢…í•© ê°€ì´ë“œ

> SCM ìš´ì˜ ë¶„ì„ ì‹œìŠ¤í…œì˜ **ëª¨ë“  ìŠ¤í‚¤ë§ˆ, ì§€í‘œ, ëŒ€ì‹œë³´ë“œë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•**í•˜ëŠ” ì™„ì „í•œ ì°¸ì¡° ë¬¸ì„œ.
> ëŒ€ìƒ ë…ì: ë°ì´í„° ì—”ì§€ë‹ˆì–´, ë¶„ì„ ì—”ì§€ë‹ˆì–´, ì‹œìŠ¤í…œ ê´€ë¦¬ì

---

## ëª©ì°¨

1. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”](#1-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜-ê°œìš”)
2. [ì„¤ì • íŒŒì¼ ì „ì²´ êµ¬ì¡°](#2-ì„¤ì •-íŒŒì¼-ì „ì²´-êµ¬ì¡°)
3. [ìŠ¤í‚¤ë§ˆ ì»¤ìŠ¤í„°ë§ˆì´ì§•](#3-ìŠ¤í‚¤ë§ˆ-ì»¤ìŠ¤í„°ë§ˆì´ì§•)
   - 3.1 CORE íŒ©íŠ¸ í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€
   - 3.2 CORE ì°¨ì› í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€
   - 3.3 ìƒˆ CORE íŒ©íŠ¸ í…Œì´ë¸” ì¶”ê°€
   - 3.4 ìƒˆ ì°¨ì› í…Œì´ë¸” ì¶”ê°€
   - 3.5 MART í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€
   - 3.6 ìƒˆ MART í…Œì´ë¸” ì¶”ê°€
   - 3.7 ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤ ë³€ê²½
   - 3.8 ë°ì´í„° íƒ€ì… ì°¸ì¡°
4. [ì§€í‘œ(KPI) ì»¤ìŠ¤í„°ë§ˆì´ì§•](#4-ì§€í‘œkpi-ì»¤ìŠ¤í„°ë§ˆì´ì§•)
   - 4.1 ê¸°ì¡´ ì§€í‘œ ì‚°ì‹ ìˆ˜ì •
   - 4.2 ìƒˆ SCM ì§€í‘œ ì¶”ê°€
   - 4.3 ìƒˆ P&L ì§€í‘œ ì¶”ê°€
   - 4.4 ìƒˆ ëŒ€ì‚¬/ê²€ì¦ ì§€í‘œ ì¶”ê°€
   - 4.5 ìƒˆ ì œì•½/ë³‘ëª© ì‹ í˜¸ ì¶”ê°€
   - 4.6 ì„ê³„ê°’ ì¡°ì •
   - 4.7 ì»¤ë²„ë¦¬ì§€ ë„ë©”ì¸ ì¶”ê°€
5. [ë¹„ìš© ìœ í˜• & ë°°ë¶„ ì»¤ìŠ¤í„°ë§ˆì´ì§•](#5-ë¹„ìš©-ìœ í˜•--ë°°ë¶„-ì»¤ìŠ¤í„°ë§ˆì´ì§•)
   - 5.1 ìƒˆ ë¹„ìš© ìœ í˜• ì¶”ê°€
   - 5.2 ë°°ë¶„ ê¸°ì¤€ ìš°ì„ ìˆœìœ„ ë³€ê²½
   - 5.3 ë¹„ìš© ë„ë©”ì¸/ë‹¨ê³„ ì¶”ê°€
6. [ëŒ€ì‹œë³´ë“œ ì»¤ìŠ¤í„°ë§ˆì´ì§•](#6-ëŒ€ì‹œë³´ë“œ-ì»¤ìŠ¤í„°ë§ˆì´ì§•)
   - 6.1 P&L ëŒ€ì‹œë³´ë“œ íƒ­ ì¶”ê°€
   - 6.2 SCM ëŒ€ì‹œë³´ë“œ íƒ­ ì¶”ê°€
   - 6.3 ê¸°ì¡´ íƒ­ì— ì°¨íŠ¸/KPI ì¶”ê°€
   - 6.4 í•œê¸€ ë¼ë²¨ ì»¤ìŠ¤í„°ë§ˆì´ì§•
   - 6.5 í•„í„° ìœ„ì ¯ ì¶”ê°€
7. [ì»¬ëŸ¼ ë³„ì¹­ & ì†ŒìŠ¤ ë§¤í•‘](#7-ì»¬ëŸ¼-ë³„ì¹­--ì†ŒìŠ¤-ë§¤í•‘)
8. [ì»¤ë²„ë¦¬ì§€ & ì•ˆì „ ê·œì¹™](#8-ì»¤ë²„ë¦¬ì§€--ì•ˆì „-ê·œì¹™)
9. [íŒŒì´í”„ë¼ì¸ í™•ì¥](#9-íŒŒì´í”„ë¼ì¸-í™•ì¥)
10. [ì²´í¬ë¦¬ìŠ¤íŠ¸ & ë¬¸ì œ í•´ê²°](#10-ì²´í¬ë¦¬ìŠ¤íŠ¸--ë¬¸ì œ-í•´ê²°)

---

## 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”

```
inbox/ (CSV/XLSX)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: ìˆ˜ì§‘ (ingest.py)        â”‚  â† config/schema.yaml
â”‚ í…Œì´ë¸” ìë™ ê°ì§€ â†’ DQ ê²€ì‚¬ â†’     â”‚  â† config/column_aliases.yaml
â”‚ CORE í…Œì´ë¸”ì— Upsert             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: SCM ë§ˆíŠ¸ (mart_scm.py)  â”‚  â† config/thresholds.yaml
â”‚ 11ê°œ ë§ˆíŠ¸ ë¹Œë” ì‹¤í–‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: ë¹„ìš© ë°°ë¶„ (allocation.py)â”‚  â† config/policies/charge_policy.yaml
â”‚ Hare-Niemeyer ë°°ë¶„               â”‚  â† config/policies/allocation.yaml
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 4: P&L ë§ˆíŠ¸ (mart_pnl.py)  â”‚  coverage_flag ì „íŒŒ
â”‚ 7ê°œ P&L ì›Œí„°í´ ë¹Œë”              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 5: ëŒ€ì‚¬ (mart_reco.py)     â”‚  5ê°œ ëŒ€ì‚¬ ë§ˆíŠ¸
â”‚ Phase 6: ì œì•½ (mart_constraint.py)â”‚  4ê°œ ì œì•½ ë§ˆíŠ¸
â”‚ Phase 7: ì»¤ë²„ë¦¬ì§€ (coverage.py)   â”‚  â† config/policies/coverage_policy.yaml
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ëŒ€ì‹œë³´ë“œ (Streamlit)              â”‚
â”‚ â€¢ SCM: app/scm_app.py (8501)     â”‚
â”‚ â€¢ P&L: app/pnl_app.py (8502)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í•µì‹¬ ì›ì¹™

| ì›ì¹™ | ì„¤ëª… |
|---|---|
| **YAML ìš°ì„ ** | ê°€ëŠ¥í•œ í•œ YAML ì„¤ì • í¸ì§‘ë§Œìœ¼ë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§•. ì½”ë“œ ë³€ê²½ì€ ìƒˆ ë§ˆíŠ¸/ëŒ€ì‹œë³´ë“œ íƒ­ ì¶”ê°€ ì‹œì—ë§Œ í•„ìš”. |
| **DDL ë‹¨ì¼ ì†ŒìŠ¤** | ëª¨ë“  í…Œì´ë¸” ì •ì˜ëŠ” `src/db.py`ì—ë§Œ ì¡´ì¬. ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ DDL ì‘ì„± ê¸ˆì§€. |
| **ë©±ë“±ì„±** | `python run.py --init`ì€ ëª‡ ë²ˆ ì‹¤í–‰í•´ë„ ì•ˆì „. `CREATE TABLE IF NOT EXISTS` ì‚¬ìš©. |
| **coverage_flag** | P&L ë§ˆíŠ¸ëŠ” í–‰ ìˆ˜ì¤€ ë°ì´í„° í’ˆì§ˆ ì¶”ì . ìƒìœ„ì—ì„œ í•˜ìœ„ë¡œ PARTIAL ì „íŒŒ. |
| **0 ì±„ìš°ê¸° ê¸ˆì§€** | ëˆ„ë½ ë°ì´í„°ëŠ” NULLë¡œ ìœ ì§€. ë¬µì‹œì  0 ê°€ì • ê¸ˆì§€. |

---

## 2. ì„¤ì • íŒŒì¼ ì „ì²´ êµ¬ì¡°

```
config/
â”œâ”€â”€ schema.yaml              â† í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜ (ì»¬ëŸ¼, íƒ€ì…, ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤)
â”œâ”€â”€ column_aliases.yaml      â† ì†ŒìŠ¤ ì»¬ëŸ¼ëª… â†’ ì •ê·œ ì»¬ëŸ¼ëª… ë§¤í•‘
â”œâ”€â”€ thresholds.yaml          â† ì§€í‘œ ì„ê³„ê°’ (ê³¼ì¬ê³  DOH, í’ˆì ˆ ì»¤ë²„ì¼ìˆ˜ ë“±)
â””â”€â”€ policies/
    â”œâ”€â”€ charge_policy.yaml   â† ë¹„ìš© ìœ í˜• ì •ì˜ (ë„ë©”ì¸, ë‹¨ê³„, ë°°ë¶„ ê¸°ì¤€)
    â”œâ”€â”€ allocation.yaml      â† ë°°ë¶„ ì—”ì§„ ì„¤ì • (ë°˜ì˜¬ë¦¼, ê¸°ì¤€ ìš°ì„ ìˆœìœ„)
    â”œâ”€â”€ coverage_policy.yaml â† ì»¤ë²„ë¦¬ì§€ ë„ë©”ì¸ ì •ì˜ (REQUIRED/OPTIONAL)
    â””â”€â”€ tax_policy.yaml      â† êµ­ê°€ë³„ ì„¸ê¸ˆ ê·œì¹™
```

### ì„¤ì • ë³€ê²½ ì‹œ ì ìš© ë°©ë²•

| ë³€ê²½ ë‚´ìš© | ì ìš© ëª…ë ¹ | ì¬ì‹œì‘ í•„ìš” |
|---|---|---|
| YAML ì„¤ì • íŒŒì¼ ìˆ˜ì • | `python run.py --once` | ëŒ€ì‹œë³´ë“œ ìë™ ë°˜ì˜ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨) |
| `src/db.py` DDL ìˆ˜ì • | `python run.py --init && python run.py --once` | ëŒ€ì‹œë³´ë“œ ìë™ ë°˜ì˜ |
| ë§ˆíŠ¸ ë¹Œë” ì½”ë“œ ìˆ˜ì • | `python run.py --once` | ëŒ€ì‹œë³´ë“œ ìë™ ë°˜ì˜ |
| ëŒ€ì‹œë³´ë“œ ì½”ë“œ ìˆ˜ì • | ì—†ìŒ (Streamlit ìë™ ê°ì§€) | ë¶ˆí•„ìš” |

---

## 3. ìŠ¤í‚¤ë§ˆ ì»¤ìŠ¤í„°ë§ˆì´ì§•

### 3.1 CORE íŒ©íŠ¸ í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: `fact_order`ì— `promised_ship_date DATE` ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

#### ë‹¨ê³„ 1: `src/db.py` ìˆ˜ì •

```python
# src/db.py â†’ CORE_FACT_TABLES â†’ "core.fact_order"
"core.fact_order": """
    CREATE TABLE IF NOT EXISTS core.fact_order (
        channel_order_id VARCHAR NOT NULL,
        line_no BIGINT NOT NULL,
        order_date DATE NOT NULL,
        channel_store_id VARCHAR NOT NULL,
        item_id VARCHAR NOT NULL,
        qty_ordered DOUBLE NOT NULL,
        partner_id VARCHAR,
        ship_from_warehouse_id VARCHAR,
        currency VARCHAR,
        promised_ship_date DATE,              -- â˜… ì¶”ê°€
        source_system VARCHAR NOT NULL,
        load_batch_id BIGINT NOT NULL,
        source_file_hash VARCHAR NOT NULL,
        source_pk VARCHAR,
        loaded_at TIMESTAMP DEFAULT current_timestamp,
        PRIMARY KEY (channel_order_id, line_no)
    )
""",
```

#### ë‹¨ê³„ 2: `config/schema.yaml` ìˆ˜ì •

```yaml
fact_order:
  description: "OMS demand truth (order lines)"
  business_key: ["channel_order_id","line_no"]
  event_date_column: "order_date"
  required_columns:
    # ... ê¸°ì¡´ í•„ìˆ˜ ì»¬ëŸ¼ ...
  optional_columns:
    - {name: "partner_id", type: "VARCHAR"}
    - {name: "ship_from_warehouse_id", type: "VARCHAR"}
    - {name: "currency", type: "VARCHAR"}
    - {name: "promised_ship_date", type: "DATE"}    # â˜… ì¶”ê°€
    - {name: "source_pk", type: "VARCHAR"}
```

> âš ï¸ **ê¸°ì¡´ í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€ ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜**: `init_db()`ëŠ” `CREATE TABLE IF NOT EXISTS`ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ
> ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ì¡´ DBì— ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ë ¤ë©´ ì•„ë˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ì½”ë“œë¥¼ `init_db()` í•¨ìˆ˜ì— ì¶”ê°€í•˜ì„¸ìš”:

```python
# src/db.py â†’ init_db() í•¨ìˆ˜ ëì— ì¶”ê°€
# ë§ˆì´ê·¸ë ˆì´ì…˜: fact_orderì— promised_ship_date ì¶”ê°€
_MIGRATION_COLUMNS = [
    ("core", "fact_order", "promised_ship_date", "DATE"),
]
for schema_name, tbl_name, col_name, col_type in _MIGRATION_COLUMNS:
    exists = con.execute(
        "SELECT COUNT(*) FROM information_schema.columns "
        "WHERE table_schema = ? AND table_name = ? AND column_name = ?",
        [schema_name, tbl_name, col_name],
    ).fetchone()[0]
    if not exists:
        con.execute(f"ALTER TABLE {schema_name}.{tbl_name} ADD COLUMN {col_name} {col_type}")
```

#### ë‹¨ê³„ 3: ë³„ì¹­ ì¶”ê°€ (ì„ íƒ)

```yaml
# config/column_aliases.yaml
aliases:
  fact_order:
    promised_ship_date:
      - "promised_ship_date"
      - "expected_ship_date"    # ì†ŒìŠ¤ ì‹œìŠ¤í…œì˜ ë‹¤ë¥¸ ì´ë¦„
      - "ì•½ì†ì¶œê³ ì¼"             # í•œê¸€ ì»¬ëŸ¼ëª…
```

#### ë‹¨ê³„ 4: ì ìš©

```bash
python run.py --init    # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
python run.py --once    # ìƒˆ ë°ì´í„° ìˆ˜ì§‘ ì‹œ ìƒˆ ì»¬ëŸ¼ ì¸ì‹
```

---

### 3.2 CORE ì°¨ì› í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: `dim_item`ì— `brand VARCHAR` ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

#### ë‹¨ê³„ 1: `src/db.py` ìˆ˜ì •

```python
# CORE_DIM_TABLES â†’ "core.dim_item" DDLì— ì¶”ê°€
"core.dim_item": """
    CREATE TABLE IF NOT EXISTS core.dim_item (
        item_id VARCHAR PRIMARY KEY,
        item_type VARCHAR,
        uom_id VARCHAR,
        pack_size DOUBLE,
        weight DOUBLE,
        volume_cbm DOUBLE,
        category VARCHAR,
        brand VARCHAR,                        -- â˜… ì¶”ê°€
        active_flag BOOLEAN DEFAULT true,
        ...
    )
""",
```

#### ë‹¨ê³„ 2: `config/schema.yaml`ì— `dim_item` ì¶”ê°€

í˜„ì¬ schema.yamlì—ëŠ” dim í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€ ì‹œ:

```yaml
tables:
  # ... ê¸°ì¡´ fact í…Œì´ë¸”ë“¤ ...

  dim_item:
    description: "ìƒí’ˆ ë§ˆìŠ¤í„° (ì°¨ì›)"
    business_key: ["item_id"]
    event_date_column: null
    required_columns:
      - {name: "item_id", type: "VARCHAR"}
    optional_columns:
      - {name: "item_type", type: "VARCHAR"}
      - {name: "brand", type: "VARCHAR"}       # â˜… ì¶”ê°€
      - {name: "category", type: "VARCHAR"}
      - {name: "weight", type: "DOUBLE"}
      - {name: "volume_cbm", type: "DOUBLE"}
```

#### ë‹¨ê³„ 3: ë§ˆì´ê·¸ë ˆì´ì…˜ + ì ìš©

```bash
# ê¸°ì¡´ DBì— ì»¬ëŸ¼ ì¶”ê°€ ë§ˆì´ê·¸ë ˆì´ì…˜ (3.1ê³¼ ë™ì¼ íŒ¨í„´)
python run.py --init && python run.py --once
```

---

### 3.3 ìƒˆ CORE íŒ©íŠ¸ í…Œì´ë¸” ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: í”„ë¡œëª¨ì…˜ ë°ì´í„°ë¥¼ ìœ„í•œ `fact_promotion` í…Œì´ë¸”ì„ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

#### ë‹¨ê³„ 1: `src/db.py`ì— DDL ì¶”ê°€

```python
# src/db.py â†’ CORE_FACT_TABLES ë”•ì…”ë„ˆë¦¬ì— ì¶”ê°€
CORE_FACT_TABLES = {
    # ... ê¸°ì¡´ íŒ©íŠ¸ í…Œì´ë¸”ë“¤ ...

    "core.fact_promotion": """
        CREATE TABLE IF NOT EXISTS core.fact_promotion (
            promotion_id VARCHAR NOT NULL,
            item_id VARCHAR NOT NULL,
            channel_store_id VARCHAR,
            start_date DATE NOT NULL,
            end_date DATE NOT NULL,
            discount_type VARCHAR,
            discount_value DOUBLE,
            min_qty INTEGER,
            source_system VARCHAR NOT NULL,
            load_batch_id BIGINT NOT NULL,
            source_file_hash VARCHAR NOT NULL,
            source_pk VARCHAR,
            loaded_at TIMESTAMP DEFAULT current_timestamp,
            PRIMARY KEY (promotion_id, item_id)
        )
    """,
}
```

#### ë‹¨ê³„ 2: `config/schema.yaml`ì— ìŠ¤í‚¤ë§ˆ ì¶”ê°€

```yaml
tables:
  # ... ê¸°ì¡´ í…Œì´ë¸”ë“¤ ...

  fact_promotion:
    description: "í”„ë¡œëª¨ì…˜/í• ì¸ ìº í˜ì¸ ë°ì´í„°"
    business_key: ["promotion_id", "item_id"]
    event_date_column: "start_date"
    required_columns:
      - {name: "source_system", type: "VARCHAR"}
      - {name: "promotion_id", type: "VARCHAR"}
      - {name: "item_id", type: "VARCHAR"}
      - {name: "start_date", type: "DATE"}
      - {name: "end_date", type: "DATE"}
    optional_columns:
      - {name: "channel_store_id", type: "VARCHAR"}
      - {name: "discount_type", type: "VARCHAR"}
      - {name: "discount_value", type: "DOUBLE"}
      - {name: "min_qty", type: "INTEGER"}
      - {name: "source_pk", type: "VARCHAR"}
```

#### ë‹¨ê³„ 3: ë³„ì¹­ ì¶”ê°€ (ì„ íƒ)

```yaml
# config/column_aliases.yaml
aliases:
  fact_promotion:
    promotion_id:
      - "promotion_id"
      - "promo_id"
      - "campaign_id"
    discount_value:
      - "discount_value"
      - "í• ì¸ê°’"
      - "discount_amount"
```

#### ë‹¨ê³„ 4: ì»¤ë²„ë¦¬ì§€ ì •ì±… ì¶”ê°€ (ì„ íƒ)

```yaml
# config/policies/coverage_policy.yaml
domains:
  # ... ê¸°ì¡´ ë„ë©”ì¸ë“¤ ...
  promotions:
    close_period_enforcement: false
    tables:
      - table: fact_promotion
        requirement: OPTIONAL
        description: "í”„ë¡œëª¨ì…˜ ìº í˜ì¸ ë°ì´í„°"
```

#### ë‹¨ê³„ 5: ì ìš©

```bash
python run.py --init    # ìƒˆ í…Œì´ë¸” ìƒì„±
python run.py --once    # inbox/ì— í”„ë¡œëª¨ì…˜ íŒŒì¼ì´ ìˆìœ¼ë©´ ìë™ ìˆ˜ì§‘
```

> ğŸ“ **ìë™ ìˆ˜ì§‘**: `ingest.py`ì˜ `detect_table_type()`ì´ íŒŒì¼ ì»¬ëŸ¼ì„ `schema.yaml` ì •ì˜ì™€ ë§¤ì¹­í•˜ì—¬
> ê°€ì¥ ì ìˆ˜ê°€ ë†’ì€ í…Œì´ë¸”ë¡œ ìë™ ê°ì§€í•©ë‹ˆë‹¤. íŒŒì¼ëª…ì— í…Œì´ë¸”ëª…ì„ í¬í•¨í•˜ë©´ ë” ì •í™•í•©ë‹ˆë‹¤.

---

### 3.4 ìƒˆ ì°¨ì› í…Œì´ë¸” ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: ìš´ì†¡ì‚¬ ì •ë³´ë¥¼ ìœ„í•œ `dim_carrier` í…Œì´ë¸”ì„ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

```python
# src/db.py â†’ CORE_DIM_TABLESì— ì¶”ê°€
CORE_DIM_TABLES = {
    # ... ê¸°ì¡´ ì°¨ì› í…Œì´ë¸”ë“¤ ...

    "core.dim_carrier": """
        CREATE TABLE IF NOT EXISTS core.dim_carrier (
            carrier_id VARCHAR PRIMARY KEY,
            carrier_name VARCHAR,
            carrier_type VARCHAR,
            country VARCHAR,
            contract_start DATE,
            contract_end DATE,
            sla_days INTEGER,
            is_active BOOLEAN DEFAULT true,
            loaded_at TIMESTAMP DEFAULT current_timestamp
        )
    """,
}
```

> ğŸ’¡ **ì°¨ì› í…Œì´ë¸” ê·œì¹™**:
> - PKëŠ” ë‹¨ì¼ `VARCHAR` ìì—°í‚¤ ê¶Œì¥ (`carrier_id`, `partner_id` ë“±)
> - `loaded_at TIMESTAMP DEFAULT current_timestamp` ë°˜ë“œì‹œ í¬í•¨
> - `is_active BOOLEAN` ê¶Œì¥ (Soft delete íŒ¨í„´)

---

### 3.5 MART í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: `mart_shipment_performance`ì— `avg_weight_per_shipment` ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

#### ë‹¨ê³„ 1: `src/db.py` ìˆ˜ì •

```python
# MART_TABLES â†’ "mart.mart_shipment_performance" DDLì— ì¶”ê°€
"mart.mart_shipment_performance": """
    CREATE TABLE IF NOT EXISTS mart.mart_shipment_performance (
        period VARCHAR,
        warehouse_id VARCHAR,
        channel_store_id VARCHAR,
        total_shipments BIGINT,
        total_qty_shipped DOUBLE,
        total_weight DOUBLE,
        total_volume_cbm DOUBLE,
        avg_qty_per_shipment DOUBLE,
        avg_weight_per_shipment DOUBLE,       -- â˜… ì¶”ê°€
        avg_lead_days DOUBLE,
        on_time_count BIGINT,
        on_time_pct DOUBLE
    )
""",
```

#### ë‹¨ê³„ 2: ë§ˆíŠ¸ ë¹Œë” ìˆ˜ì •

```python
# src/mart_scm.py â†’ build_mart_shipment_performance() í•¨ìˆ˜
# SELECT ë¬¸ì— ì»¬ëŸ¼ ì¶”ê°€
sql = """
    SELECT
        period,
        warehouse_id,
        channel_store_id,
        COUNT(*) as total_shipments,
        SUM(qty_shipped) as total_qty_shipped,
        SUM(weight) as total_weight,
        SUM(volume_cbm) as total_volume_cbm,
        AVG(qty_shipped) as avg_qty_per_shipment,
        AVG(weight) as avg_weight_per_shipment,   -- â˜… ì¶”ê°€
        AVG(lead_days) as avg_lead_days,
        ...
"""
```

#### ë‹¨ê³„ 3: ì ìš©

```bash
python run.py --init    # DDL ë³€ê²½ ë°˜ì˜ (ê¸°ì¡´ DBëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)
python run.py --once    # ë§ˆíŠ¸ ì¬êµ¬ì¶•
```

> âš ï¸ **ë§ˆíŠ¸ í…Œì´ë¸” íŒ**: ë§ˆíŠ¸ í…Œì´ë¸”ì€ ë§¤ ì‹¤í–‰ ì‹œ `DELETE + INSERT`ë¡œ ì¬êµ¬ì¶•ë˜ë¯€ë¡œ,
> DDLë§Œ ë³€ê²½í•˜ë©´ ë‹¤ìŒ ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ ìƒˆ ì»¬ëŸ¼ì´ ì±„ì›Œì§‘ë‹ˆë‹¤.
> ë‹¨, ê¸°ì¡´ DBì—ì„œ `init_db()`ê°€ `CREATE TABLE IF NOT EXISTS`ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ
> ì»¬ëŸ¼ ì¶”ê°€ ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì½”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤ (3.1 ì°¸ì¡°).

---

### 3.6 ìƒˆ MART í…Œì´ë¸” ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: ì±„ë„ë³„ íŒë§¤ íŠ¸ë Œë“œ ë¶„ì„ì„ ìœ„í•œ `mart_channel_trend` í…Œì´ë¸”ì„ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

#### ë‹¨ê³„ 1: DDL ì¶”ê°€

```python
# src/db.py â†’ MART_TABLESì— ì¶”ê°€
"mart.mart_channel_trend": """
    CREATE TABLE IF NOT EXISTS mart.mart_channel_trend (
        period VARCHAR,
        channel_store_id VARCHAR,
        channel VARCHAR,
        total_orders BIGINT,
        total_revenue_krw DOUBLE,
        total_items_shipped BIGINT,
        avg_order_value DOUBLE,
        new_customer_pct DOUBLE
    )
""",
```

#### ë‹¨ê³„ 2: ë§ˆíŠ¸ ë¹Œë” ì‘ì„±

```python
# src/mart_scm.py (ë˜ëŠ” ë³„ë„ íŒŒì¼ src/mart_channel.py) ì— ì¶”ê°€

def build_mart_channel_trend(con: duckdb.DuckDBPyConnection, config) -> int:
    """ì±„ë„ë³„ íŒë§¤ íŠ¸ë Œë“œ ë§ˆíŠ¸ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤."""
    sql = """
        SELECT
            strftime(s.ship_date, '%Y-%m') as period,
            s.channel_store_id,
            COALESCE(d.channel, 'UNKNOWN') as channel,
            COUNT(DISTINCT s.channel_order_id) as total_orders,
            SUM(s.qty_shipped) as total_items_shipped,
            -- ë§¤ì¶œì€ P&L ë§¤ì¶œ ë§ˆíŠ¸ì—ì„œ ì¡°ì¸
            r.total_revenue_krw,
            r.total_revenue_krw / NULLIF(COUNT(DISTINCT s.channel_order_id), 0) as avg_order_value,
            NULL as new_customer_pct
        FROM core.fact_shipment s
        LEFT JOIN core.dim_channel_store d ON s.channel_store_id = d.channel_store_id
        LEFT JOIN (
            SELECT period, channel_store_id,
                   SUM(net_revenue_krw) as total_revenue_krw
            FROM mart.mart_pnl_revenue
            GROUP BY period, channel_store_id
        ) r ON r.period = strftime(s.ship_date, '%Y-%m')
           AND r.channel_store_id = s.channel_store_id
        WHERE s.channel_order_id IS NOT NULL  -- íŒë§¤ ì „ìš©
        GROUP BY period, s.channel_store_id, d.channel,
                 r.total_revenue_krw
    """
    df = con.execute(sql).pl()
    con.execute("DELETE FROM mart.mart_channel_trend")
    if len(df) > 0:
        con.execute("INSERT INTO mart.mart_channel_trend SELECT * FROM df")
    return len(df)
```

#### ë‹¨ê³„ 3: íŒŒì´í”„ë¼ì¸ì— ë“±ë¡

```python
# src/mart_scm.py â†’ build_all_scm_marts() í•¨ìˆ˜ì— ì¶”ê°€
def build_all_scm_marts(con, config):
    # ... ê¸°ì¡´ ë¹Œë”ë“¤ ...
    build_mart_channel_trend(con, config)  # â˜… ì¶”ê°€
```

#### ë‹¨ê³„ 4: ì ìš©

```bash
python run.py --init && python run.py --once
```

---

### 3.7 ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤ ë³€ê²½

ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤ëŠ” Upsert(DELETE + INSERT)ì˜ ì¤‘ë³µ íŒë³„ ê¸°ì¤€ì…ë‹ˆë‹¤.

#### ë³€ê²½ ìœ„ì¹˜

| íŒŒì¼ | ìš©ë„ |
|---|---|
| `src/db.py` â†’ `PRIMARY KEY (...)` | DDL ë¬¼ë¦¬ í‚¤ |
| `config/schema.yaml` â†’ `business_key: [...]` | ìˆ˜ì§‘ ì‹œ ì¤‘ë³µ ê²€ì‚¬ í‚¤ |

> âš ï¸ **ì£¼ì˜**: ë‘ ê³³ ëª¨ë‘ ë°˜ë“œì‹œ ë™ì¼í•˜ê²Œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤. ë¶ˆì¼ì¹˜ ì‹œ DQ ê²€ì‚¬ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

#### ì˜ˆì‹œ: `fact_shipment` í‚¤ì— `warehouse_id` ì¶”ê°€

```python
# src/db.py
"core.fact_shipment": """
    ...
    PRIMARY KEY (shipment_id, item_id, lot_id, warehouse_id)  -- â˜… ë³€ê²½
""",
```

```yaml
# config/schema.yaml
fact_shipment:
  business_key: ["shipment_id", "item_id", "lot_id", "warehouse_id"]  # â˜… ë³€ê²½
```

> âš ï¸ **ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤ ë³€ê²½ ì‹œ ê¸°ì¡´ ë°ì´í„°**: í‚¤ë¥¼ ë³€ê²½í•˜ë©´ ê¸°ì¡´ í…Œì´ë¸”ì„ DROPí•˜ê³  ì¬ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
> `data/scm.duckdb`ë¥¼ ë°±ì—…í•œ í›„ ì‚­ì œí•˜ê³  `python run.py --init`ìœ¼ë¡œ ì¬ìƒì„±í•˜ì„¸ìš”.

---

### 3.8 ë°ì´í„° íƒ€ì… ì°¸ì¡°

DuckDBì—ì„œ ì§€ì›í•˜ëŠ” ì£¼ìš” ë°ì´í„° íƒ€ì…:

| DuckDB íƒ€ì… | schema.yaml í‘œê¸° | ì„¤ëª… | ì˜ˆì‹œ |
|---|---|---|---|
| `VARCHAR` | `VARCHAR` | ê°€ë³€ ê¸¸ì´ ë¬¸ìì—´ | ì£¼ë¬¸ë²ˆí˜¸, í’ˆëª©ì½”ë“œ |
| `BIGINT` | `BIGINT` | 64ë¹„íŠ¸ ì •ìˆ˜ | ë¼ì¸ë²ˆí˜¸, ê°œìˆ˜ |
| `INTEGER` | `INTEGER` | 32ë¹„íŠ¸ ì •ìˆ˜ | ìœ í†µê¸°í•œì¼ìˆ˜, ìˆœìœ„ |
| `DOUBLE` | `DOUBLE` | 64ë¹„íŠ¸ ë¶€ë™ì†Œìˆ˜ì  | ìˆ˜ëŸ‰, ê¸ˆì•¡, ë¹„ìœ¨ |
| `DATE` | `DATE` | ë‚ ì§œ (ì‹œê°„ ì—†ìŒ) | ì£¼ë¬¸ì¼, ì¶œê³ ì¼ |
| `TIMESTAMP` | `TIMESTAMP` | ë‚ ì§œ + ì‹œê°„ | ì ì¬ì‹œê° |
| `BOOLEAN` | `BOOLEAN` | ì°¸/ê±°ì§“ | í™œì„±ì—¬ë¶€, ìœ„í—˜í”Œë˜ê·¸ |

---

## 4. ì§€í‘œ(KPI) ì»¤ìŠ¤í„°ë§ˆì´ì§•

### 4.1 ê¸°ì¡´ ì§€í‘œ ì‚°ì‹ ìˆ˜ì •

#### í˜„ì¬ ì •ì˜ëœ ì§€í‘œ ëª©ë¡

| # | ì§€í‘œ | ì†ŒìŠ¤ íŒŒì¼ | í•¨ìˆ˜ | ë§ˆíŠ¸ í…Œì´ë¸” |
|---|---|---|---|---|
| 1 | `sellable_qty` | `mart_scm.py` | `build_mart_inventory_onhand` | `mart_inventory_onhand` |
| 2 | `days_of_cover` | `mart_scm.py` | `build_mart_stockout_risk` | `mart_stockout_risk` |
| 3 | `days_on_hand (DOH)` | `mart_scm.py` | `build_mart_overstock` | `mart_overstock` |
| 4 | `overstock_qty` | `mart_scm.py` | `build_mart_overstock` | `mart_overstock` |
| 5 | `risk_value_krw` | `mart_scm.py` | `build_mart_expiry_risk` | `mart_expiry_risk` |
| 6 | `fefo_rank` | `mart_scm.py` | `build_mart_fefo_pick_list` | `mart_fefo_pick_list` |
| 7 | `service_level_pct` | `mart_scm.py` | `build_mart_service_level` | `mart_service_level` |
| 8 | `on_time_pct` | `mart_scm.py` | `build_mart_shipment_performance` | `mart_shipment_performance` |
| 9 | `return_rate` | `mart_scm.py` | `build_mart_return_analysis` | `mart_return_analysis` |
| 10 | `net_revenue_krw` | `mart_pnl.py` | `build_mart_pnl_revenue` | `mart_pnl_revenue` |
| 11 | `cogs_krw` | `mart_pnl.py` | `build_mart_pnl_cogs` | `mart_pnl_cogs` |
| 12 | `gross_margin_krw` | `mart_pnl.py` | `build_mart_pnl_gross_margin` | `mart_pnl_gross_margin` |
| 13 | `contribution_krw` | `mart_pnl.py` | `build_mart_pnl_contribution` | `mart_pnl_contribution` |
| 14 | `operating_profit_krw` | `mart_pnl.py` | `build_mart_pnl_operating_profit` | `mart_pnl_operating_profit` |

#### ì‚°ì‹ ìˆ˜ì • ë°©ë²•

**ì˜ˆì‹œ**: DOH ê³„ì‚°ì—ì„œ ê¸°ë³¸ ìˆ˜ìš” ê¸°ê°„ì„ 30ì¼ â†’ 60ì¼ë¡œ ë³€ê²½

```python
# src/mart_scm.py â†’ build_mart_overstock() í•¨ìˆ˜
# ë³€ê²½ ì „:
# AVG(daily_shipped_qty, ìµœê·¼ 30ì¼)
# ë³€ê²½ í›„:
sql = """
    ...
    -- ìˆ˜ìš” ê³„ì‚° ê¸°ê°„ì„ 60ì¼ë¡œ ë³€ê²½
    WHERE s.ship_date >= (current_date - INTERVAL 60 DAY)
    ...
"""
```

**ì˜ˆì‹œ**: ì„œë¹„ìŠ¤ ë ˆë²¨ ëª©í‘œ ê¸°ì¤€ì„ "ì•½ì† ì¶œê³ ì¼" â†’ "ì£¼ë¬¸ì¼ + 3ì¼"ë¡œ ë³€ê²½

```python
# src/mart_scm.py â†’ build_mart_service_level() í•¨ìˆ˜
# ë³€ê²½ ì „: actual_ship_date <= promised_ship_date
# ë³€ê²½ í›„:
sql = """
    SUM(CASE WHEN s.ship_date <= o.order_date + INTERVAL 3 DAY
             THEN 1 ELSE 0 END) as shipped_on_time,
"""
```

---

### 4.2 ìƒˆ SCM ì§€í‘œ ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: "ì°½ê³  í™œìš©ë¥ " ì§€í‘œë¥¼ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

#### ë‹¨ê³„ 1: MART DDL ì¶”ê°€

```python
# src/db.py â†’ MART_TABLES
"mart.mart_warehouse_utilization": """
    CREATE TABLE IF NOT EXISTS mart.mart_warehouse_utilization (
        snapshot_date DATE,
        warehouse_id VARCHAR,
        warehouse_type VARCHAR,
        total_capacity_pallets INTEGER,
        used_pallets DOUBLE,
        utilization_pct DOUBLE,
        available_pallets DOUBLE
    )
""",
```

#### ë‹¨ê³„ 2: ë¹Œë” í•¨ìˆ˜ ì‘ì„±

```python
# src/mart_scm.py

def build_mart_warehouse_utilization(con, config) -> int:
    """ì°½ê³  í™œìš©ë¥  ë§ˆíŠ¸ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤."""
    sql = """
        WITH latest_snapshot AS (
            SELECT MAX(snapshot_date) as max_date
            FROM core.fact_inventory_snapshot
        ),
        inv_summary AS (
            SELECT
                i.warehouse_id,
                SUM(i.onhand_qty * COALESCE(d.volume_cbm, 0) / 1.2) as used_pallets
            FROM core.fact_inventory_snapshot i
            JOIN latest_snapshot ls ON i.snapshot_date = ls.max_date
            LEFT JOIN core.dim_item d ON i.item_id = d.item_id
            GROUP BY i.warehouse_id
        )
        SELECT
            ls.max_date as snapshot_date,
            w.warehouse_id,
            w.warehouse_type,
            w.capacity_pallets as total_capacity_pallets,
            COALESCE(inv.used_pallets, 0) as used_pallets,
            CASE WHEN w.capacity_pallets > 0
                 THEN COALESCE(inv.used_pallets, 0) / w.capacity_pallets * 100
                 ELSE NULL END as utilization_pct,
            w.capacity_pallets - COALESCE(inv.used_pallets, 0) as available_pallets
        FROM core.dim_warehouse w
        CROSS JOIN latest_snapshot ls
        LEFT JOIN inv_summary inv ON w.warehouse_id = inv.warehouse_id
    """
    df = con.execute(sql).pl()
    _write_mart(con, df, "mart.mart_warehouse_utilization")
    return len(df)
```

#### ë‹¨ê³„ 3: íŒŒì´í”„ë¼ì¸ì— ë“±ë¡ + ì ìš©

```python
# src/mart_scm.py â†’ build_all_scm_marts()
build_mart_warehouse_utilization(con, config)
```

```bash
python run.py --init && python run.py --once
```

---

### 4.3 ìƒˆ P&L ì§€í‘œ ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: "EBITDA" ì§€í‘œë¥¼ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

#### ì¤‘ìš” ê·œì¹™: P&L ì§€í‘œì˜ coverage_flag

P&L ë§ˆíŠ¸ì— ìƒˆ ì§€í‘œë¥¼ ì¶”ê°€í•  ë•ŒëŠ” ë°˜ë“œì‹œ `coverage_flag` ì»¬ëŸ¼ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:

```python
# coverage_flag ì „íŒŒ ê·œì¹™
# ìƒìœ„ ë§ˆíŠ¸ ì¤‘ í•˜ë‚˜ë¼ë„ ACTUALì´ ì•„ë‹ˆë©´ â†’ PARTIAL

coverage_flag_sql = """
    CASE WHEN COALESCE(upstream1.coverage_flag, 'PARTIAL') = 'ACTUAL'
          AND COALESCE(upstream2.coverage_flag, 'PARTIAL') = 'ACTUAL'
         THEN 'ACTUAL'
         ELSE 'PARTIAL'
    END as coverage_flag
"""
```

#### DDL ì¶”ê°€

```python
# src/db.py â†’ MART_TABLES
"mart.mart_pnl_ebitda": """
    CREATE TABLE IF NOT EXISTS mart.mart_pnl_ebitda (
        period VARCHAR,
        item_id VARCHAR,
        channel_store_id VARCHAR,
        country VARCHAR,
        operating_profit_krw DOUBLE,
        depreciation_krw DOUBLE,
        amortization_krw DOUBLE,
        ebitda_krw DOUBLE,
        ebitda_margin_pct DOUBLE,
        coverage_flag VARCHAR           -- â˜… ë°˜ë“œì‹œ í¬í•¨
    )
""",
```

#### ë¹Œë” ì¶”ê°€

```python
# src/mart_pnl.py

def build_mart_pnl_ebitda(con, config) -> int:
    """EBITDA ë§ˆíŠ¸ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤. í˜„ì¬ ê°ê°€ìƒê°/ìƒê°ì€ 0ìœ¼ë¡œ ì„¤ì •."""
    sql = """
        SELECT
            op.period,
            op.item_id,
            op.channel_store_id,
            op.country,
            op.operating_profit_krw,
            0 as depreciation_krw,       -- ì¶”í›„ ì…ë ¥ ëŒ€ìƒ
            0 as amortization_krw,       -- ì¶”í›„ ì…ë ¥ ëŒ€ìƒ
            COALESCE(op.operating_profit_krw, 0) as ebitda_krw,
            CASE WHEN rev.net_revenue_krw > 0
                 THEN COALESCE(op.operating_profit_krw, 0) / rev.net_revenue_krw * 100
                 ELSE NULL END as ebitda_margin_pct,
            op.coverage_flag             -- â˜… ìƒìœ„ì—ì„œ ìƒì†
        FROM mart.mart_pnl_operating_profit op
        LEFT JOIN mart.mart_pnl_revenue rev
          ON op.period = rev.period
          AND op.item_id = rev.item_id
          AND op.channel_store_id = rev.channel_store_id
    """
    df = con.execute(sql).pl()
    _write_mart(con, df, "mart.mart_pnl_ebitda")
    return len(df)
```

#### P&L ì›Œí„°í´ì— ë“±ë¡

```python
# src/mart_pnl.py â†’ build_mart_pnl_waterfall_summary()
# metric_name ëª©ë¡ì— ì¶”ê°€:
# ('EBITDA', 7, 'SUM(ebitda_krw) FROM mart.mart_pnl_ebitda')
```

---

### 4.4 ìƒˆ ëŒ€ì‚¬/ê²€ì¦ ì§€í‘œ ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: "ì£¼ë¬¸-ë°˜í’ˆ ìˆ˜ëŸ‰ ëŒ€ì‚¬" ì§€í‘œë¥¼ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

```python
# src/mart_reco.py

def build_mart_reco_order_vs_return(con, config) -> int:
    """ì£¼ë¬¸ ìˆ˜ëŸ‰ ëŒ€ë¹„ ë°˜í’ˆ ìˆ˜ëŸ‰ì„ ëŒ€ì‚¬í•©ë‹ˆë‹¤."""
    sql = """
        WITH orders AS (
            SELECT strftime(order_date, '%Y-%m') as period,
                   item_id, channel_store_id,
                   SUM(qty_ordered) as qty_ordered
            FROM core.fact_order
            GROUP BY 1, 2, 3
        ),
        returns AS (
            SELECT strftime(return_date, '%Y-%m') as period,
                   item_id,
                   SUM(qty_returned) as qty_returned
            FROM core.fact_return
            GROUP BY 1, 2
        )
        SELECT
            o.period, o.item_id, o.channel_store_id,
            o.qty_ordered,
            COALESCE(r.qty_returned, 0) as qty_returned,
            COALESCE(r.qty_returned, 0) / NULLIF(o.qty_ordered, 0) as return_rate,
            CASE WHEN r.qty_returned / NULLIF(o.qty_ordered, 0) > 0.1
                 THEN 'HIGH' ELSE 'OK' END as severity
        FROM orders o
        LEFT JOIN returns r ON o.period = r.period AND o.item_id = r.item_id
    """
    df = con.execute(sql).pl()
    _write_mart(con, df, "mart.mart_reco_order_vs_return")
    return len(df)
```

---

### 4.5 ìƒˆ ì œì•½/ë³‘ëª© ì‹ í˜¸ ì¶”ê°€

**ì‹œë‚˜ë¦¬ì˜¤**: "ì¬ê³  ì§‘ì¤‘ë„ ê²½ê³ " ì‹ í˜¸ë¥¼ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

```python
# src/mart_constraint.py â†’ ìƒˆ ì‹ í˜¸ ìƒì„±ê¸° ì¶”ê°€

def compute_concentration_signals(con, config) -> list[dict]:
    """ë‹¨ì¼ ì°½ê³ ì— ì¬ê³ ê°€ ì§‘ì¤‘ëœ ê²½ìš° ê²½ê³ í•©ë‹ˆë‹¤."""
    sql = """
        WITH totals AS (
            SELECT item_id, SUM(onhand_qty) as total_qty
            FROM mart.mart_inventory_onhand
            GROUP BY item_id
        ),
        by_warehouse AS (
            SELECT item_id, warehouse_id, SUM(onhand_qty) as wh_qty
            FROM mart.mart_inventory_onhand
            GROUP BY item_id, warehouse_id
        )
        SELECT b.item_id, b.warehouse_id,
               b.wh_qty / NULLIF(t.total_qty, 0) as concentration_ratio
        FROM by_warehouse b
        JOIN totals t ON b.item_id = t.item_id
        WHERE b.wh_qty / NULLIF(t.total_qty, 0) > 0.9  -- 90% ì´ìƒ ì§‘ì¤‘
          AND t.total_qty > 100                          -- ì†ŒëŸ‰ ì œì™¸
    """
    rows = con.execute(sql).fetchall()
    signals = []
    for item_id, warehouse_id, ratio in rows:
        signals.append({
            "domain": "inventory",
            "metric_name": "concentration_ratio",
            "current_value": ratio,
            "threshold_value": 0.9,
            "severity": "HIGH",
            "entity_type": "item",
            "entity_id": item_id,
        })
    return signals
```

#### ì„ê³„ê°’ì„ YAMLë¡œ ê´€ë¦¬í•˜ë ¤ë©´

```yaml
# config/thresholds.yaml
constraints:
  inventory:
    concentration_ratio_high: 0.9
    concentration_min_qty: 100
```

```python
# ì½”ë“œì—ì„œ ì°¸ì¡°
threshold = config.get_threshold("constraints", "inventory", "concentration_ratio_high")
```

---

### 4.6 ì„ê³„ê°’ ì¡°ì •

#### í˜„ì¬ ì„ê³„ê°’ ì „ì²´ ëª©ë¡

```yaml
# config/thresholds.yaml

inventory:
  doh_overstock:
    RM: 120       # ì›ìì¬ ê³¼ì¬ê³  ê¸°ì¤€ì¼
    PM: 180       # í¬ì¥ì¬ ê³¼ì¬ê³  ê¸°ì¤€ì¼
    WIP: 90       # ì¬ê³µí’ˆ ê³¼ì¬ê³  ê¸°ì¤€ì¼
    FG: 90        # ì™„ì œí’ˆ ê³¼ì¬ê³  ê¸°ì¤€ì¼

  stockout_days_cover:
    default: 7    # ê¸°ë³¸ í’ˆì ˆ ìœ„í—˜ ì»¤ë²„ì¼ìˆ˜
    FG: 10        # ì™„ì œí’ˆ í’ˆì ˆ ìœ„í—˜ ì»¤ë²„ì¼ìˆ˜

expiry:
  buckets_days: [0, 30, 60, 90, 180, 365]      # ìœ í†µê¸°í•œ ë²„í‚· ê²½ê³„ (ì¼)
  min_sellable_days_default:
    RM: 30        # ì›ìì¬ ìµœì†Œ íŒë§¤ê°€ëŠ¥ì¼
    PM: 90        # í¬ì¥ì¬ ìµœì†Œ íŒë§¤ê°€ëŠ¥ì¼
    FG: 60        # ì™„ì œí’ˆ ìµœì†Œ íŒë§¤ê°€ëŠ¥ì¼

reconciliation:
  inventory_adjustment_ratio_warn: 0.01   # 1% ì´ìƒ â†’ WARN
  inventory_adjustment_ratio_high: 0.03   # 3% ì´ìƒ â†’ HIGH

constraints:
  baseline_weeks: 8                       # ê¸°ì¤€ì„  ì‚°ì¶œ ê¸°ê°„ (ì£¼)
  supply:
    late_po_ratio_high: 0.2               # ë°œì£¼ ì§€ì—°ìœ¨ 20% ì´ìƒ â†’ HIGH
    supplier_delay_days_high: 7           # ê³µê¸‰ì—…ì²´ ì§€ì—° 7ì¼ ì´ìƒ â†’ HIGH
  warehouse_3pl:
    backlog_ship_orders_high: 200         # ë°±ë¡œê·¸ 200ê±´ ì´ìƒ â†’ HIGH
    pick_pack_throughput_ratio_low: 0.8   # í”¼í‚¹ ì²˜ë¦¬ìœ¨ 80% ë¯¸ë§Œ â†’ LOW
  logistics_customs:
    dwell_time_days_high: 5               # ì²´ë¥˜ì¼ 5ì¼ ì´ìƒ â†’ HIGH
    carrier_on_time_rate_low: 0.9         # ìš´ì†¡ ì •ì‹œìœ¨ 90% ë¯¸ë§Œ â†’ LOW
  demand_channel:
    return_rate_spike_ratio_high: 1.5     # ë°˜í’ˆìœ¨ ê¸‰ì¦ 1.5ë°° ì´ìƒ â†’ HIGH
    promo_lift_ratio_high: 2.0            # í”„ë¡œëª¨ì…˜ ìˆ˜ìš” ì¦ê°€ 2ë°° ì´ìƒ â†’ HIGH
    forecast_mape_high: 0.4               # ì˜ˆì¸¡ ì˜¤ì°¨ 40% ì´ìƒ â†’ HIGH
```

#### ìƒˆ ì„ê³„ê°’ ì¶”ê°€

```yaml
# config/thresholds.yamlì— ìƒˆ ì„¹ì…˜ ì¶”ê°€

service_level:
  target_pct: 95.0                # ì„œë¹„ìŠ¤ ë ˆë²¨ ëª©í‘œ (%)
  fulfillment_target_pct: 98.0    # ì´í–‰ë¥  ëª©í‘œ (%)

procurement:
  late_po_ratio_target_pct: 10.0  # ë°œì£¼ ì§€ì—°ìœ¨ ëª©í‘œ (%)
  po_lead_time_max_days: 30       # ìµœëŒ€ í—ˆìš© ë¦¬ë“œíƒ€ì„ (ì¼)
```

#### ì½”ë“œì—ì„œ ì„ê³„ê°’ ì°¸ì¡°

```python
# src/config.py â†’ AppConfig í´ë˜ìŠ¤
threshold = config.get_threshold("inventory", "doh_overstock", "FG")
# â†’ 90

# ì¤‘ì²© í‚¤ë¡œ ì ‘ê·¼
target = config.get_threshold("service_level", "target_pct")
# â†’ 95.0
```

---

### 4.7 ì»¤ë²„ë¦¬ì§€ ë„ë©”ì¸ ì¶”ê°€

```yaml
# config/policies/coverage_policy.yaml

domains:
  # ... ê¸°ì¡´ ë„ë©”ì¸ë“¤ ...

  # ìƒˆ ë„ë©”ì¸ ì¶”ê°€ ì˜ˆì‹œ
  marketing:
    close_period_enforcement: false    # ë§ˆê° ì‹œì—ë„ OPTIONAL ìœ ì§€
    tables:
      - table: fact_promotion
        requirement: OPTIONAL
        description: "í”„ë¡œëª¨ì…˜ ìº í˜ì¸ ë°ì´í„°"

  carrier_performance:
    close_period_enforcement: true     # ë§ˆê° ì‹œ REQUIREDë¡œ ìŠ¹ê²©
    tables:
      - table: dim_carrier
        requirement: OPTIONAL          # ì¼ë°˜ ì‹œ OPTIONAL
        description: "ìš´ì†¡ì‚¬ ë§ˆìŠ¤í„°"
```

---

## 5. ë¹„ìš© ìœ í˜• & ë°°ë¶„ ì»¤ìŠ¤í„°ë§ˆì´ì§•

### 5.1 ìƒˆ ë¹„ìš© ìœ í˜• ì¶”ê°€

#### í˜„ì¬ ë¹„ìš© ìœ í˜• êµ¬ì¡°

```
charge_policy.yaml
â””â”€â”€ charge_types:
    â”œâ”€â”€ LAST_MILE_PARCEL       â†’ logistics_transport / outbound
    â”œâ”€â”€ DOMESTIC_TRUCKING      â†’ logistics_transport / outbound
    â”œâ”€â”€ FREIGHT_INTL_SEA       â†’ logistics_transport / inbound_landed
    â”œâ”€â”€ FREIGHT_INTL_AIR       â†’ logistics_transport / inbound_landed
    â”œâ”€â”€ PORT_TERMINAL_FEE      â†’ logistics_transport / inbound_landed
    â”œâ”€â”€ FORWARDER_FEE          â†’ logistics_transport / inbound_landed
    â”œâ”€â”€ CUSTOMS_DUTY           â†’ customs / inbound_landed
    â”œâ”€â”€ CUSTOMS_VAT            â†’ customs / inbound_landed
    â”œâ”€â”€ BROKER_FEE             â†’ customs / inbound_landed
    â”œâ”€â”€ CARGO_INSURANCE        â†’ logistics_transport / inbound_landed
    â”œâ”€â”€ 3PL_STORAGE_FEE        â†’ 3pl_billing / storage
    â”œâ”€â”€ 3PL_PICK_PACK_FEE      â†’ 3pl_billing / outbound
    â”œâ”€â”€ 3PL_HANDLING_FEE       â†’ 3pl_billing / outbound
    â”œâ”€â”€ 3PL_RETURN_PROCESSING_FEE â†’ 3pl_billing / returns
    â”œâ”€â”€ DISPOSAL_FEE           â†’ 3pl_billing / returns
    â”œâ”€â”€ PLATFORM_FEE           â†’ platform_fee / period
    â”œâ”€â”€ PG_FEE                 â†’ platform_fee / period
    â””â”€â”€ MARKETING_SPEND        â†’ marketing / period
```

#### ìƒˆ ë¹„ìš© ìœ í˜• ì¶”ê°€

```yaml
# config/policies/charge_policy.yaml

charge_types:
  # ... ê¸°ì¡´ ìœ í˜•ë“¤ ...

  # â˜… ìƒˆ ë¹„ìš© ìœ í˜• ì¶”ê°€
  COLD_CHAIN_SURCHARGE:
    charge_domain: logistics_transport
    cost_stage: outbound
    capitalizable_flag: false
    default_allocation_basis: weight
    severity_if_missing: warn

  QUALITY_INSPECTION_FEE:
    charge_domain: 3pl_billing
    cost_stage: inbound_landed
    capitalizable_flag: true
    default_allocation_basis: qty
    severity_if_missing: warn
```

#### í•„ìˆ˜ í•„ë“œ ì„¤ëª…

| í•„ë“œ | íƒ€ì… | í—ˆìš©ê°’ | ì„¤ëª… |
|---|---|---|---|
| `charge_domain` | ë¬¸ìì—´ | `logistics_transport`, `customs`, `3pl_billing`, `platform_fee`, `marketing`, *ë˜ëŠ” ìƒˆ ë„ë©”ì¸* | ë¹„ìš©ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ì—­ |
| `cost_stage` | ë¬¸ìì—´ | `inbound_landed`, `storage`, `outbound`, `returns`, `period` | ë¹„ìš© ë°œìƒ ë‹¨ê³„ |
| `capitalizable_flag` | ë¶ˆë¦¬ì–¸ | `true` / `false` | ìì‚°í™” ê°€ëŠ¥ ì—¬ë¶€ (ì¬ê³ ì›ê°€ì— í¬í•¨) |
| `default_allocation_basis` | ë¬¸ìì—´ | `qty`, `weight`, `volume_cbm`, `value`, `revenue`, `order_count`, `line_count`, `onhand_cbm_days`, `onhand_qty_days` | ê¸°ë³¸ ë°°ë¶„ ê¸°ì¤€ |
| `severity_if_missing` | ë¬¸ìì—´ | `warn` / `critical` | ì¸ë³´ì´ìŠ¤ ëˆ„ë½ ì‹œ ì‹¬ê°ë„ |

#### ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ” í•­ëª©

1. `python run.py --init` ì‹¤í–‰ ì‹œ `core.dim_charge_policy`ì— ìë™ ë“±ë¡
2. DQ ê²€ì‚¬ê°€ ìƒˆ ë¹„ìš© ìœ í˜• ì½”ë“œë¥¼ ìœ íš¨í•œ ê²ƒìœ¼ë¡œ ì¸ì‹
3. ë°°ë¶„ ì—”ì§„ì´ ì§€ì •ëœ `default_allocation_basis` ì‚¬ìš©
4. P&L ë³€ë™ë¹„ ë§ˆíŠ¸ì— ìƒˆ ë¹„ìš© ìœ í˜• í¬í•¨
5. ëŒ€ì‹œë³´ë“œì—ì„œ ë„ë©”ì¸/ë‹¨ê³„ë³„ ì°¨íŠ¸ì— ìë™ ë°˜ì˜
6. í•´ë‹¹ `charge_domain`ì˜ **ì»¤ë²„ë¦¬ì§€ ê²€ì‚¬ì— ìë™ í¬í•¨** â€” `coverage_policy.yaml`ì— ë³„ë„ í•­ëª© ì¶”ê°€ ë¶ˆí•„ìš”

---

### 5.2 ë°°ë¶„ ê¸°ì¤€ ìš°ì„ ìˆœìœ„ ë³€ê²½

```yaml
# config/policies/allocation.yaml

# ë‹¨ê³„ë³„ ê¸°ë³¸ ë°°ë¶„ ê¸°ì¤€ ìš°ì„ ìˆœìœ„
default_basis_by_stage:
  inbound_landed: ["weight", "volume_cbm", "value", "qty"]  # ì²« ë²ˆì§¸ê°€ ìµœìš°ì„ 
  storage: ["onhand_cbm_days", "onhand_qty_days"]
  outbound: ["order_count", "line_count", "weight", "qty"]
  returns: ["line_count", "qty"]
  period: ["revenue", "line_count"]

# íŠ¹ì • ë¹„ìš© ìœ í˜•ì— ëŒ€í•œ ì˜¤ë²„ë¼ì´ë“œ
charge_type_overrides:
  3PL_STORAGE_FEE:
    basis_priority: ["onhand_cbm_days", "onhand_qty_days"]
  LAST_MILE_PARCEL:
    basis_priority: ["order_count", "line_count"]
  # â˜… ìƒˆ ì˜¤ë²„ë¼ì´ë“œ ì¶”ê°€
  COLD_CHAIN_SURCHARGE:
    basis_priority: ["weight", "volume_cbm"]

# ë°˜ì˜¬ë¦¼ ì„¤ì •
rounding:
  mode: "HALF_UP"
  decimals: 0                    # ì†Œìˆ˜ì  ì´í•˜ ìë¦¿ìˆ˜ (KRW â†’ 0)
  remainder_strategy: "largest_fraction"  # Hare-Niemeyer ë³´ì •

# ê²°ì •ë¡ ì  ì •ë ¬ í‚¤ (ë™ì¼ ë°°ë¶„ ì‹œ ìˆœì„œ ë³´ì¥)
determinism:
  sort_keys: ["period", "charge_type", "warehouse_id",
              "channel_store_id", "item_id", "lot_id", "business_key"]
```

---

### 5.3 ë¹„ìš© ë„ë©”ì¸/ë‹¨ê³„ ì¶”ê°€

ìƒˆ `charge_domain` ë˜ëŠ” `cost_stage`ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```yaml
# charge_policy.yamlì— ìƒˆ ë„ë©”ì¸ ì‚¬ìš©
CARBON_OFFSET_FEE:
  charge_domain: sustainability        # â˜… ìƒˆ ë„ë©”ì¸
  cost_stage: period
  capitalizable_flag: false
  default_allocation_basis: revenue
  severity_if_missing: warn
```

> ğŸ’¡ ëŒ€ì‹œë³´ë“œì—ì„œ ìƒˆ ë„ë©”ì¸ì´ ìë™ìœ¼ë¡œ ì°¨íŠ¸ì— ë‚˜íƒ€ë‚˜ë ¤ë©´,
> `app/pnl_app.py`ì˜ í•œê¸€ ë¼ë²¨ ë§¤í•‘ì— ì¶”ê°€í•˜ì„¸ìš” (6.4 ì°¸ì¡°).

---

## 6. ëŒ€ì‹œë³´ë“œ ì»¤ìŠ¤í„°ë§ˆì´ì§•

### 6.1 P&L ëŒ€ì‹œë³´ë“œ íƒ­ ì¶”ê°€

#### í˜„ì¬ P&L íƒ­ êµ¬ì¡° (app/pnl_app.py)

| íƒ­ ë²ˆí˜¸ | ì´ë¦„ | ì„¤ëª… |
|---|---|---|
| 0 | ì†ìµ ìš”ì•½ | ì›Œí„°í´ ì°¨íŠ¸ |
| 1 | ë§¤ì¶œ | ë§¤ì¶œ ë¶„í•´ (ì´ë§¤ì¶œ, í• ì¸, í™˜ë¶ˆ, ìˆœë§¤ì¶œ) + êµ­ê°€ í•„í„° |
| 2 | ë§¤ì¶œì›ê°€ | COGS + ì»¤ë²„ë¦¬ì§€ ì´ì¤‘ ì§‘ê³„ |
| 3 | ë§¤ì¶œì´ì´ìµ | ACTUAL ê¸°ë°˜ ë§ˆì§„ìœ¨ |
| 4 | ë³€ë™ë¹„ | ë„ë©”ì¸/ë‹¨ê³„ ë¶„ì„ + ë‹¨ìœ„ë¹„ìš© |
| 5 | ê³µí—Œì´ìµ | ê³µí—Œì´ìµë¥  |
| 6 | ì˜ì—…ì´ìµ | ê³ ì •ë¹„ + ì˜ì—…ì´ìµë¥  |
| 7 | ìˆ˜ìµì„± ìˆœìœ„ | TOP/BOTTOM 10 (í’ˆëª©/ì±„ë„) |
| 8 | ë¹„ìš© ë°°ë¶„ | ë°°ë¶„ ë‚´ì—­ |
| 9 | ì •ì‚° ê²€ì¦ | ì •ì‚° vs ì¶”ì •, ì¸ë³´ì´ìŠ¤ vs ë°°ë¶„ |
| 10 | ì»¤ë²„ë¦¬ì§€ | íŠ¸ë˜í”½ ë¼ì´íŠ¸ + P&L flag ìš”ì•½ |

#### ìƒˆ íƒ­ ì¶”ê°€ ë°©ë²•

```python
# app/pnl_app.py

# 1. íƒ­ ëª©ë¡ì— ì¶”ê°€
tabs = st.tabs([
    "ì†ìµ ìš”ì•½", "ë§¤ì¶œ", "ë§¤ì¶œì›ê°€", "ë§¤ì¶œì´ì´ìµ",
    "ë³€ë™ë¹„", "ê³µí—Œì´ìµ", "ì˜ì—…ì´ìµ", "ìˆ˜ìµì„± ìˆœìœ„",
    "ë¹„ìš© ë°°ë¶„", "ì •ì‚° ê²€ì¦", "ì»¤ë²„ë¦¬ì§€",
    "EBITDA ë¶„ì„",                           # â˜… ìƒˆ íƒ­
])

# 2. íƒ­ ë‚´ìš© ì‘ì„±
with tabs[11]:  # ìƒˆ íƒ­ ì¸ë±ìŠ¤
    st.subheader("EBITDA ë¶„ì„")

    # ê¸°ê°„ í•„í„°
    period_filter = _period_filter_widget(con, "mart.mart_pnl_ebitda", "ebitda")

    # KPI ì¹´ë“œ
    sql = f"""
        SELECT
            SUM(ebitda_krw) as total_ebitda,
            AVG(ebitda_margin_pct) as avg_margin
        FROM mart.mart_pnl_ebitda
        {period_filter}
    """
    row = query_df(con, sql)
    if row is not None and len(row) > 0:
        c1, c2 = st.columns(2)
        c1.metric("EBITDA í•©ê³„", format_krw(row["total_ebitda"].iloc[0]))
        c2.metric("EBITDA ë§ˆì§„ìœ¨", f"{row['avg_margin'].iloc[0]:.1f}%")

    # ì»¤ë²„ë¦¬ì§€ ë°°ì§€
    _show_coverage_badge(con, "mart.mart_pnl_ebitda", "ebitda_krw", period_filter)

    # ìƒì„¸ í…Œì´ë¸”
    detail = query_df(con, f"""
        SELECT period, item_id, channel_store_id,
               operating_profit_krw, ebitda_krw, ebitda_margin_pct,
               coverage_flag
        FROM mart.mart_pnl_ebitda
        {period_filter}
        ORDER BY ebitda_krw DESC
        LIMIT 100
    """)
    if detail is not None:
        st.dataframe(detail, use_container_width=True)
```

---

### 6.2 SCM ëŒ€ì‹œë³´ë“œ íƒ­ ì¶”ê°€

#### í˜„ì¬ SCM íƒ­ êµ¬ì¡° (app/scm_app.py)

| íƒ­ ë²ˆí˜¸ | ì´ë¦„ | ì„¤ëª… |
|---|---|---|
| 0 | ì¬ê³  í˜„í™© | ì¬ê³ ê¸ˆì•¡, QC, ì°½ê³ ìœ í˜•, ìœ í†µê¸°í•œ ë²„í‚· |
| 1 | ì…ê³ /ë°œì£¼ | ë¯¸ì…ê³  PO, ë¦¬ë“œíƒ€ì„, ETA ì •í™•ë„ |
| 2 | ì¶œê³  í˜„í™© | ì¶œê³  ì„±ê³¼, ë°±ë¡œê·¸, ë§¤ì¹­ìœ¨, ë¦¬ë“œíƒ€ì„ |
| 3 | ë°˜í’ˆ ë¶„ì„ | ì‚¬ìœ ë³„, ì²˜ë¶„ë³„, TOP 10 ë¬¸ì œ í’ˆëª© |
| 4 | í’ˆì ˆ ìœ„í—˜ | ì»¤ë²„ì¼ìˆ˜, ìœ„í—˜ í’ˆëª© |
| 5 | ê³¼ì¬ê³  | íšŒì „ìœ¨, ê³¼ì¬ê³  ê¸ˆì•¡, ì €íšŒì „ í’ˆëª© |
| 6 | ìœ í†µê¸°í•œ ê´€ë¦¬ | ìœ„í—˜ê¸ˆì•¡, ë²„í‚· ë¶„í¬, FEFO |
| 7 | ì„œë¹„ìŠ¤ ë ˆë²¨ | ì£¼ê°„ ì •ì‹œì¶œê³ ìœ¨ |
| 8 | ì œì•½/ë³‘ëª© | ì‹ í˜¸ ê°ì§€, ê·¼ë³¸ì›ì¸, íš¨ê³¼ |
| 9 | ëŒ€ì‚¬/ê²€ì¦ | í†µí•© ëŒ€ì‚¬ ì„¼í„° (5ê°œ ëŒ€ì‚¬ ìœ í˜•) |
| 10 | ë¹„ìš© ì‹œë®¬ë ˆì´í„° | ë¬¼ë¥˜ë¹„ ì‹œë®¬ë ˆì´ì…˜ |

#### ìƒˆ íƒ­ ì¶”ê°€ (íŒ¨í„´)

```python
# app/scm_app.py

# íƒ­ ëª©ë¡ì— ì¶”ê°€
tabs = st.tabs([
    "ì¬ê³  í˜„í™©", "ì…ê³ /ë°œì£¼", "ğŸšš ì¶œê³  í˜„í™©", ...,
    "ğŸ“Š ì°½ê³  í™œìš©ë¥ ",                          # â˜… ìƒˆ íƒ­
])

with tabs[11]:
    st.subheader("ğŸ“Š ì°½ê³  í™œìš©ë¥ ")

    if not _has_table(con, "mart", "mart_warehouse_utilization"):
        st.warning("mart_warehouse_utilization í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤. íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ì„¸ìš”.")
        st.stop()

    df = query_df(con, """
        SELECT warehouse_id, warehouse_type,
               total_capacity_pallets, used_pallets,
               utilization_pct, available_pallets
        FROM mart.mart_warehouse_utilization
        ORDER BY utilization_pct DESC
    """)

    if df is not None and len(df) > 0:
        # KPI ì¹´ë“œ
        avg_util = df["utilization_pct"].mean()
        max_util_wh = df.iloc[0]["warehouse_id"]
        st.metric("í‰ê·  í™œìš©ë¥ ", f"{avg_util:.1f}%")
        st.metric("ê°€ì¥ í˜¼ì¡í•œ ì°½ê³ ", max_util_wh)

        # ë°” ì°¨íŠ¸
        st.bar_chart(df.set_index("warehouse_id")["utilization_pct"])

        # ìƒì„¸ í…Œì´ë¸”
        st.dataframe(df, use_container_width=True)
```

---

### 6.3 ê¸°ì¡´ íƒ­ì— ì°¨íŠ¸/KPI ì¶”ê°€

#### KPI ë©”íŠ¸ë¦­ ì¹´ë“œ ì¶”ê°€

```python
# st.metric() íŒ¨í„´
c1, c2, c3 = st.columns(3)
c1.metric("ë¼ë²¨", format_krw(ê°’))
c2.metric("ë¼ë²¨", f"{ê°’:.1f}%")
c3.metric("ë¼ë²¨", f"{ê°’:,.0f}ê±´")
```

#### ì°¨íŠ¸ ì¶”ê°€

```python
# Streamlit ê¸°ë³¸ ì°¨íŠ¸
st.bar_chart(df.set_index("x_column")["y_column"])
st.line_chart(df.set_index("date_column")["metric_column"])
st.area_chart(df.set_index("x")["y"])

# í…Œì´ë¸”
st.dataframe(df, use_container_width=True)

# í™•ì¥ íŒ¨ë„
with st.expander("ìƒì„¸ ë°ì´í„°", expanded=False):
    st.dataframe(df)
```

#### í•„í„° + ì¡°ê±´ë¶€ í‘œì‹œ

```python
# ê¸°ê°„ í•„í„° (ê³µí†µ í—¬í¼)
period_filter = _period_filter_widget(con, "mart.mart_pnl_revenue", "revenue_tab")

# êµ­ê°€ í•„í„° (ë™ì )
if _has_column(con, "mart", "mart_pnl_revenue", "country"):
    countries = query_df(con, "SELECT DISTINCT country FROM mart.mart_pnl_revenue")
    selected = st.multiselect("êµ­ê°€ ì„ íƒ", countries["country"].tolist())
    if selected:
        country_filter = f"AND country IN ({','.join(repr(c) for c in selected)})"
```

---

### 6.4 í•œê¸€ ë¼ë²¨ ì»¤ìŠ¤í„°ë§ˆì´ì§•

#### P&L ë¹„ìš© ë„ë©”ì¸ í•œê¸€ ë¼ë²¨

```python
# app/pnl_app.pyì— ì •ì˜ëœ ë§¤í•‘
CHARGE_DOMAIN_KR = {
    "logistics_transport": "ìš´ì†¡/ë¬¼ë¥˜",
    "customs": "í†µê´€/ê´€ì„¸",
    "3pl_billing": "3PL ë¹„ìš©",
    "platform_fee": "í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ",
    "marketing": "ë§ˆì¼€íŒ…",
    # â˜… ìƒˆ ë„ë©”ì¸ ì¶”ê°€ ì‹œ ì—¬ê¸°ì—ë„ ì¶”ê°€
    "sustainability": "ì§€ì†ê°€ëŠ¥ì„±",
}

COST_STAGE_KR = {
    "inbound_landed": "ìˆ˜ì…/ì…ê³ ",
    "storage": "ë³´ê´€",
    "outbound": "ì¶œê³ ",
    "returns": "ë°˜í’ˆ",
    "period": "ê¸°ê°„ë¹„ìš©",
}
```

#### ìƒˆ í•œê¸€ ë¼ë²¨ ì¶”ê°€

ìƒˆ `charge_domain`ì´ë‚˜ `cost_stage`ë¥¼ ì¶”ê°€í•˜ë©´ ìœ„ ë”•ì…”ë„ˆë¦¬ì—ë„ ì¶”ê°€í•´ì•¼ ëŒ€ì‹œë³´ë“œì—ì„œ
í•œê¸€ë¡œ í‘œì‹œë©ë‹ˆë‹¤. ì¶”ê°€í•˜ì§€ ì•Šìœ¼ë©´ ì˜ë¬¸ ì›ë³¸ì´ ê·¸ëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.

---

### 6.5 í•„í„° ìœ„ì ¯ ì¶”ê°€

#### ê¸°ê°„ í•„í„° (ê³µí†µ í—¬í¼)

```python
# app/pnl_app.py, app/scm_app.py ê³µí†µ

def _period_filter_widget(con, table: str, key_prefix: str) -> str:
    """ê¸°ê°„ ì„ íƒ ìœ„ì ¯ì„ í‘œì‹œí•˜ê³  SQL WHERE ì¡°ê±´ì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
    periods = query_df(con, f"SELECT DISTINCT period FROM {table} ORDER BY period DESC")
    if periods is None or len(periods) == 0:
        return ""
    selected = st.selectbox(
        "ê¸°ê°„ ì„ íƒ",
        ["ì „ì²´"] + periods["period"].tolist(),
        key=f"{key_prefix}_period"
    )
    if selected == "ì „ì²´":
        return ""
    return f"WHERE period = '{selected}'"
```

#### ì»¤ìŠ¤í…€ í•„í„° ì¶”ê°€

```python
# ì°½ê³  ìœ í˜• í•„í„°
def _warehouse_type_filter(con, key_prefix: str) -> str:
    types = query_df(con, """
        SELECT DISTINCT warehouse_type
        FROM core.dim_warehouse
        ORDER BY warehouse_type
    """)
    if types is None:
        return ""
    selected = st.multiselect("ì°½ê³  ìœ í˜•", types["warehouse_type"].tolist(), key=f"{key_prefix}_wh_type")
    if not selected:
        return ""
    type_list = ",".join(f"'{t}'" for t in selected)
    return f"AND w.warehouse_type IN ({type_list})"
```

---

## 7. ì»¬ëŸ¼ ë³„ì¹­ & ì†ŒìŠ¤ ë§¤í•‘

### ë³„ì¹­ ì„¤ì • êµ¬ì¡°

```yaml
# config/column_aliases.yaml

aliases:
  # ê³µí†µ ë³„ì¹­ (ëª¨ë“  í…Œì´ë¸”ì— ì ìš©)
  common:
    source_system:
      - "source_system"
      - "src_sys"
      - "ì†ŒìŠ¤ì‹œìŠ¤í…œ"

  # í…Œì´ë¸”ë³„ ë³„ì¹­
  fact_order:
    channel_order_id:
      - "channel_order_id"
      - "order_id"
      - "order_number"
      - "ì£¼ë¬¸ë²ˆí˜¸"
    qty_ordered:
      - "qty_ordered"
      - "ordered_qty"
      - "order_qty"
      - "ì£¼ë¬¸ìˆ˜ëŸ‰"
    order_date:
      - "order_date"
      - "order_dt"
      - "created_date"
      - "ì£¼ë¬¸ì¼"

  fact_shipment:
    shipment_id:
      - "shipment_id"
      - "shipment_no"
      - "ship_id"
      - "ì¶œê³ ë²ˆí˜¸"
    qty_shipped:
      - "qty_shipped"
      - "shipped_qty"
      - "ship_qty"
      - "ì¶œê³ ìˆ˜ëŸ‰"
```

### ê·œì¹™

| ê·œì¹™ | ì„¤ëª… |
|---|---|
| ëŒ€ì†Œë¬¸ì ë¬´ê´€ | `Order_ID`, `ORDER_ID`, `order_id` ëª¨ë‘ ë§¤ì¹­ |
| ìˆœì„œ ìš°ì„  | ë¦¬ìŠ¤íŠ¸ì˜ ì²« ë²ˆì§¸ ë§¤ì¹­ì´ ìš°ì„  |
| ì •ê·œëª… ë§¤ì¹­ í•„ìˆ˜ | ì •ê·œëª… (ì™¼ìª½)ì€ `schema.yaml`ì˜ ì»¬ëŸ¼ëª…ê³¼ ì¼ì¹˜í•´ì•¼ í•¨ |
| ë¯¸ë§¤ì¹­ ì»¬ëŸ¼ ë¬´ì‹œ | ì†ŒìŠ¤ íŒŒì¼ì˜ ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼ì€ ì ì¬ ì•ˆ ë¨ |
| ì¤‘ë³µ ë§¤í•‘ ì˜¤ë¥˜ | ê°™ì€ íŒŒì¼ì—ì„œ ì—¬ëŸ¬ ì†ŒìŠ¤ ì»¬ëŸ¼ì´ ë™ì¼ ì •ê·œëª…ì— ë§¤í•‘ â†’ CRITICAL |

### ìƒˆ ì†ŒìŠ¤ ì‹œìŠ¤í…œ ì»¬ëŸ¼ ì¶”ê°€

```yaml
# ì¼ë³¸ 3PLì˜ ì¶œê³  ë°ì´í„° ì»¬ëŸ¼ì„ ë§¤í•‘
fact_shipment:
  ship_date:
    - "ship_date"
    - "å‡ºè·æ—¥"           # ì¼ë³¸ì–´ ì»¬ëŸ¼ëª…
    - "shipment_date"
  warehouse_id:
    - "warehouse_id"
    - "å€‰åº«ã‚³ãƒ¼ãƒ‰"       # ì¼ë³¸ì–´ ì»¬ëŸ¼ëª…
    - "wh_code"
```

---

## 8. ì»¤ë²„ë¦¬ì§€ & ì•ˆì „ ê·œì¹™

### 8.1 coverage_flag ì‹œìŠ¤í…œ

6ê°œ P&L ë§ˆíŠ¸ì— `coverage_flag` ì»¬ëŸ¼ì´ ìˆìŠµë‹ˆë‹¤:

```
mart_pnl_revenue â”€â”€â”
                   â”œâ”€â”€ mart_pnl_gross_margin â”€â”€ mart_pnl_contribution â”€â”€ mart_pnl_operating_profit
mart_pnl_cogs â”€â”€â”€â”€â”€â”˜
```

| ê°’ | ì˜ë¯¸ | ë°œìƒ ì¡°ê±´ |
|---|---|---|
| `'ACTUAL'` | ëª¨ë“  ìƒìœ„ ë°ì´í„° í™•ì¸ë¨ | KRW ë§¤ì¶œ + ì›ê°€ ìˆìŒ |
| `'PARTIAL'` | ì¼ë¶€ ëˆ„ë½ | FX ëˆ„ë½, ì›ê°€ ë¯¸ë“±ë¡ |
| `NULL` | ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ | PARTIALë¡œ ì·¨ê¸‰ |

### 8.2 ì•ˆì „ ê·œì¹™ ìš”ì•½

| ê·œì¹™ | ì½”ë“œ ìœ„ì¹˜ | ì„¤ëª… |
|---|---|---|
| FX 1.0 í´ë°± ê¸ˆì§€ | `mart_pnl.py` | ë¹„-KRWì— í™˜ìœ¨ ì—†ìœ¼ë©´ NULL (1.0ìœ¼ë¡œ í™˜ì‚° ì•ˆ í•¨) |
| ì›ê°€ 0 ì±„ìš°ê¸° ê¸ˆì§€ | `mart_pnl.py` | ì›ê°€ ì—†ìœ¼ë©´ COGS = NULL (0 ì•„ë‹˜) |
| íŒë§¤ ì „ìš© í•„í„° | `mart_pnl.py`, `mart_scm.py` | `WHERE channel_order_id IS NOT NULL` |
| ì›ê°€ ì‚¬ì „ ì§‘ê³„ | `mart_pnl.py` | ì¡°ì¸ í­ë°œ ë°©ì§€ (`cost_component`ë³„ â†’ `item_id`ë³„) |
| ê·¸ë ˆì¸ ì •ë ¬ ROW_NUMBER | `mart_pnl.py` | PARTITION BYê°€ ì¶œë ¥ ê·¸ë ˆì¸ê³¼ ì¼ì¹˜ |
| coverage_flag ì „íŒŒ | `mart_pnl.py` | ìƒìœ„ PARTIAL â†’ í•˜ìœ„ ëª¨ë‘ PARTIAL |
| DQ ê·¸ë ˆì¸ ê²€ì¦ | `mart_pnl.py` | COGS ë§ˆíŠ¸ ê·¸ë ˆì¸ ì¤‘ë³µ ì‹œ ValueError |

### 8.3 ìƒˆ ë§ˆíŠ¸ì— coverage_flag ì¶”ê°€ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] DDLì— `coverage_flag VARCHAR` ì»¬ëŸ¼ í¬í•¨
- [ ] ë¹Œë”ì—ì„œ ìƒìœ„ ë§ˆíŠ¸ì˜ coverage_flag ì°¸ì¡°
- [ ] `CASE WHEN COALESCE(..., 'PARTIAL') = 'ACTUAL' ...` íŒ¨í„´ ì‚¬ìš©
- [ ] NULL ê°’ì€ PARTIALë¡œ ì·¨ê¸‰ (COALESCE ì‚¬ìš©)
- [ ] ëŒ€ì‹œë³´ë“œì—ì„œ `_show_coverage_badge()` í˜¸ì¶œ

---

## 9. íŒŒì´í”„ë¼ì¸ í™•ì¥

### ìƒˆ ë§ˆíŠ¸ ë¹Œë”ë¥¼ íŒŒì´í”„ë¼ì¸ì— ì—°ê²°

```python
# run.pyì˜ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ìˆœì„œ

def run_pipeline(con, config):
    # Phase 1: ìˆ˜ì§‘
    ingest_all(con, config, INBOX_DIR)

    # Phase 2: SCM ë§ˆíŠ¸
    build_all_scm_marts(con, config)         # â†’ mart_scm.py

    # Phase 3: ë¹„ìš© ë°°ë¶„
    allocate_all_charges(con, config)        # â†’ allocation.py

    # Phase 4: P&L ë§ˆíŠ¸
    build_all_pnl_marts(con, config)         # â†’ mart_pnl.py

    # Phase 5: ëŒ€ì‚¬
    build_all_reco_marts(con, config)        # â†’ mart_reco.py

    # Phase 6: ì œì•½
    build_all_constraint_marts(con, config)  # â†’ mart_constraint.py

    # Phase 7: ì»¤ë²„ë¦¬ì§€
    compute_coverage(con, config)            # â†’ coverage.py

    # â˜… ìƒˆ ë‹¨ê³„ ì¶”ê°€ (í•„ìš” ì‹œ)
    # Phase 8: ì»¤ìŠ¤í…€ ë¶„ì„
    # build_all_custom_marts(con, config)    # â†’ mart_custom.py
```

### ì‹¤í–‰ ìˆœì„œ ì˜ì¡´ì„±

```
Phase 1 (ìˆ˜ì§‘)
    â†“
Phase 2 (SCM ë§ˆíŠ¸) â† fact_inventory_snapshot, fact_shipment, ...
    â†“
Phase 3 (ë¹„ìš© ë°°ë¶„) â† fact_charge_actual, fact_shipment
    â†“
Phase 4 (P&L ë§ˆíŠ¸) â† mart_charge_allocated, fact_settlement, ...
    â†“
Phase 5 (ëŒ€ì‚¬) â† ëª¨ë“  CORE + MART í…Œì´ë¸”
    â†“
Phase 6 (ì œì•½) â† ëª¨ë“  MART í…Œì´ë¸”
    â†“
Phase 7 (ì»¤ë²„ë¦¬ì§€) â† ëª¨ë“  CORE í…Œì´ë¸”
```

> âš ï¸ **ìˆœì„œ ê·œì¹™**: ìƒˆ ë§ˆíŠ¸ ë¹Œë”ê°€ ë‹¤ë¥¸ ë§ˆíŠ¸ í…Œì´ë¸”ì„ ì°¸ì¡°í•˜ë©´,
> ì°¸ì¡° ëŒ€ìƒì´ ë¨¼ì € êµ¬ì¶•ë˜ëŠ” Phase ì´í›„ì— ë°°ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

---

## 10. ì²´í¬ë¦¬ìŠ¤íŠ¸ & ë¬¸ì œ í•´ê²°

### ì»¤ìŠ¤í„°ë§ˆì´ì§• ì²´í¬ë¦¬ìŠ¤íŠ¸

#### ìƒˆ ì»¬ëŸ¼ ì¶”ê°€ ì‹œ

- [ ] `src/db.py` DDL ìˆ˜ì •
- [ ] `config/schema.yaml` ìˆ˜ì • (required ë˜ëŠ” optional)
- [ ] `config/column_aliases.yaml` ë³„ì¹­ ì¶”ê°€ (ì„ íƒ)
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ì½”ë“œ ì¶”ê°€ (ê¸°ì¡´ DB ëŒ€ì‘)
- [ ] `python run.py --init` ì‹¤í–‰
- [ ] `python run.py --once` ì‹¤í–‰
- [ ] í…ŒìŠ¤íŠ¸ ì‹¤í–‰: `pytest tests/`

#### ìƒˆ í…Œì´ë¸” ì¶”ê°€ ì‹œ

- [ ] `src/db.py` DDL ì¶”ê°€
- [ ] `config/schema.yaml` ìŠ¤í‚¤ë§ˆ ì¶”ê°€ (CORE í…Œì´ë¸”ë§Œ)
- [ ] `config/column_aliases.yaml` ë³„ì¹­ ì¶”ê°€ (ì„ íƒ)
- [ ] `config/policies/coverage_policy.yaml` ë„ë©”ì¸ ì¶”ê°€ (ì„ íƒ)
- [ ] `python run.py --init` ì‹¤í–‰
- [ ] í…ŒìŠ¤íŠ¸ ì‹¤í–‰

#### ìƒˆ ë§ˆíŠ¸ ì¶”ê°€ ì‹œ

- [ ] `src/db.py` MART DDL ì¶”ê°€
- [ ] ë¹Œë” í•¨ìˆ˜ ì‘ì„± (`src/mart_*.py`)
- [ ] íŒŒì´í”„ë¼ì¸ì— ë“±ë¡ (`build_all_*_marts()`)
- [ ] `python run.py --init && python run.py --once`
- [ ] ëŒ€ì‹œë³´ë“œì— íƒ­/ì°¨íŠ¸ ì¶”ê°€ (ì„ íƒ)
- [ ] í…ŒìŠ¤íŠ¸ ì‹¤í–‰

#### ìƒˆ ì§€í‘œ ì¶”ê°€ ì‹œ

- [ ] ì‚°ì‹ ì •ì˜ (SQL ì‘ì„±)
- [ ] ë§ˆíŠ¸ DDLì— ì»¬ëŸ¼ ì¶”ê°€ (ë˜ëŠ” ìƒˆ ë§ˆíŠ¸ ìƒì„±)
- [ ] ë¹Œë” í•¨ìˆ˜ì— ì‚°ì‹ êµ¬í˜„
- [ ] P&L ì§€í‘œì¸ ê²½ìš° `coverage_flag` ì „íŒŒ í¬í•¨
- [ ] ëŒ€ì‹œë³´ë“œì— KPI ì¹´ë“œ / ì°¨íŠ¸ ì¶”ê°€
- [ ] `docs/ì§€í‘œ_KPI_ë ˆí¼ëŸ°ìŠ¤.md`ì— ì§€í‘œ ë¬¸ì„œí™”

#### ìƒˆ ë¹„ìš© ìœ í˜• ì¶”ê°€ ì‹œ

- [ ] `config/policies/charge_policy.yaml`ì— ì¶”ê°€
- [ ] `config/policies/allocation.yaml`ì— ì˜¤ë²„ë¼ì´ë“œ ì¶”ê°€ (ì„ íƒ)
- [ ] `app/pnl_app.py`ì˜ í•œê¸€ ë¼ë²¨ ë§¤í•‘ ì¶”ê°€ (ì„ íƒ)
- [ ] `python run.py --init && python run.py --once`

---

### ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œ & í•´ê²°

| ë¬¸ì œ | ì›ì¸ | í•´ê²° |
|---|---|---|
| `CREATE TABLE IF NOT EXISTS`ê°€ ìƒˆ ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ | DuckDBëŠ” í…Œì´ë¸”ì´ ì´ë¯¸ ìˆìœ¼ë©´ DDLì„ ë¬´ì‹œ | `init_db()`ì— ALTER TABLE ë§ˆì´ê·¸ë ˆì´ì…˜ ì½”ë“œ ì¶”ê°€ |
| DQ ê²€ì‚¬ì—ì„œ `Unknown charge_type` ì˜¤ë¥˜ | `charge_policy.yaml`ì— ìƒˆ ë¹„ìš© ìœ í˜• ë¯¸ë“±ë¡ | `charge_policy.yaml`ì— ì¶”ê°€ í›„ `--init` |
| ë§ˆíŠ¸ ë¹Œë”ì—ì„œ ì»¬ëŸ¼ ìˆ˜ ë¶ˆì¼ì¹˜ | DDL ì»¬ëŸ¼ ìˆ˜ì™€ SELECT ì»¬ëŸ¼ ìˆ˜ ë‹¤ë¦„ | DDLê³¼ SELECTì˜ ì»¬ëŸ¼ ìˆœì„œ/ìˆ˜ ì¼ì¹˜ì‹œí‚¤ê¸° |
| ëŒ€ì‹œë³´ë“œì—ì„œ "í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤" ê²½ê³  | `--init`ì„ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ë§ˆíŠ¸ ë¯¸êµ¬ì¶• | `python run.py --init && python run.py --once` |
| coverage_flagê°€ ëª¨ë‘ PARTIAL | FX í™˜ìœ¨ ë˜ëŠ” ì›ê°€ ë§ˆìŠ¤í„° ëˆ„ë½ | í™˜ìœ¨/ì›ê°€ ë°ì´í„°ë¥¼ `inbox/`ì— ì¶”ê°€ |
| ë°°ë¶„ í•©ê³„ê°€ ì¸ë³´ì´ìŠ¤ ê¸ˆì•¡ê³¼ ë¶ˆì¼ì¹˜ | Hare-Niemeyer ë°˜ì˜¬ë¦¼ ì˜¤ë¥˜ | `allocation.yaml`ì˜ `decimals` í™•ì¸ |
| ìˆ˜ì§‘ ì‹œ í…Œì´ë¸” ìë™ ê°ì§€ ì‹¤íŒ¨ | íŒŒì¼ ì»¬ëŸ¼ì´ ì–´ë–¤ schema.yaml ì •ì˜ì™€ë„ ë§¤ì¹­ ì•ˆ ë¨ | `column_aliases.yaml`ì— ë³„ì¹­ ì¶”ê°€ |
| `ValueError: grain duplicates` | COGS ë§ˆíŠ¸ì—ì„œ ê·¸ë ˆì¸ ì¤‘ë³µ ê°ì§€ | `fact_cost_structure` ë°ì´í„° ì •í•©ì„± í™•ì¸ |

---

### ë””ë²„ê¹… ëª…ë ¹ì–´

```bash
# DB ìƒíƒœ í™•ì¸
python run.py --status

# í…Œì´ë¸” í–‰ ìˆ˜ í™•ì¸
python -c "
from src.db import get_connection, get_row_counts
con = get_connection()
for table, count in sorted(get_row_counts(con).items()):
    print(f'{table:50s} {count:>10,}')
"

# íŠ¹ì • í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸
python -c "
from src.db import get_connection, get_table_columns
con = get_connection()
cols = get_table_columns(con, 'mart', 'mart_pnl_revenue')
print('\n'.join(cols))
"

# DQ ë³´ê³ ì„œ í™•ì¸
python -c "
from src.db import get_connection
con = get_connection()
df = con.execute('SELECT * FROM raw.system_dq_report ORDER BY checked_at DESC LIMIT 20').df()
print(df.to_string())
"

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
pytest tests/ -v

# íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
pytest tests/test_phase0_safety.py -v
```

---

## ë¶€ë¡: ì „ì²´ ì„¤ì • íŒŒì¼ ìš”ì•½

| íŒŒì¼ | ëª©ì  | ì˜í–¥ ë²”ìœ„ |
|---|---|---|
| `src/db.py` | ë¬¼ë¦¬ DDL (ëª¨ë“  í…Œì´ë¸”) | ìŠ¤í‚¤ë§ˆ ìƒì„±, ë§ˆì´ê·¸ë ˆì´ì…˜ |
| `config/schema.yaml` | ë…¼ë¦¬ ìŠ¤í‚¤ë§ˆ (ì»¬ëŸ¼, íƒ€ì…, BK) | ìˆ˜ì§‘, DQ ê²€ì‚¬, í…Œì´ë¸” ê°ì§€ |
| `config/column_aliases.yaml` | ì»¬ëŸ¼ëª… ë§¤í•‘ | ìˆ˜ì§‘ ì‹œ ì†ŒìŠ¤ ì»¬ëŸ¼ ì¸ì‹ |
| `config/thresholds.yaml` | ì§€í‘œ ì„ê³„ê°’ | ë§ˆíŠ¸, ëŒ€ì‹œë³´ë“œ, ì œì•½ |
| `config/policies/charge_policy.yaml` | ë¹„ìš© ìœ í˜• ì •ì˜ | ë°°ë¶„, DQ, ë¹„ìš© ë§ˆíŠ¸ |
| `config/policies/allocation.yaml` | ë°°ë¶„ ê¸°ì¤€ ìš°ì„ ìˆœìœ„, ë°˜ì˜¬ë¦¼ | ë°°ë¶„ ì—”ì§„ |
| `config/policies/coverage_policy.yaml` | ì»¤ë²„ë¦¬ì§€ ë„ë©”ì¸ | ê¸°ê°„ ë§ˆê°, ëŒ€ì‹œë³´ë“œ |
| `config/policies/tax_policy.yaml` | êµ­ê°€ë³„ ì„¸ê¸ˆ ê·œì¹™ | ë¹„ìš© ê³„ì‚° |
| `src/mart_scm.py` | SCM ë§ˆíŠ¸ ë¹Œë” | SCM ëŒ€ì‹œë³´ë“œ |
| `src/mart_pnl.py` | P&L ë§ˆíŠ¸ ë¹Œë” | P&L ëŒ€ì‹œë³´ë“œ |
| `src/mart_reco.py` | ëŒ€ì‚¬ ë§ˆíŠ¸ ë¹Œë” | ëŒ€ì‚¬ ê²€ì¦ |
| `src/mart_constraint.py` | ì œì•½ ë§ˆíŠ¸ ë¹Œë” | ì œì•½ ëŒ€ì‹œë³´ë“œ |
| `app/pnl_app.py` | P&L ëŒ€ì‹œë³´ë“œ UI | Streamlit (í¬íŠ¸ 8502) |
| `app/scm_app.py` | SCM ëŒ€ì‹œë³´ë“œ UI | Streamlit (í¬íŠ¸ 8501) |
