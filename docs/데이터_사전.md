# 데이터 사전

> SCM 운영 분석 DB -- 전체 스키마 레퍼런스.
> 엔진: DuckDB | DataFrame: Polars | UI: Streamlit

---

## 스키마 개요

| 스키마 | 목적 | 보존 정책 |
|--------|------|-----------|
| `raw`  | 소스 시스템 원본 추출; 소스 파일/API당 하나의 테이블 | 추가 전용, 불변 |
| `core` | 정규화된 팩트 및 차원 테이블; 단일 진실 공급원 (SSOT) | SCD-2 / 스냅샷 |
| `mart` | 대시보드에서 사용하는 사전 집계 분석 테이블 | 매 실행 시 재구축 |
| `ops`  | 운영 메타데이터 (이슈, 기간 마감, 조정) | 추가 전용 |

---

## RAW 스키마

Raw 테이블은 소스 시스템 구조를 그대로 반영합니다. 컬럼명은 소스에서 받은 그대로 유지됩니다. 각 행에는 수집 시 두 개의 감사 컬럼이 추가됩니다.

| 감사 컬럼 | 타입 | 설명 |
|---|---|---|
| `_raw_loaded_at` | `TIMESTAMP` | 행이 수집된 UTC 타임스탬프 |
| `_raw_source_file` | `VARCHAR` | 원본 파일명 또는 API 엔드포인트 |

대표적인 raw 테이블 (전체 목록 아님):

| 테이블 | 소스 시스템 | 설명 |
|---|---|---|
| `raw.oms_orders` | OMS | 판매 주문 헤더 + 라인 |
| `raw.oms_returns` | OMS | 반품 요청 |
| `raw.wms_shipments` | WMS | 출고 확인 |
| `raw.wms_receipts` | WMS | 입고 확인 |
| `raw.wms_inventory` | WMS | 일일 재고 스냅샷 |
| `raw.erp_purchase_orders` | ERP | 구매 발주 헤더 + 라인 |
| `raw.erp_goods_receipts` | ERP | 입고 전기 |
| `raw.erp_cost_centers` | ERP | 코스트센터 마스터 |
| `raw.stl_invoices` | 정산 | 3PL / 물류 인보이스 |
| `raw.stl_rates` | 정산 | 계약 단가표 |
| `raw.fx_rates` | 시장 데이터 | 일일 환율 |

---

## CORE 스키마 -- 팩트 테이블

### `core.fact_order`

입도: 주문 라인당 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `order_id` | `VARCHAR` | 고유 주문 식별자 (PK 구성요소) |
| `order_line_id` | `VARCHAR` | 주문 내 라인 순번 (PK 구성요소) |
| `order_date` | `DATE` | 주문 접수일 |
| `channel_store_id` | `VARCHAR` | FK → `dim_channel_store` |
| `item_id` | `VARCHAR` | FK → `dim_item` |
| `partner_id` | `VARCHAR` | FK → `dim_partner` |
| `warehouse_id` | `VARCHAR` | FK → `dim_warehouse` |
| `ordered_qty` | `DECIMAL(18,4)` | 주문 수량 |
| `unit_price` | `DECIMAL(18,4)` | 단위 판매가 |
| `currency_code` | `VARCHAR(3)` | ISO 4217 통화 |
| `order_status` | `VARCHAR` | OPEN / CONFIRMED / CANCELLED / SHIPPED / DELIVERED |
| `promised_ship_date` | `DATE` | 고객에게 약속한 출고일 |
| `actual_ship_date` | `DATE` | 실제 출고일 (미출고 시 NULL) |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.fact_shipment`

입도: 출고 라인당 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `shipment_id` | `VARCHAR` | 고유 출고 식별자 (PK 구성요소) |
| `shipment_line_id` | `VARCHAR` | 출고 내 라인 (PK 구성요소) |
| `order_id` | `VARCHAR` | FK → `fact_order` |
| `order_line_id` | `VARCHAR` | FK → `fact_order` |
| `item_id` | `VARCHAR` | FK → `dim_item` |
| `warehouse_id` | `VARCHAR` | FK → `dim_warehouse` |
| `shipped_qty` | `DECIMAL(18,4)` | 출고 수량 |
| `ship_date` | `DATE` | 실제 출고일 |
| `carrier_code` | `VARCHAR` | 운송사 / 물류 제공자 코드 |
| `tracking_number` | `VARCHAR` | 운송장 번호 |
| `weight_kg` | `DECIMAL(12,4)` | 출고 중량 |
| `volume_cbm` | `DECIMAL(12,6)` | 출고 부피 (세제곱미터) |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.fact_return`

입도: 반품 라인당 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `return_id` | `VARCHAR` | 반품 요청 식별자 (PK 구성요소) |
| `return_line_id` | `VARCHAR` | 반품 내 라인 (PK 구성요소) |
| `order_id` | `VARCHAR` | 원래 주문 FK |
| `order_line_id` | `VARCHAR` | 원래 주문 라인 FK |
| `item_id` | `VARCHAR` | FK → `dim_item` |
| `warehouse_id` | `VARCHAR` | 입고 창고 FK |
| `returned_qty` | `DECIMAL(18,4)` | 반품 수량 |
| `return_reason_code` | `VARCHAR` | 표준화된 반품 사유 코드 |
| `return_date` | `DATE` | 반품 수령일 |
| `disposition` | `VARCHAR` | RESTOCK / SCRAP / QUARANTINE |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.fact_inventory_snapshot`

입도: 품목 x 창고 x 로트 x 스냅샷 일자별 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `snapshot_date` | `DATE` | 스냅샷 일자 (PK 구성요소) |
| `item_id` | `VARCHAR` | FK → `dim_item` (PK 구성요소) |
| `warehouse_id` | `VARCHAR` | FK → `dim_warehouse` (PK 구성요소) |
| `lot_id` | `VARCHAR` | 로트/배치 식별자; 미추적 시 `'__NONE__'` (PK 구성요소) |
| `on_hand_qty` | `DECIMAL(18,4)` | 실물 총 재고 |
| `sellable_qty` | `DECIMAL(18,4)` | 출고 가능 재고 (ATP) |
| `reserved_qty` | `DECIMAL(18,4)` | 주문 예약 재고 |
| `damaged_qty` | `DECIMAL(18,4)` | 파손 / 격리 재고 |
| `expired_qty` | `DECIMAL(18,4)` | 유통기한 만료 재고 |
| `expiry_date` | `DATE` | 로트 유통기한 (미추적 시 NULL) |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.fact_po` (구매 발주)

입도: 발주 라인당 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `po_id` | `VARCHAR` | 구매 발주 식별자 (PK 구성요소) |
| `po_line_id` | `VARCHAR` | 발주 내 라인 (PK 구성요소) |
| `partner_id` | `VARCHAR` | 공급업체 FK → `dim_partner` |
| `item_id` | `VARCHAR` | FK → `dim_item` |
| `warehouse_id` | `VARCHAR` | 입고 창고 FK |
| `ordered_qty` | `DECIMAL(18,4)` | 발주 수량 |
| `unit_cost` | `DECIMAL(18,4)` | 단위 매입가 |
| `currency_code` | `VARCHAR(3)` | ISO 4217 통화 |
| `po_date` | `DATE` | 발주 생성일 |
| `expected_delivery_date` | `DATE` | 납기 요청일 |
| `po_status` | `VARCHAR` | OPEN / PARTIAL / RECEIVED / CANCELLED |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.fact_receipt`

입도: 입고 라인당 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `receipt_id` | `VARCHAR` | 입고 식별자 (PK 구성요소) |
| `receipt_line_id` | `VARCHAR` | 입고 내 라인 (PK 구성요소) |
| `po_id` | `VARCHAR` | FK → `fact_po` |
| `po_line_id` | `VARCHAR` | FK → `fact_po` |
| `item_id` | `VARCHAR` | FK → `dim_item` |
| `warehouse_id` | `VARCHAR` | FK → `dim_warehouse` |
| `received_qty` | `DECIMAL(18,4)` | 입고 수량 |
| `receipt_date` | `DATE` | 입고 일자 |
| `lot_id` | `VARCHAR` | 입고 시 배정된 로트; 미추적 시 `'__NONE__'` |
| `inspection_result` | `VARCHAR` | PASS / FAIL / PENDING |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.fact_settlement`

입도: 정산 라인 항목당 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `settlement_id` | `VARCHAR` | 정산 / 인보이스 식별자 (PK 구성요소) |
| `settlement_line_id` | `VARCHAR` | 정산 내 라인 (PK 구성요소) |
| `partner_id` | `VARCHAR` | 3PL / 운송사 FK |
| `settlement_date` | `DATE` | 인보이스 또는 정산 일자 |
| `charge_type` | `VARCHAR` | 비용 유형 코드 (FK → `dim_charge_policy`) |
| `reference_id` | `VARCHAR` | 관련 출고 / 주문 참조 |
| `invoiced_amount` | `DECIMAL(18,4)` | 인보이스 금액 |
| `currency_code` | `VARCHAR(3)` | ISO 4217 통화 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.fact_charge_actual`

입도: 배분된 비용 건당 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `charge_id` | `VARCHAR` | 대리 비용 식별자 (PK) |
| `charge_type` | `VARCHAR` | 비용 유형 코드 |
| `cost_stage` | `VARCHAR` | INBOUND / STORAGE / OUTBOUND / RETURN / CUSTOMS |
| `item_id` | `VARCHAR` | FK → `dim_item` |
| `warehouse_id` | `VARCHAR` | FK → `dim_warehouse` |
| `partner_id` | `VARCHAR` | 서비스 제공자 FK |
| `reference_id` | `VARCHAR` | 관련 거래 참조 |
| `allocated_amount` | `DECIMAL(18,4)` | 배분된 비용 금액 |
| `basis_qty` | `DECIMAL(18,4)` | 배분 기준 수량 |
| `basis_unit` | `VARCHAR` | 기준 단위 (PCS / KG / CBM / PALLET) |
| `currency_code` | `VARCHAR(3)` | ISO 4217 통화 |
| `charge_date` | `DATE` | 비용 유효 일자 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.fact_exchange_rate`

입도: 통화 쌍 x 일자별 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `rate_date` | `DATE` | 유효 일자 (PK 구성요소) |
| `from_currency` | `VARCHAR(3)` | 원천 통화 (PK 구성요소) |
| `to_currency` | `VARCHAR(3)` | 대상 통화 (PK 구성요소) |
| `exchange_rate` | `DECIMAL(18,8)` | 환산 비율 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.fact_cost_structure`

입도: 품목 x 비용단계 x 기간별 1행.

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `item_id` | `VARCHAR` | FK → `dim_item` (PK 구성요소) |
| `cost_stage` | `VARCHAR` | INBOUND / STORAGE / OUTBOUND / RETURN / CUSTOMS (PK 구성요소) |
| `period_key` | `VARCHAR` | YYYY-MM 기간 (PK 구성요소) |
| `warehouse_id` | `VARCHAR` | FK → `dim_warehouse` (PK 구성요소) |
| `total_cost` | `DECIMAL(18,4)` | 해당 단계 총 배분 비용 |
| `total_qty` | `DECIMAL(18,4)` | 총 기준 수량 |
| `unit_cost` | `DECIMAL(18,4)` | 산출 단가 |
| `currency_code` | `VARCHAR(3)` | 보고 통화 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

---

## CORE 스키마 -- 차원 테이블

### `core.dim_item`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `item_id` | `VARCHAR` | 자연 비즈니스 키 (PK) |
| `item_name` | `VARCHAR` | 표시명 |
| `sku` | `VARCHAR` | 재고 관리 단위 |
| `barcode` | `VARCHAR` | EAN / UPC 바코드 |
| `category_l1` | `VARCHAR` | 대분류 카테고리 |
| `category_l2` | `VARCHAR` | 중분류 카테고리 |
| `category_l3` | `VARCHAR` | 소분류 카테고리 |
| `brand` | `VARCHAR` | 브랜드명 |
| `unit_weight_kg` | `DECIMAL(12,4)` | 단위당 중량 |
| `unit_volume_cbm` | `DECIMAL(12,6)` | 단위당 부피 |
| `shelf_life_days` | `INTEGER` | 유통기한 일수 (비부패성이면 NULL) |
| `country_of_origin` | `VARCHAR(2)` | ISO 3166-1 alpha-2 |
| `hs_code` | `VARCHAR` | HS 코드 (관세 분류) |
| `is_active` | `BOOLEAN` | 활성 여부 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.dim_partner`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `partner_id` | `VARCHAR` | 자연 비즈니스 키 (PK) |
| `partner_name` | `VARCHAR` | 법적 / 표시명 |
| `partner_type` | `VARCHAR` | SUPPLIER / 3PL / CARRIER / CUSTOMER |
| `country_code` | `VARCHAR(2)` | ISO 3166-1 alpha-2 |
| `contact_email` | `VARCHAR` | 주 담당자 이메일 |
| `payment_terms_days` | `INTEGER` | 표준 결제 조건 (일) |
| `is_active` | `BOOLEAN` | 활성 여부 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.dim_channel_store`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `channel_store_id` | `VARCHAR` | 자연 비즈니스 키 (PK) |
| `channel_name` | `VARCHAR` | 채널명 (예: Shopify, Amazon, 도매) |
| `store_name` | `VARCHAR` | 특정 스토어 또는 매장명 |
| `country_code` | `VARCHAR(2)` | 운영 국가 |
| `platform_type` | `VARCHAR` | MARKETPLACE / D2C / WHOLESALE / RETAIL |
| `is_active` | `BOOLEAN` | 활성 여부 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.dim_warehouse`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `warehouse_id` | `VARCHAR` | 자연 비즈니스 키 (PK) |
| `warehouse_name` | `VARCHAR` | 표시명 |
| `warehouse_type` | `VARCHAR` | OWN / 3PL / BONDED / CROSS_DOCK |
| `country_code` | `VARCHAR(2)` | 국가 |
| `region` | `VARCHAR` | 지역 또는 도/시 |
| `city` | `VARCHAR` | 도시 |
| `operator_partner_id` | `VARCHAR` | FK → `dim_partner` (3PL 운영사) |
| `capacity_pallets` | `INTEGER` | 최대 팔레트 용량 |
| `is_active` | `BOOLEAN` | 활성 여부 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.dim_uom_conversion`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `item_id` | `VARCHAR` | FK → `dim_item` (PK 구성요소) |
| `from_uom` | `VARCHAR` | 원천 단위 (PK 구성요소) |
| `to_uom` | `VARCHAR` | 대상 단위 (PK 구성요소) |
| `conversion_factor` | `DECIMAL(18,8)` | `from_uom` 수량에 곱하면 `to_uom` 수량이 됨 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

### `core.dim_charge_policy`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `charge_type` | `VARCHAR` | 비용 유형 코드 (PK) |
| `charge_name` | `VARCHAR` | 사람이 읽을 수 있는 명칭 |
| `cost_stage` | `VARCHAR` | INBOUND / STORAGE / OUTBOUND / RETURN / CUSTOMS |
| `allocation_basis` | `VARCHAR` | QTY / WEIGHT / VOLUME / FLAT / ORDER |
| `default_rate` | `DECIMAL(18,4)` | 기준 단위당 기본 단가 |
| `currency_code` | `VARCHAR(3)` | 단가 통화 |
| `is_active` | `BOOLEAN` | 활성 여부 |
| `_loaded_at` | `TIMESTAMP` | 수집 타임스탬프 |

---

## MART 스키마

모든 마트 테이블은 매 파이프라인 실행 시 재구축됩니다. Streamlit 프론트엔드에서는 읽기 전용입니다.

### SCM 마트

| # | 테이블 | 입도 | 설명 |
|---|---|---|---|
| 1 | `mart.mart_inventory_onhand` | 품목 x 창고 x 로트 x 스냅샷일 | 재고 현황 (판매가능, 차단, 만료 수량, 유통기한 버킷) |
| 2 | `mart.mart_open_po` | 발주 라인 | 미입고 발주 현황, 지연일, 리드타임, ETA 정확도 |
| 3 | `mart.mart_stockout_risk` | 품목 x 창고 | 품절 위험 플래그, 커버 일수, 일평균 수요 |
| 4 | `mart.mart_overstock` | 품목 x 창고 | 과재고 플래그, DOH, 과재고 수량 |
| 5 | `mart.mart_expiry_risk` | 품목 x 창고 x 로트 | 유통기한 위험, 잔여일수, 위험금액(`risk_value_krw`) |
| 6 | `mart.mart_fefo_pick_list` | 창고 x 품목 x 로트 | FEFO 피킹 우선순위 |
| 7 | `mart.mart_service_level` | 주차 x 채널스토어 | 주간 서비스 레벨 (정시출고율) |
| 8 | `mart.mart_shipment_performance` | 기간 x 창고 x 채널 | 출고 성과 (건수, 수량, 중량, 정시율, 리드타임) |
| 9 | `mart.mart_shipment_daily` | 출고일 x 창고 | 일별 출고 추이 |
| 10 | `mart.mart_return_analysis` | 기간 x 품목 x 사유 | 반품 분석 (수량, 반품율, 처분) |
| 11 | `mart.mart_return_daily` | 반품일 x 창고 | 일별 반품 추이 |

### P&L 마트

> ⚠️ **coverage_flag**: 아래 6개 P&L 마트에는 `coverage_flag VARCHAR` 컬럼이 있습니다.
> - `'ACTUAL'`: 모든 상위 데이터가 확인됨 (원가, FX 환율 등)
> - `'PARTIAL'`: 원가 누락, FX 환율 누락 등으로 일부 값이 NULL
> - `NULL`: 마이그레이션 이전 데이터 — `PARTIAL`로 취급 (안전 기본값)
>
> **전파 규칙**: 하위 마트는 상위 마트 중 하나라도 `ACTUAL`이 아니면 `PARTIAL`이 됩니다.
> `매출 → COGS → 매출총이익 → 공헌이익 → 영업이익` 순서로 전파.

| # | 테이블 | 입도 | coverage_flag | 설명 |
|---|---|---|---|---|
| 12 | `mart.mart_pnl_revenue` | 기간 x 품목 x 채널 x 국가 | ✅ | 매출 (총매출, 할인, 환불, 순매출; FX 환산) |
| 13 | `mart.mart_pnl_cogs` | 기간 x 품목 x 채널 | ✅ | 매출원가 (출고수량, 반품수량, 단위원가, COGS) |
| 14 | `mart.mart_pnl_gross_margin` | 기간 x 품목 x 채널 | ✅ | 매출총이익 (순매출 - COGS, 마진율) |
| 15 | `mart.mart_pnl_variable_cost` | 기간 x 품목 x 채널 x 도메인 x 유형 | — | 변동비 (비용도메인/비용유형별 배분 금액) |
| 16 | `mart.mart_pnl_contribution` | 기간 x 품목 x 채널 | ✅ | 공헌이익 (매출총이익 - 변동비, 공헌이익률) |
| 17 | `mart.mart_pnl_operating_profit` | 기간 x 품목 x 채널 | ✅ | 영업이익 (공헌이익 - 고정비, 영업이익률) |
| 18 | `mart.mart_pnl_waterfall_summary` | 기간 x 지표 | — | 손익 워터폴 요약 (매출→원가→이익 단계별 금액) |

### 비용 배분 마트

| # | 테이블 | 입도 | 설명 |
|---|---|---|---|
| 19 | `mart.mart_charge_allocated` | 기간 x 비용유형 x 도메인 x 단계 x 품목 | 헤어-니마이어 배분된 비용 내역 |

### 대사 마트

| # | 테이블 | 입도 | 설명 |
|---|---|---|---|
| 20 | `mart.mart_reco_inventory_movement` | 스냅샷일 x 창고 x 품목 | 재고 수불 대사 (기초+입고-출고 = 기말) |
| 21 | `mart.mart_reco_oms_vs_wms` | 기간 x 품목 x 채널 | OMS 주문수량 vs WMS 출고수량 |
| 22 | `mart.mart_reco_erp_gr_vs_wms_receipt` | 기간 x 품목 x 발주 | ERP 입고 vs WMS 입고 수량 |
| 23 | `mart.mart_reco_settlement_vs_estimated` | 기간 x 채널 x 품목 | 정산매출 vs 추정매출 (delta, 차이율) |
| 24 | `mart.mart_reco_charges_invoice_vs_allocated` | 기간 x 비용유형 | 인보이스 금액 vs 배분 금액 (tied 여부) |

### 제약/커버리지 마트

| # | 테이블 | 입도 | 설명 |
|---|---|---|---|
| 25 | `mart.mart_constraint_signals` | 신호 | 제약 신호 (도메인, 지표, 임계값, 심각도) |
| 26 | `mart.mart_constraint_root_cause` | 신호 | 근본 원인 분석 |
| 27 | `mart.mart_constraint_action_plan` | 신호 | 권장 조치 계획 |
| 28 | `mart.mart_constraint_effectiveness` | 신호 | 제약 해소 전후 효과 측정 |
| 29 | `mart.mart_coverage_period` | 기간 x 도메인 | 도메인별 커버리지율 + 심각도 |

### P&L 마트 안전 규칙 (v2025.06)

이번 업데이트에서 적용된 핵심 안전 규칙:

| 규칙 | 설명 | 적용 대상 |
|---|---|---|
| **원가 사전 집계** | `fact_cost_structure`의 `cost_component`별 행을 `SUM(cost_per_unit_krw) GROUP BY item_id, effective_from`으로 사전 집계하여 조인 폭발 방지 | COGS, 유통기한 위험금액 |
| **그레인 정렬 ROW_NUMBER** | `PARTITION BY (period, item_id, channel_store_id)` — 출력 그레인과 파티션 키 일치 (데이터 손실 방지) | COGS |
| **FX 1.0 폴백 제거** | 비-KRW 통화에 환율 누락 시 KRW 값 = NULL + coverage_flag = PARTIAL (묵시적 1.0 환산 금지) | 매출 |
| **fill_null(0) 제거** | 원가/환율 필드에 0 채우기 금지; 의도적 0 (qty_returned, avg_daily_demand)만 유지 | COGS, 유통기한 |
| **판매 전용 필터** | `WHERE channel_order_id IS NOT NULL` — 내부 이동/이관 제외, 판매 출고만 포함 | COGS, 품절, 과재고 |
| **coverage_flag 전파** | 상위 마트 중 하나라도 ACTUAL 아니면 하위 마트 = PARTIAL | 매출총이익→공헌이익→영업이익 |
| **DQ 그레인 검증** | COGS 마트에서 그레인 중복 감지 시 ValueError 발생 (자동 통과 금지) | COGS |

---

## OPS 스키마

### `ops.ops_issue_log`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `issue_id` | `VARCHAR` | 자동 생성 이슈 식별자 (PK) |
| `run_id` | `VARCHAR` | 파이프라인 실행 식별자 |
| `check_name` | `VARCHAR` | 이슈를 발생시킨 DQ 검사명 |
| `severity` | `VARCHAR` | CRITICAL / HIGH / MEDIUM / LOW |
| `schema_name` | `VARCHAR` | 영향받은 스키마 |
| `table_name` | `VARCHAR` | 영향받은 테이블 |
| `column_name` | `VARCHAR` | 영향받은 컬럼 (테이블 수준 검사 시 NULL) |
| `record_count` | `INTEGER` | 위반 레코드 수 |
| `sample_values` | `VARCHAR` | 최대 5개 샘플 값의 JSON 배열 |
| `message` | `VARCHAR` | 사람이 읽을 수 있는 설명 |
| `created_at` | `TIMESTAMP` | 이슈 기록 시점 |

### `ops.ops_period_close`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `period_key` | `VARCHAR` | YYYY-MM 기간 (PK) |
| `status` | `VARCHAR` | OPEN / CLOSED / LOCKED |
| `closed_at` | `TIMESTAMP` | 기간 마감 시점 |
| `closed_by` | `VARCHAR` | 마감 실행자 (사용자 또는 시스템) |
| `locked_at` | `TIMESTAMP` | 기간 잠금 시점 (미잠금 시 NULL) |
| `notes` | `VARCHAR` | 마감 비고 |

### `ops.ops_adjustment_log`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `adjustment_id` | `VARCHAR` | 자동 생성 식별자 (PK) |
| `period_key` | `VARCHAR` | 영향받은 기간 |
| `table_name` | `VARCHAR` | 조정된 테이블 |
| `adjustment_type` | `VARCHAR` | INSERT / UPDATE / DELETE |
| `record_key` | `VARCHAR` | 조정된 레코드의 비즈니스 키 |
| `old_value` | `VARCHAR` | 이전 값 JSON |
| `new_value` | `VARCHAR` | 새 값 JSON |
| `reason` | `VARCHAR` | 조정 사유 |
| `adjusted_by` | `VARCHAR` | 조정 실행자 |
| `adjusted_at` | `TIMESTAMP` | 조정 실행 시점 |

### `ops.ops_snapshot`

| 컬럼 | 타입 | 설명 |
|---|---|---|
| `snapshot_id` | `VARCHAR` | 자동 생성 식별자 (PK) |
| `run_id` | `VARCHAR` | 파이프라인 실행 식별자 |
| `snapshot_type` | `VARCHAR` | PRE_CLOSE / POST_CLOSE / ROLLBACK |
| `period_key` | `VARCHAR` | 스냅샷 대상 기간 |
| `table_name` | `VARCHAR` | 캡처된 테이블 |
| `row_count` | `INTEGER` | 스냅샷 행 수 |
| `checksum` | `VARCHAR` | 정렬된 출력의 SHA-256 |
| `created_at` | `TIMESTAMP` | 스냅샷 생성 시점 |
