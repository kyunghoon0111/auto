# 비즈니스 키

> SCM 운영 분석 DB의 기본 키 정의, 복합 키 규칙, 센티넬 값 정책.

---

## 규칙

1. **자연 키**는 소스 시스템이 안정적이고 사람이 읽을 수 있는 식별자를 제공하는 경우 대리 키보다 우선합니다.
2. **복합 키**는 컬럼 순서대로 나열되며, 센티넬 규칙이 적용되는 경우를 제외하고 모든 구성요소가 필수입니다.
3. **센티넬 값 `'__NONE__'`** -- 비즈니스 키 구성요소가 논리적으로 선택 사항인 경우 (예: 로트 추적을 하지 않는 창고의 `lot_id`), `NULL` 대신 문자열 리터럴 `'__NONE__'`으로 채웁니다. 이를 통해:
   - 복합 PK에 `NULL`이 포함되지 않으므로 표준 등호 조인이 정상 동작합니다.
   - DQ 중복 검사가 결정론적으로 유지됩니다.
   - 다운스트림 집계에서 센티넬을 명시적으로 필터링하거나 그룹핑할 수 있습니다.
4. **대소문자 구분** -- 모든 비즈니스 키 값은 원래 대소문자 그대로 저장됩니다. DQ 검사의 비교는 대소문자를 구분합니다.

---

## 테이블별 기본 키

### CORE -- 팩트 테이블

| 테이블 | PK 컬럼 | 센티넬 컬럼 | 비고 |
|---|---|---|---|
| `core.fact_order` | `order_id`, `order_line_id` | -- | OMS 발급 자연 키 |
| `core.fact_shipment` | `shipment_id`, `shipment_line_id` | -- | WMS 발급 자연 키 |
| `core.fact_return` | `return_id`, `return_line_id` | -- | OMS 발급 자연 키 |
| `core.fact_inventory_snapshot` | `snapshot_date`, `item_id`, `warehouse_id`, `lot_id` | `lot_id` | 로트 추적 미사용 시 `lot_id = '__NONE__'` |
| `core.fact_po` | `po_id`, `po_line_id` | -- | ERP 발급 자연 키 |
| `core.fact_receipt` | `receipt_id`, `receipt_line_id` | -- | WMS 발급 자연 키 |
| `core.fact_settlement` | `settlement_id`, `settlement_line_id` | -- | 3PL 인보이스 참조 |
| `core.fact_charge_actual` | `charge_id` | -- | 시스템 생성 대리 키 (UUID) |
| `core.fact_exchange_rate` | `rate_date`, `from_currency`, `to_currency` | -- | 통화 쌍 당 일일 1건 |
| `core.fact_cost_structure` | `item_id`, `cost_stage`, `period_key`, `warehouse_id` | -- | 집계 테이블; 센티넬 불필요 |

### CORE -- 차원 테이블

| 테이블 | PK 컬럼 | 비고 |
|---|---|---|
| `core.dim_item` | `item_id` | SKU 마스터; 단일 자연 키 |
| `core.dim_partner` | `partner_id` | 공급업체 / 3PL / 운송사 마스터 |
| `core.dim_channel_store` | `channel_store_id` | 판매 채널 + 스토어 조합 |
| `core.dim_warehouse` | `warehouse_id` | 창고 / DC 마스터 |
| `core.dim_uom_conversion` | `item_id`, `from_uom`, `to_uom` | 방향별 하나의 환산 계수 |
| `core.dim_charge_policy` | `charge_type` | 비용 설정 마스터 |

### OPS 테이블

| 테이블 | PK 컬럼 | 비고 |
|---|---|---|
| `ops.ops_issue_log` | `issue_id` | 시스템 생성 UUID |
| `ops.ops_period_close` | `period_key` | YYYY-MM 형식 |
| `ops.ops_adjustment_log` | `adjustment_id` | 시스템 생성 UUID |
| `ops.ops_snapshot` | `snapshot_id` | 시스템 생성 UUID |

---

## 센티넬 `'__NONE__'` -- 상세 규칙

| 테이블 | 컬럼 | 센티넬 사용 시점 |
|---|---|---|
| `core.fact_inventory_snapshot` | `lot_id` | 해당 품목에 대해 창고가 로트/배치 추적을 사용하지 않을 때 |
| `core.fact_receipt` | `lot_id` | 로트가 배정되지 않은 입고 건 |

### 왜 NULL을 사용하지 않는가?

복합 PK에 `NULL`을 사용하면 세 가지 문제가 발생합니다:

1. **JOIN 정확성** -- SQL에서 `NULL != NULL`이므로, 복합 조인 시 행이 자동으로 누락됩니다.
2. **UNIQUE 제약조건** -- DuckDB (및 대부분의 엔진)는 각 `NULL`을 별개로 취급하므로 중복 감지가 실패합니다.
3. **GROUP BY** -- `NULL` 키 구성요소가 있는 행들이 엔진별로 예측할 수 없게 그룹핑됩니다.

센티넬 `'__NONE__'`은 "해당 없음" 상태를 명시적으로 표현하는 결정론적이고 조인 및 그룹핑이 가능한 플레이스홀더입니다.

---

## 비즈니스 키 정의

| 키 | 정의 | 예시 |
|---|---|---|
| `order_id` | OMS 생성 주문 번호; 전 채널에서 고유 | `ORD-2025-0001234` |
| `order_line_id` | 주문 내 순번, 4자리 0-패딩 | `0001` |
| `shipment_id` | WMS 생성 출고 번호 | `SHP-ICN-20250115-0042` |
| `po_id` | ERP 구매 발주 번호 | `PO-2025-00567` |
| `receipt_id` | WMS 입고 번호 | `RCV-ICN-20250120-0013` |
| `settlement_id` | 3PL 인보이스 또는 정산 참조 | `INV-3PL-202501-0088` |
| `charge_id` | 배분 과정에서 생성된 시스템 UUID | `a1b2c3d4-...` |
| `item_id` | SKU에서 매핑된 내부 품목 마스터 ID | `ITEM-00012345` |
| `partner_id` | 공급업체/3PL/운송사 통합 거래처 코드 | `PTN-0042` |
| `channel_store_id` | 채널 + 스토어 코드 결합 | `SHOPIFY-KR-MAIN` |
| `warehouse_id` | 물리적 창고 / DC 사이트 코드 | `WH-ICN-01` |
| `period_key` | `YYYY-MM` 형식 월 단위 | `2025-01` |
| `lot_id` | 제조 배치 또는 로트 번호; 미추적 시 `'__NONE__'` | `LOT-20250110-A` |

---

## 외래 키 관계 (논리적)

DuckDB는 쓰기 시 외래 키를 강제하지 않지만, 파이프라인이 DQ 검사 중 참조 무결성을 검증합니다.

```
fact_order.item_id          -> dim_item.item_id
fact_order.partner_id       -> dim_partner.partner_id
fact_order.channel_store_id -> dim_channel_store.channel_store_id
fact_order.warehouse_id     -> dim_warehouse.warehouse_id

fact_shipment.order_id + order_line_id -> fact_order PK
fact_shipment.warehouse_id             -> dim_warehouse.warehouse_id

fact_return.order_id + order_line_id   -> fact_order PK
fact_return.warehouse_id               -> dim_warehouse.warehouse_id

fact_po.partner_id      -> dim_partner.partner_id
fact_po.warehouse_id    -> dim_warehouse.warehouse_id

fact_receipt.po_id + po_line_id -> fact_po PK
fact_receipt.warehouse_id       -> dim_warehouse.warehouse_id

fact_settlement.partner_id  -> dim_partner.partner_id
fact_charge_actual.item_id  -> dim_item.item_id
fact_charge_actual.warehouse_id -> dim_warehouse.warehouse_id

dim_warehouse.operator_partner_id -> dim_partner.partner_id
dim_uom_conversion.item_id        -> dim_item.item_id
```
