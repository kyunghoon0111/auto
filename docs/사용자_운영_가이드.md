# SCM 운영 분석 시스템 - 사용자 운영 가이드

> 비개발자를 위한 실무 운영 매뉴얼입니다.
> 이 문서만 읽으면 시스템을 설치하고, 데이터를 넣고, 대시보드를 확인할 수 있습니다.

---

## 목차

1. [이 시스템이 뭔가요?](#1-이-시스템이-뭔가요)
2. [최초 설치 (1회만)](#2-최초-설치-1회만)
3. [데이터 종류별 투입 가이드](#3-데이터-종류별-투입-가이드)
4. [파일 넣고 실행하는 법](#4-파일-넣고-실행하는-법)
5. [운영 시나리오별 가이드](#5-운영-시나리오별-가이드)
6. [대시보드 보기](#6-대시보드-보기)
7. [상태 확인하기](#7-상태-확인하기)
8. [월말 마감](#8-월말-마감)
9. [문제가 생겼을 때](#9-문제가-생겼을-때)
10. [자주 묻는 질문](#10-자주-묻는-질문)

---

## 1. 이 시스템이 뭔가요?

SCM(공급망) 데이터를 **하나의 데이터베이스**에 모아서 자동으로 분석해주는 시스템입니다.

**입력**: 엑셀/CSV 파일 (주문, 출고, 재고, 인보이스 등)
**출력**: 웹 대시보드 (재고현황, 손익분석, 이상 감지 등)

```
엑셀/CSV 파일  →  [자동 처리]  →  웹 대시보드
  (inbox 폴더)                    (브라우저에서 확인)
```

**할 일은 딱 2가지**:
1. `inbox/` 폴더에 파일을 넣는다
2. 명령어 하나를 실행한다

---

## 2. 최초 설치 (1회만)

### 준비물
- Python 3.10 이상 (https://www.python.org 에서 다운로드)
- 이 프로젝트 폴더

### 설치 단계

**1단계: 명령 프롬프트(터미널) 열기**
- Windows: `Win+R` → `cmd` 입력 → 확인
- 또는 프로젝트 폴더에서 주소창에 `cmd` 입력

**2단계: 프로젝트 폴더로 이동**
```
cd C:\Users\ryjkf\Desktop\새 폴더
```

**3단계: 필요 프로그램 설치** (1회만)
```
pip install -r requirements.txt
```
> 약 1~2분 소요. "Successfully installed" 메시지가 나오면 성공.

**4단계: 데이터베이스 생성** (1회만)
```
python run.py --init
```
> "Database initialized successfully" 메시지가 나오면 성공.

**이제 설치 끝!**

---

## 3. 데이터 종류별 투입 가이드

> **핵심**: 모든 데이터를 매일 넣는 게 아닙니다!
> 데이터마다 발생 주기가 다르므로, 있을 때 넣으면 됩니다.

### 매일 넣는 데이터 (일상)

이 데이터들은 매일 발생하니까, 매일 아침 넣는 게 이상적입니다.
하지만 며칠치를 모아서 한번에 넣어도 됩니다.

| 데이터 | 파일명 예시 | 어디서 받나 | 설명 |
|---|---|---|---|
| **주문** | `fact_order_20250115.csv` | 쇼핑몰 관리자, OMS | 어제 들어온 주문 목록 |
| **출고** | `fact_shipment_20250115.csv` | 3PL/물류센터, WMS | 어제 출고된 건 |
| **재고 스냅샷** | `fact_inventory_snapshot_20250115.csv` | 3PL/물류센터, WMS | 오늘 기준 창고별 재고 현황 |

> 이 3개 파일만 매일 넣으면 재고현황, 품절위험, 서비스레벨 등 핵심 대시보드가 돌아갑니다.

### 발생할 때 넣는 데이터 (수시)

이 데이터들은 매일 생기는 게 아닙니다. **해당 이벤트가 있을 때만** 넣으면 됩니다.

| 데이터 | 파일명 예시 | 언제 발생하나 | 얼마나 자주 |
|---|---|---|---|
| **구매발주** | `fact_po_20250115.csv` | 공급업체에 발주할 때 | 주 1~3회 (구매팀) |
| **입고** | `fact_receipt_20250115.csv` | 물건이 창고에 도착할 때 | 발주 도착 시마다 |
| **반품** | `fact_return_20250115.csv` | 고객 반품이 접수될 때 | 주 1~2회 (CS팀) |
| **상품 마스터** | `dim_item_20250115.xlsx` | 신상품 등록/정보 변경 시 | 월 수회 (상품기획팀) |

> 없으면 안 넣어도 됩니다. 오늘 발주가 없었으면 발주 파일을 만들 필요 없습니다.

### 월말에 넣는 데이터 (월간)

이 데이터들은 보통 한 달에 1~2번 발생합니다. **월말 마감 전에** 넣으면 됩니다.

| 데이터 | 파일명 예시 | 누가 주나 | 언제 |
|---|---|---|---|
| **정산 인보이스** | `fact_settlement_202501.csv` | 3PL/운송사가 청구서 발행 | 월 1~2회 (인보이스 받으면) |
| **비용 데이터** | `fact_charge_actual_202501.csv` | 재무팀이 정리 | 월말 마감 전 |
| **환율** | `fact_exchange_rate_202501.csv` | 재무팀/한국은행 | 월말 마감 전 |
| **비용 구조** | `fact_cost_structure_202501.csv` | 재무팀이 산출 | 월말 마감 전 |

> 이 데이터들이 없어도 일상 운영(재고/주문/출고 분석)은 정상 동작합니다.
> 단, **월말 마감** 시에는 정산/비용/환율 데이터가 있어야 손익 분석이 정확합니다.

### 한눈에 보는 요약

```
┌─────────────────────────────────────────────────┐
│           데이터 투입 타이밍                       │
├─────────────────────────────────────────────────┤
│                                                 │
│  매일 ──────  주문 / 출고 / 재고                  │
│              (물류센터/쇼핑몰에서 매일 나오는 것)    │
│                                                 │
│  수시 ──────  발주 / 입고 / 반품 / 상품마스터      │
│              (해당 이벤트가 있을 때만)              │
│                                                 │
│  월말 ──────  정산 / 비용 / 환율 / 비용구조        │
│              (월말 마감 전에 한번)                  │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 4. 파일 넣고 실행하는 법

### 4-1. 파일 이름 규칙

```
{테이블명}_{날짜}.csv  또는  {테이블명}_{날짜}.xlsx
```

> **팁**: 파일 이름을 정확히 맞추지 않아도 됩니다!
> 시스템이 파일 내용(컬럼명)을 보고 자동으로 어떤 데이터인지 판단합니다.

> **팁**: 한국어 컬럼명도 됩니다!
> 예: `주문번호` → 자동으로 `order_id`로 변환

### 4-2. 파일 넣기

준비한 파일을 `inbox/` 폴더에 복사합니다.
**Windows 탐색기**에서 드래그&드롭하면 됩니다.

```
새 폴더/
├── inbox/          ← 여기에 파일을 넣으세요!
│   ├── fact_order_20250115.csv
│   └── fact_inventory_snapshot_20250115.xlsx
```

### 4-3. 실행

명령 프롬프트에서:
```
python run.py --once
```

**실행 결과 예시:**
```
2025-01-15 09:00:01 [INFO] Pipeline started. Batch ID: 1
2025-01-15 09:00:01 [INFO] === PHASE 1: Ingestion ===
2025-01-15 09:00:02 [INFO] Ingestion complete: 2/2 files, 800 rows
...
2025-01-15 09:00:05 [INFO] Pipeline completed successfully. Batch ID: 1
```

> **2/2 files** = 2개 파일 모두 성공
> **800 rows** = 총 800행 적재

### 4-4. 실행 전 테스트 (선택)

파일이 정상인지 확인만 하고 실제로는 저장하지 않으려면:
```
python run.py --dry-run
```

---

## 5. 운영 시나리오별 가이드

### 시나리오 A: 매일 하는 일 (5분)

> 물류센터/쇼핑몰에서 매일 받는 데이터만 처리

```
1. inbox/에 오늘자 파일 넣기 (주문 + 출고 + 재고)
2. python run.py --once
3. 브라우저에서 대시보드 확인
   → http://localhost:8501 (SCM)
```

**이것만 해도 볼 수 있는 것:**
- 재고 현황 (품목별/창고별)
- 품절 위험 품목
- 과재고 품목
- 유통기한 임박 품목
- 서비스 레벨 (정시 출고율)
- 주문 추이

---

### 시나리오 B: 주간 점검 (10분)

> 주 1회 정도, 발주/입고/반품 데이터가 쌓였을 때

```
1. inbox/에 이번 주 파일 넣기
   - 주문/출고/재고 (매일 것)
   - + 구매발주 (이번 주 발주한 것)
   - + 입고 (이번 주 도착한 것)
   - + 반품 (이번 주 접수된 것)
2. python run.py --once
3. 대시보드에서 확인:
   → 입고/발주 탭: 납기 지연 여부
   → 제약/병목 탭: 공급 이슈
   → 재고 조정 탭: 움직임 대사
```

**추가로 볼 수 있는 것:**
- 발주 납기 준수율
- 공급업체별 지연 현황
- 재고 이동 대사 (기초 + 입고 - 출고 = 기말 맞는지)
- OMS vs WMS 출고 매칭

---

### 시나리오 C: 월말 마감 (30분~1시간)

> 매월 초에 전월 데이터를 확정

```
1. 재무팀에서 받기:
   - 정산 인보이스 (3PL/운송사 청구서)
   - 비용 데이터 (배분된 비용)
   - 환율 (해당 월 평균 환율)
   - 비용 구조 (품목별 단가)

2. inbox/에 위 파일 넣기

3. python run.py --once

4. 상태 확인:
   python run.py --status
   → 커버리지율이 100%인지 확인

5. 대시보드에서 손익 확인:
   → http://localhost:8502 (P&L)
   → 손익 요약: 매출 → 원가 → 마진 확인
   → 정산 검증: 인보이스 vs 배분 차이 없는지

6. 이상 없으면 마감:
   python -c "
   from src.db import get_connection
   from src.period_close import close_period
   con = get_connection()
   close_period(con, '2025-01', '담당자이름', notes='1월 마감')
   print('마감 완료!')
   con.close()
   "
```

**월말에만 볼 수 있는 것:**
- 매출/매출원가/매출총이익 (P&L 워터폴)
- 변동비/공헌이익
- 비용 배분 내역
- 정산 대사 (인보이스 vs 추정 비용)
- 환율 영향 분석

---

### 연간 운영 캘린더 예시

```
┌────────┬──────────────────────────────────────┐
│  1월   │ 매일: 주문+출고+재고                    │
│        │ 수시: 발주, 입고, 반품                  │
│        │ 월말: (없음 - 첫 달이니까)              │
├────────┼──────────────────────────────────────┤
│  2월초 │ ★ 1월 마감                             │
│        │  → 재무팀에서 1월 정산/비용/환율 받기    │
│        │  → inbox에 넣고 실행                   │
│        │  → 커버리지 100% 확인                  │
│        │  → close_period('2025-01')            │
├────────┼──────────────────────────────────────┤
│  2월   │ 매일: 주문+출고+재고                    │
│        │ 수시: 발주, 입고, 반품                  │
├────────┼──────────────────────────────────────┤
│  3월초 │ ★ 2월 마감                             │
│  ...   │ (반복)                                │
└────────┴──────────────────────────────────────┘
```

---

## 6. 대시보드 보기

### SCM 운영 대시보드 (재고, 발주, 품절 등)

```
streamlit run app/scm_app.py --server.port 8501
```

브라우저가 자동으로 열립니다. 안 열리면 주소창에 입력:
```
http://localhost:8501
```

| 탭 | 무엇을 볼 수 있나 | 필요한 데이터 |
|---|---|---|
| 재고 현황 | 품목별/창고별 현재 재고, **재고금액**, QC/차단 현황, **창고유형별 비교** | 재고 스냅샷 + 비용구조 |
| 입고/발주 | 구매발주 현황, 납기 준수율, **리드타임 분석**, ETA 정확도 | 발주 + 입고 |
| 🚚 출고 현황 | 출고 성과, **백로그(미출고)**, **주문-출고 매칭율**, 일별 추이 | 주문 + 출고 |
| 📦 반품 분석 | 반품 사유별/처분별 분석, 반품율 TOP 10, 일별 추이 | 반품 + 출고 |
| 품절 위험 | 재고 부족 품목 경고, 커버 일수 | 재고 + 주문 |
| 과재고 | 과재고 품목, **회전율**, **과재고 금액**, 저회전 품목 | 재고 + 출고 + 비용구조 |
| 유통기한 관리 | 유통기한 임박/만료 품목, **위험금액**, 버킷별 분포, FEFO | 재고 (유통기한) + 비용구조 |
| 서비스 레벨 | 정시 출고율, 주간 추이 | 주문 + 출고 |
| 제약/병목 | 공급망 병목 감지, **근본원인 분석**, **해소 효과 추적** | 전체 |
| 📋 대사/검증 | **5개 대사 통합** (수불, OMS vs WMS, ERP vs WMS, 정산, 청구) | 전체 |
| 💰 비용 시뮬레이터 | 물류비 시뮬레이션 (단가/수량 입력 → 즉시 결과) | 설정만 |

### 손익 대시보드 (매출, 비용, 마진 등)

```
streamlit run app/pnl_app.py --server.port 8502
```

```
http://localhost:8502
```

| 탭 | 무엇을 볼 수 있나 | 필요한 데이터 |
|---|---|---|
| 손익 요약 | 매출→원가→마진 워터폴 | 정산 + 비용 + 환율 |
| 매출 | **매출 분해** (총매출/할인/환불/순매출), **할인율**, 판매국가 필터, FX 커버리지 | 정산 + 환율 |
| 매출원가 | COGS 분석, **ACTUAL/PARTIAL 이중 집계**, 원가 누락 경고 | 비용구조 + 출고 |
| 매출총이익 | 마진율 분석, **ACTUAL 기준 평균 마진**, 커버리지 배지 | 매출 + 원가 |
| 변동비 | **도메인별/단계별 분해**, 물류비율, **단위비용** (건당/EA/kg/CBM), 커버리지 게이팅 | 비용 데이터 + 출고 |
| 공헌이익 | 공헌이익 및 공헌이익률, **ACTUAL 기준 집계** | 매출총이익 + 변동비 |
| 영업이익 | **영업이익 (신규)**, 고정비 입력 상태, 영업이익률, 커버리지 | 공헌이익 |
| 수익성 순위 | **TOP/BOTTOM 10 (신규)** — 상품별/채널별, PARTIAL 행 (추정) 표시 | 공헌이익 |
| 비용 배분 | 비용 배분 내역, 도메인별/단계별 차트 | 비용 데이터 |
| 정산 검증 | 인보이스 vs 배분 대사, **delta/|delta|/차이율** | 정산 + 비용 |
| 커버리지 | **트래픽 라이트** (🟢🟡🔴), FX 커버리지, **P&L 마트 coverage_flag 요약** | 전체 |

> **대시보드 종료**: 터미널에서 `Ctrl+C`

> **두 대시보드 동시에 보기**: 터미널 창을 2개 열어서 각각 실행

---

## 7. 상태 확인하기

```
python run.py --status
```

**출력 예시:**
```
============================================================
SCM Analytics Pipeline Status
============================================================

Last Batch:
  ID: 5
  Started: 2025-01-15 09:00:01
  Status: success
  Files: 3
  Rows: 1500

Lock: unlocked

Table Row Counts:
  core.fact_order: 500
  core.fact_shipment: 300
  core.fact_inventory_snapshot: 700

Recent DQ Issues:
  No DQ issues found.

Coverage Summary:
  All domains covered or no data yet.
============================================================
```

---

## 8. 월말 마감

위 [시나리오 C: 월말 마감](#시나리오-c-월말-마감-30분1시간) 참조.

요약:
1. 재무팀에서 정산/비용/환율/비용구조 파일 받기
2. `inbox/`에 넣고 `python run.py --once`
3. `python run.py --status`로 커버리지 100% 확인
4. `close_period()` 실행

> 마감 후에는 해당 월 데이터를 직접 수정할 수 없습니다.
> 수정이 필요하면 조정(adjustment) 절차를 따릅니다.

---

## 9. 문제가 생겼을 때

### "Pipeline is locked" 오류

이전 실행이 비정상 종료된 경우입니다.
```
python run.py --unlock
```

### 파일이 실패했을 때

`python run.py --status`로 DQ 이슈를 확인하세요.

| 원인 | 해결 방법 |
|---|---|
| 필수 컬럼 누락 | 파일에 필수 컬럼이 있는지 확인 |
| 비즈니스 키에 빈 값 | 빈 셀을 채우거나 제거 |
| 같은 키 중복 | 중복 행 제거 |
| 알 수 없는 비용 유형 | charge_policy.yaml에 비용 유형 추가 |

### 잘못된 데이터를 넣었을 때

최근 데이터 적재를 되돌리려면:
```
python run.py --rollback 1
```

### 대시보드가 안 열릴 때

1. `data/scm.duckdb` 파일이 존재하는지 확인
2. 없으면: `python run.py --init`
3. 데이터를 넣고: `python run.py --once`
4. 대시보드 재실행

---

## 10. 자주 묻는 질문

### Q: 엑셀 파일의 컬럼명이 한국어여도 되나요?
**A: 네!** `주문번호` → `order_id`, `상품코드` → `item_id` 등 자동 변환됩니다.

### Q: 같은 파일을 두 번 넣으면 어떻게 되나요?
**A:** 동일 파일은 자동으로 건너뜁니다. 내용이 수정된 파일은 기존 데이터를 최신 버전으로 덮어씁니다.

### Q: 없는 데이터는 안 넣어도 되나요?
**A: 네!** 오늘 발주가 없었으면 발주 파일을 안 넣어도 됩니다. 반품이 없으면 반품 파일도 불필요합니다. 시스템은 **있는 데이터만으로** 분석합니다. 단, 월말 마감 시에는 정산/비용/환율 데이터가 있어야 손익 보고서가 정확합니다.

### Q: 파일을 며칠치 모아서 한번에 넣어도 되나요?
**A: 네!** 월요일~금요일 5일치 파일을 금요일에 한꺼번에 넣어도 됩니다. `inbox/`에 여러 파일을 넣고 `python run.py --once` 한 번 실행하면 모두 처리됩니다.

### Q: 매일 안 넣으면 대시보드에 빈칸이 생기나요?
**A:** 대시보드는 **있는 데이터를 기준으로** 보여줍니다. 데이터가 없는 날은 빈칸이지만, 이전에 넣은 데이터는 그대로 유지됩니다. 나중에 해당 날짜 데이터를 넣으면 자동으로 채워집니다.

### Q: 파일 형식은 뭐가 좋나요?
**A:** CSV와 XLSX 모두 지원합니다. CSV가 약간 빠르지만 XLSX도 문제없습니다.

### Q: 대시보드를 다른 사람도 볼 수 있나요?
**A:** 같은 네트워크에 있다면 `http://{내 PC IP}:8501`로 접속 가능합니다. PC IP는 `ipconfig` 명령으로 확인.

### Q: 데이터가 얼마나 쌓여도 괜찮나요?
**A:** 수백만 행까지 문제없습니다. 일반적인 중소기업 SCM 데이터라면 수년치도 OK.

### Q: 3PL에서 주는 파일 형식이 다른데요?
**A:** `config/column_aliases.yaml`에 3PL이 쓰는 컬럼명을 추가하면 됩니다. 예를 들어 3PL이 `출고번호`라는 컬럼명을 쓴다면, `shipment_id` 별칭에 `출고번호`를 추가하면 자동 인식됩니다.

---

## 한눈에 보는 명령어 요약

| 상황 | 명령어 |
|---|---|
| **최초 설치** (1회) | `pip install -r requirements.txt` |
| **DB 생성** (1회) | `python run.py --init` |
| **데이터 처리** | `python run.py --once` |
| **테스트 실행** | `python run.py --dry-run` |
| **상태 확인** | `python run.py --status` |
| **잠금 해제** | `python run.py --unlock` |
| **되돌리기** | `python run.py --rollback 1` |
| **SCM 대시보드** | `streamlit run app/scm_app.py --server.port 8501` |
| **손익 대시보드** | `streamlit run app/pnl_app.py --server.port 8502` |
