# 배분 규칙

> 비용 배분 알고리즘, 기준 우선순위, 보존 보장, 반올림, 결정론.

---

## 개요

배분 엔진은 집계된 비용 (예: 단일 3PL 창고 인보이스)을 개별 품목 및 거래에 분배합니다. 알고리즘은 다음을 충족해야 합니다:

- **보존성**: 배분된 금액의 합이 원래 총액과 정확히 일치 (1원도 누락이나 초과 없음).
- **결정론**: 동일한 입력은 행 순서와 관계없이 항상 동일한 출력을 생성.
- **감사 가능성**: 모든 배분된 비용이 원본 인보이스와 사용된 기준까지 추적 가능.

---

## 알고리즘: 헤어-니마이어 (최대 잔여수 방식)

헤어-니마이어 방식은 반올림 적용 시 정수 수준의 보존을 보장하기 위해 단순 비례 배분 대신 사용됩니다.

### 단계

1. **각 수령 라인의 몫 계산**:
   ```
   quota_i = total_amount * (basis_i / sum_of_all_basis)
   ```

2. **각 몫의 정수 부분 (내림) 취함**:
   ```
   floor_i = FLOOR(quota_i, decimal_places)
   ```
   `decimal_places`는 반올림 정책에 따라 결정 (기본: 정수 통화는 0, 소수 통화는 2).

3. **각 라인의 잔여수 계산**:
   ```
   remainder_i = quota_i - floor_i
   ```

4. **잔여 단위를 잔여수가 가장 큰 라인에 하나씩 분배**, 배분 금액 합이 `total_amount`와 정확히 일치할 때까지.

5. **동점 처리**: 두 개 이상의 라인이 동일한 잔여수를 가질 때, 결정론 정렬 키가 어느 라인이 추가 단위를 먼저 받을지 결정 (아래 참조).

### 의사 코드

```python
def allocate_hare_niemeyer(total_amount, lines, basis_col, sort_keys, decimals=0):
    basis_sum = sum(line[basis_col] for line in lines)
    for line in lines:
        line['quota'] = total_amount * (line[basis_col] / basis_sum)
        line['allocated'] = floor_to(line['quota'], decimals)

    leftover = total_amount - sum(line['allocated'] for line in lines)
    unit = Decimal(10) ** -decimals  # 배분 가능한 최소 단위

    # 잔여수 내림차순, 결정론 키 오름차순으로 정렬
    ranked = sorted(lines,
                    key=lambda l: (-remainder(l), *[l[k] for k in sort_keys]))

    idx = 0
    while leftover >= unit:
        ranked[idx]['allocated'] += unit
        leftover -= unit
        idx += 1

    return lines
```

---

## 비용 단계별 기준 우선순위

각 `cost_stage`에는 기본 배분 기준이 있습니다. 기준은 총 비용을 수령 라인에 어떻게 분배할지 결정합니다.

| 비용 단계 | 주 기준 | 대안 기준 | 설명 |
|---|---|---|---|
| `INBOUND` | `QTY` (입고 수량) | `WEIGHT` | 입고 단위 기준 분배; 수량 없으면 중량으로 대체 |
| `STORAGE` | `QTY` (평균 일일 재고) | `VOLUME` | 기간 중 평균 보유 재고 기준 분배 |
| `OUTBOUND` | `QTY` (출고 수량) | `WEIGHT` | 출고 단위 기준 분배 |
| `RETURN` | `QTY` (반품 수량) | `FLAT` (균등 분배) | 반품 물량 기준 분배 |
| `CUSTOMS` | `WEIGHT` | `QTY` | 관세 비용은 통상 중량에 비례; 수량으로 대체 |

기준 해석 순서:

1. 특정 `charge_type`에 대한 `dim_charge_policy.allocation_basis` 확인.
2. `NULL`이거나 미설정이면, `cost_stage`의 주 기준 사용.
3. 주 기준 데이터가 해당 라인에 없으면, 대안 기준 사용.
4. 대안 기준도 없으면, `HIGH` 심각도 DQ 이슈를 발생시키고 해당 라인 건너뜀.

---

## 보존 보장

배분 후 다음 불변 조건이 반드시 성립해야 합니다:

```
SUM(allocated_amount) == original_total_amount
```

이는 배분 후 DQ 검사로 검증됩니다. 위반 시:

- 심각도: `CRITICAL`
- 파이프라인이 중단되고 차이를 `ops.ops_issue_log`에 기록.
- 부분 결과는 `core.fact_charge_actual`에 기록되지 않음.

보존은 **인보이스 라인 단위**로 적용됩니다: 각 정산 라인의 금액이 배분된 비용으로 완전히 분해되어야 합니다.

---

## 반올림 정책

| 매개변수 | 값 |
|---|---|
| 반올림 방식 | `HALF_UP` (표준 상업 반올림) |
| 소수점 자릿수 -- 정수 통화 (JPY, KRW) | `0` |
| 소수점 자릿수 -- 소수 통화 (USD, EUR 등) | `2` |
| 배분 가능 최소 단위 | `10^(-decimals)` (예: USD는 0.01, KRW은 1) |

반올림은 헤어-니마이어의 내림 단계에서 적용됩니다. 잔여수 분배 단계에서 최소 단위 정수를 추가하여 총액을 복원합니다.

### HALF_UP 의미

```
ROUND(2.5)  = 3
ROUND(3.5)  = 4
ROUND(-1.5) = -2
```

이는 Python의 `decimal.ROUND_HALF_UP`과 대부분의 회계 관례에 부합합니다.

---

## 결정론 정렬 키

재현 가능한 동점 처리를 보장하기 위해, 잔여수 분배 단계 전에 라인을 다음 복합 키로 정렬합니다:

| 우선순위 | 컬럼 | 방향 | 근거 |
|---|---|---|---|
| 1 | `remainder` | 내림차순 | 잔여수가 가장 큰 라인이 추가 단위를 먼저 받음 |
| 2 | `item_id` | 오름차순 | 재현성을 위한 알파벳 순 |
| 3 | `warehouse_id` | 오름차순 | 다중 창고 비용에 대한 보조 정렬 |
| 4 | `reference_id` | 오름차순 | 다중 거래 비용에 대한 3차 정렬 |

이를 통해:

- 동일 입력 데이터에 대해 **매번 동일한 결과** 보장.
- **데이터베이스 행 순서**나 해시 기반 정렬에 의존하지 않음.
- **감사자가** 동일한 키로 정렬하여 스프레드시트에서 배분을 **재현** 가능.

---

## 계산 예시

인보이스 `INV-3PL-202501-0088`, 비용 유형 `STORAGE_FEE`, 총액 = **1,000 KRW** (소수점 0자리).

| 라인 | item_id | avg_daily_qty (기준) | 몫 | 내림 | 잔여수 | 최종 배분 |
|---|---|---|---|---|---|---|
| A | ITEM-001 | 50 | 500.00 | 500 | 0.00 | **500** |
| B | ITEM-002 | 33 | 330.00 | 330 | 0.00 | **330** |
| C | ITEM-003 | 17 | 170.00 | 170 | 0.00 | **170** |
| **합계** | | **100** | **1000.00** | **1000** | | **1000** |

몫이 비정수인 경우:

| 라인 | item_id | avg_daily_qty | 몫 | 내림 | 잔여수 | 추가 | 최종 |
|---|---|---|---|---|---|---|---|
| A | ITEM-001 | 50 | 333.33 | 333 | 0.33 | +1 | **334** |
| B | ITEM-002 | 30 | 200.00 | 200 | 0.00 | -- | **200** |
| C | ITEM-003 | 20 | 133.33 | 133 | 0.33 | -- | **133** |
| D | ITEM-004 | 50 | 333.33 | 333 | 0.33 | -- | **333** |
| **합계** | | **150** | **1000.00** | **999** | | | **1000** |

라인 A와 D의 잔여수가 동일 (0.33). 동점 처리: 알파벳 순으로 `ITEM-001 < ITEM-004`이므로 A가 추가 단위를 받음. 보존: 334 + 200 + 133 + 333 = 1000.
