# 커버리지 정책

> 도메인 커버리지 프레임워크, REQUIRED vs. OPTIONAL 분류, 마감 기간 강화, 커버리지율 산출.

---

## 개요

커버리지 정책은 시스템이 신뢰할 수 있는 분석을 생성하기 위해 어떤 데이터 도메인이 존재해야 하는지를 정의합니다. 정상 운영 중 항상 필수인 데이터와, 선택 사항이지만 기간 마감 시 필수가 될 수 있는 데이터를 구분합니다.

커버리지는 **도메인 수준** (관련 테이블의 논리적 그룹)에서 추적되며, **기간 수준** (하나의 YYYY-MM 월)에서 평가됩니다. 시스템은 누락된 비용을 0으로 묵시적 가정하지 않으며, 누락된 데이터를 항상 표면화합니다.

---

## 도메인 커버리지 프레임워크

**도메인**은 비즈니스 역량을 나타내는 하나 이상의 core 테이블의 논리적 그룹입니다. 각 도메인은 다음을 가집니다:

- 도메인을 구성하는 테이블 목록.
- 테이블별 **요구 수준**: `REQUIRED` 또는 `OPTIONAL`.
- 기간 마감 시 요구 수준이 강화되는지 여부를 나타내는 플래그.

### 도메인 정의

| 도메인 | 테이블 | 설명 |
|---|---|---|
| `order_management` | `fact_order`, `dim_channel_store` | 판매 주문 및 채널 마스터 |
| `fulfillment` | `fact_shipment` | 창고 출고 확인 |
| `returns` | `fact_return` | 고객 반품 |
| `inventory` | `fact_inventory_snapshot`, `dim_warehouse` | 일일 재고 현황 |
| `procurement` | `fact_po`, `fact_receipt`, `dim_partner` | 구매 발주 및 입고 |
| `item_master` | `dim_item`, `dim_uom_conversion` | 상품 마스터 및 단위 환산 |
| `settlement` | `fact_settlement`, `dim_charge_policy` | 3PL/운송사 인보이스 및 단가표 |
| `cost_allocation` | `fact_charge_actual`, `fact_cost_structure` | 배분된 비용 및 비용 요약 |
| `fx_rates` | `fact_exchange_rate` | 일일 환율 |

---

## REQUIRED vs. OPTIONAL

### REQUIRED

- 평가 대상 기간에 해당 테이블에 **최소 1행**이 있어야 합니다.
- REQUIRED 테이블이 특정 기간에 비어 있으면 커버리지 검사가 실패합니다.
- REQUIRED 테이블은 비어 있으면 기간 마감을 차단합니다 (`force=True` 사용 시 제외).

### OPTIONAL

- 해당 기간에 테이블이 비어 있어도 운영을 차단하지 않습니다.
- 비어 있는 선택 테이블은 정보성 경고를 생성하지만 DQ 검사를 실패시키지 않습니다.
- 기간 마감 시, 일부 OPTIONAL 테이블은 REQUIRED로 승격됩니다 (아래 참조).

### 테이블별 요구 수준

| 도메인 | 테이블 | 일반 요구 수준 | 마감 시 요구 수준 |
|---|---|---|---|
| `order_management` | `fact_order` | REQUIRED | REQUIRED |
| `order_management` | `dim_channel_store` | REQUIRED | REQUIRED |
| `fulfillment` | `fact_shipment` | REQUIRED | REQUIRED |
| `returns` | `fact_return` | OPTIONAL | OPTIONAL |
| `inventory` | `fact_inventory_snapshot` | REQUIRED | REQUIRED |
| `inventory` | `dim_warehouse` | REQUIRED | REQUIRED |
| `procurement` | `fact_po` | REQUIRED | REQUIRED |
| `procurement` | `fact_receipt` | REQUIRED | REQUIRED |
| `procurement` | `dim_partner` | REQUIRED | REQUIRED |
| `item_master` | `dim_item` | REQUIRED | REQUIRED |
| `item_master` | `dim_uom_conversion` | OPTIONAL | OPTIONAL |
| `settlement` | `fact_settlement` | OPTIONAL | **REQUIRED** |
| `settlement` | `dim_charge_policy` | REQUIRED | REQUIRED |
| `cost_allocation` | `fact_charge_actual` | OPTIONAL | **REQUIRED** |
| `cost_allocation` | `fact_cost_structure` | OPTIONAL | **REQUIRED** |
| `fx_rates` | `fact_exchange_rate` | OPTIONAL | **REQUIRED** |

**마감 시 REQUIRED**로 표시된 (일반 시 OPTIONAL) 테이블이 강조되어 있습니다. 이것이 마감 기간 강화에서 승격되는 테이블입니다.

---

## 마감 기간 강화

`close_period()`가 호출되면 커버리지 검사가 강화된 요구사항으로 실행됩니다:

1. 모든 일반 REQUIRED 테이블에 해당 기간의 데이터가 있어야 합니다.
2. `close_period_enforcement: true`인 도메인의 테이블은 OPTIONAL에서 REQUIRED로 승격됩니다.
3. 승격된 테이블 중 비어 있는 것이 있으면 `close_period()`가 누락 테이블 목록을 포함한 `ValueError`를 발생시킵니다.

### 왜 마감 시 강화하는가?

| 테이블 | 승격 근거 |
|---|---|
| `fact_settlement` | 정확한 P&L 및 정산 대사에 실제 인보이스 금액 필요 |
| `fact_charge_actual` | 단위 비용 및 마진 분석에 배분된 비용 필수 |
| `fact_cost_structure` | 매출총이익 보고에 완전한 COGS 필요 |
| `fact_exchange_rate` | 다중 통화 비용 통합에 환율 필요 |

### 설정

`config/policies/coverage_policy.yaml`에서:

```yaml
domains:
  order_management:
    close_period_enforcement: true
    tables:
      - table: fact_order
        requirement: REQUIRED
      - table: dim_channel_store
        requirement: REQUIRED

  fulfillment:
    close_period_enforcement: true
    tables:
      - table: fact_shipment
        requirement: REQUIRED

  returns:
    close_period_enforcement: false
    tables:
      - table: fact_return
        requirement: OPTIONAL

  inventory:
    close_period_enforcement: true
    tables:
      - table: fact_inventory_snapshot
        requirement: REQUIRED
      - table: dim_warehouse
        requirement: REQUIRED

  procurement:
    close_period_enforcement: true
    tables:
      - table: fact_po
        requirement: REQUIRED
      - table: fact_receipt
        requirement: REQUIRED
      - table: dim_partner
        requirement: REQUIRED

  item_master:
    close_period_enforcement: true
    tables:
      - table: dim_item
        requirement: REQUIRED
      - table: dim_uom_conversion
        requirement: OPTIONAL

  settlement:
    close_period_enforcement: true
    tables:
      - table: fact_settlement
        requirement: OPTIONAL       # 마감 시 REQUIRED로 승격
      - table: dim_charge_policy
        requirement: REQUIRED

  cost_allocation:
    close_period_enforcement: true
    tables:
      - table: fact_charge_actual
        requirement: OPTIONAL       # 마감 시 REQUIRED로 승격
      - table: fact_cost_structure
        requirement: OPTIONAL       # 마감 시 REQUIRED로 승격

  fx_rates:
    close_period_enforcement: true
    tables:
      - table: fact_exchange_rate
        requirement: OPTIONAL       # 마감 시 REQUIRED로 승격
```

### 강화 로직

```python
def check_coverage(con, period_key, is_close=False):
    missing = []
    for domain in coverage_config['domains'].values():
        for table_def in domain['tables']:
            requirement = table_def['requirement']
            # 마감 시 도메인이 강화하면 OPTIONAL -> REQUIRED 승격
            if is_close and domain['close_period_enforcement']:
                requirement = 'REQUIRED'
            if requirement == 'REQUIRED':
                row_count = count_rows(con, table_def['table'], period_key)
                if row_count == 0:
                    missing.append(table_def['table'])
    return missing  # 빈 리스트 = 통과
```

---

## 커버리지율 산출

커버리지율은 현재 강화 모드에서 REQUIRED 테이블 중 해당 기간에 최소 1행이 있는 비율입니다.

### 산식

```
coverage_rate = (데이터가_있는_테이블 / 전체_필수_테이블) * 100
```

여기서:
- `데이터가_있는_테이블` = 해당 기간에 `row_count > 0`인 REQUIRED 테이블 수.
- `전체_필수_테이블` = REQUIRED로 분류된 모든 테이블 수 (마감 시 승격 포함).

### 심각도 매핑

| 커버리지율 | 심각도 | 조치 |
|---|---|---|
| 100% | `OK` | 모든 필수 데이터 존재 |
| >= 80% 이고 < 100%, REQUIRED 도메인 누락 | `CRITICAL` | 기간 마감 차단; 누락 데이터 조사 |
| >= 80% 이고 < 100%, OPTIONAL 도메인 누락 | `INFO` | 정보성; 분석이 불완전할 수 있음 |
| < 80% | `CRITICAL` | 주요 데이터 공백; 소스 피드 조사 |

### 예시

**정상 운영** (REQUIRED 테이블 10개):

| 시나리오 | 데이터 있는 테이블 | 커버리지율 |
|---|---|---|
| 모든 필수 테이블에 데이터 있음 | 10 / 10 | 100% |
| 필수 테이블 1개 누락 | 9 / 10 | 90% |
| 필수 테이블 2개 누락 | 8 / 10 | 80% |

**기간 마감 시** (승격 후 REQUIRED 테이블 14개):

| 시나리오 | 데이터 있는 테이블 | 커버리지율 |
|---|---|---|
| 모든 테이블에 데이터 있음 | 14 / 14 | 100% |
| 정산 누락 | 13 / 14 | 92.9% |
| 정산 + 환율 누락 | 12 / 14 | 85.7% |

### 커버리지율 저장 위치

- `python run.py --status` 출력에 표시.
- 기간 마감 시 `ops.ops_period_close.notes`에 JSON 필드로 저장.
- Streamlit 대시보드의 "데이터 커버리지" 패널에 표시.
- `mart.mart_coverage_period`에 이력으로 추적 (컬럼: `period`, `domain`, `coverage_rate`, `included_rows`, `missing_rows`, `severity`, `is_closed_period`).

---

## P&L 마트 행 수준 coverage_flag (신규)

> 기존 도메인 커버리지(테이블 단위)와 별도로, P&L 마트는 **행 수준** coverage_flag를 추적합니다.

### 개요

6개 P&L 마트 테이블에 `coverage_flag VARCHAR` 컬럼이 추가되었습니다:
- `mart.mart_pnl_revenue`
- `mart.mart_pnl_cogs`
- `mart.mart_pnl_gross_margin`
- `mart.mart_pnl_contribution`
- `mart.mart_pnl_operating_profit`

(`mart.mart_pnl_variable_cost`, `mart.mart_pnl_waterfall_summary`는 대상 외)

### 값 정의

| 값 | 의미 | 예시 |
|---|---|---|
| `'ACTUAL'` | 해당 행의 모든 상위 데이터가 확인됨 | KRW 매출 + 원가 마스터 존재 |
| `'PARTIAL'` | 하나 이상의 상위 데이터 누락 | 비-KRW 환율 누락, 원가 미등록 |
| `NULL` | 마이그레이션 이전 데이터 | **PARTIAL로 취급** (안전 기본값) |

### 전파 규칙

P&L 워터폴 체인을 따라 coverage_flag가 전파됩니다:

```
매출(revenue) ──┐
                ├── 매출총이익(gross_margin) ── 공헌이익(contribution) ── 영업이익(operating_profit)
매출원가(COGS) ─┘
```

**규칙**: 상위 마트 중 **하나라도** `ACTUAL`이 아니면 하위 마트의 coverage_flag = `PARTIAL`

```sql
-- 예: 매출총이익 coverage_flag 산출
CASE WHEN COALESCE(revenue.coverage_flag, 'PARTIAL') = 'ACTUAL'
      AND COALESCE(cogs.coverage_flag, 'PARTIAL') = 'ACTUAL'
     THEN 'ACTUAL'
     ELSE 'PARTIAL'
END as coverage_flag
```

### 원인별 PARTIAL 사유

| 원인 | 영향 마트 | PARTIAL 내용 |
|---|---|---|
| FX 환율 누락 (비-KRW) | 매출 → 매출총이익 → ... | KRW 금액 = NULL |
| 원가 마스터 미등록 | COGS → 매출총이익 → ... | cogs_krw = NULL |
| coverage_flag IS NULL | 모든 하위 마트 | 마이그레이션 미적용 행 |

### 대시보드 활용

대시보드에서는 `_coverage_agg_sql()` 헬퍼로 이중 집계합니다:

| 집계 | SQL | 용도 |
|---|---|---|
| `known_sum` | `SUM(CASE WHEN coverage_flag='ACTUAL' THEN metric END)` | 확인된 금액만 |
| `total_sum_min` | `SUM(COALESCE(metric, 0))` | 누락=0 가정 최소값 |
| `actual_count` | `SUM(CASE WHEN flag='ACTUAL' THEN 1 ELSE 0 END)` | ACTUAL 행 수 |
| `partial_count` | `SUM(CASE WHEN flag IS NULL OR flag<>'ACTUAL' THEN 1 ELSE 0 END)` | 누락 행 수 |

> ⚠️ `known_sum`의 CASE에는 **ELSE 0이 없습니다**. NULL 행은 SUM에서 자동 제외됩니다.

### 스키마 가드

대시보드 시작 시 필수 테이블/컬럼 존재를 확인합니다:
- 누락 시: `st.error()` + `st.stop()` (무시하고 계속 진행하지 않음)
- coverage_flag 컬럼 유무: `information_schema.columns` 조회로 동적 확인

---

## 새 도메인 추가

도메인 유형에 따라 추가 절차가 다릅니다.

### A. 비용 기반 도메인 (charge_policy.yaml 연동, 자동 포함)

`charge_policy.yaml`에 새 `charge_domain`을 가진 비용 유형을 추가하면
커버리지 검사가 **자동으로 포함**됩니다. `coverage_policy.yaml` 수정 불필요.

```yaml
# config/policies/charge_policy.yaml
charge_types:
  COLD_CHAIN_SURCHARGE:
    charge_domain: cold_chain   # 새 도메인 — 커버리지에 자동 반영
    cost_stage: outbound
    capitalizable_flag: false
    default_allocation_basis: weight
    severity_if_missing: warn
```

다음 파이프라인 실행 시 `cold_chain` 도메인의 `fact_charge_actual` 커버리지가
자동 생성됩니다.

### B. 비-비용 도메인 (직접 설정 필요)

`fx_rate`, `revenue_settlement`, `cost_structure`처럼 `fact_charge_actual`이 아닌
별도 테이블을 조회하는 도메인은 두 단계가 필요합니다:

1. `config/policies/coverage_policy.yaml`에 도메인 추가:

```yaml
domains:
  new_data_source:
    requirement: OPTIONAL
```

2. `src/coverage.py`의 `_build_domain_queries()` 정적 쿼리 블록에 항목 추가:

```python
"new_data_source": {
    "query": "SELECT period, COUNT(*) as cnt FROM core.fact_new_source GROUP BY period",
    "min_rows": 1,
},
```

3. `python run.py --init`을 실행하여 새 테이블 생성.

---

## 대시보드 시각화

Streamlit 대시보드는 커버리지를 기간 x 도메인 매트릭스로 표시합니다:

| 도메인 | 2025년 1월 | 2025년 2월 | 2025년 3월 |
|---|---|---|---|
| order_management | 100% | 100% | 100% |
| fulfillment | 100% | 100% | 100% |
| returns | -- | -- | -- |
| inventory | 100% | 100% | 100% |
| procurement | 100% | 100% | 90% |
| settlement | 100% | 80% | -- |
| cost_allocation | 100% | 100% | -- |
| fx_rates | 100% | 100% | -- |
| **전체** | **100%** | **97%** | **85%** |

색상 코딩: 초록 (100%), 노랑 (>= 80%), 빨강 (< 80%), 회색 (데이터 없는 OPTIONAL 도메인).
