# 운영 매뉴얼

> SCM 운영 분석 파이프라인의 설치, 실행, 문제 해결 방법.

---

## 사전 요구사항

```bash
python >= 3.10
pip install -r requirements.txt
```

핵심 의존성: `duckdb`, `polars`, `streamlit`, `pyyaml`, `openpyxl`.

---

## CLI 레퍼런스

모든 작업은 `run.py`를 통해 실행됩니다.

### `--init` -- 데이터베이스 초기화

```bash
python run.py --init
```

**동작 내용:**

1. `data/scm.duckdb` 경로에 DuckDB 데이터베이스 파일을 생성 (또는 확인).
2. 4개 스키마 생성: `raw`, `core`, `mart`, `ops`.
3. 올바른 컬럼 타입과 제약조건으로 모든 테이블 생성.
4. `config/policies/charge_policy.yaml`에서 `core.dim_charge_policy`에 시드 데이터 적재.
5. 설정이 제공된 경우 `core.dim_uom_conversion`에 시드 데이터 적재.
6. 현재 월에 대해 OPEN 항목으로 `ops.ops_period_close` 초기화.

**실행 시점:** 최초 설정 시 1회, 또는 스키마 마이그레이션 후.

**멱등성:** 예. 기존 데이터베이스에서 `--init`을 실행해도 데이터가 삭제되지 않으며, 누락된 테이블만 생성합니다.

---

### `--once` -- 전체 파이프라인 실행

```bash
python run.py --once
```

**동작 내용:**

1. **배치 잠금 획득** -- 한 번에 하나의 파이프라인 인스턴스만 실행되도록 보장.
2. **`inbox/` 스캔** -- CSV 및 XLSX 파일을 알파벳 순으로 정렬하여 탐색.
3. **각 파일에 대해:**
   - 파일명 규칙으로 대상 테이블 감지 (예: `fact_order_20250115.csv`).
   - `config/column_aliases.yaml`에서 컬럼 별칭 매핑 적용.
   - 모든 DQ 검사 실행 ([데이터품질_규칙.md](./데이터품질_규칙.md) 참조).
   - DQ 통과 시: 해당 `raw.*` 및 `core.*` 테이블에 upsert.
   - DQ 실패 시: `ops.ops_issue_log`에 기록, 파일 건너뜀.
   - 처리된 파일을 `inbox/processed/` 또는 `inbox/failed/`로 이동.
4. **모든 마트를 의존성 순서로 구축:**
   - SCM 마트 (재고, 주문, 출고, 반품, 발주/입고)
   - 배분 엔진 (헤어-니마이어 비용 배분)
   - P&L 마트 (비용 구조, 마진 분석)
   - 대사 마트 (5개 대사 테이블)
   - 제약 대시보드
   - 커버리지 산출
5. **배치 잠금 해제.**
6. **요약 출력**: 처리된 파일, 실패한 파일, DQ 이슈, 마트 행 수.

**일반 실행 시간:** 데이터 양에 따라 10~60초.

---

### `--dry-run` -- 드라이 런 (비저장)

```bash
python run.py --dry-run
```

**동작 내용:**

- `--once`와 동일한 파이프라인을 실행하되 DuckDB 트랜잭션 내에서 실행 후 최종 롤백.
- DQ 검사 실행 후 결과를 표준 출력에 출력.
- 데이터베이스에 데이터가 기록되지 않음.
- `inbox/`의 파일이 이동되지 않음.

**사용 사례:** 커밋 전 새 데이터 파일 검증, 또는 설정 변경 테스트.

---

### `--status` -- 시스템 상태 확인

```bash
python run.py --status
```

**출력 내용:**

| 섹션 | 상세 |
|---|---|
| **데이터베이스** | 파일 경로, 크기, 최종 수정 시각 |
| **잠금** | 현재 잠금 상태 (잠금/해제), 잠금 보유자, 잠금 시각 |
| **최근 배치** | 실행 ID, 타임스탬프, 처리 파일 수, 실패 파일 수 |
| **테이블 행 수** | raw/core/mart/ops의 모든 테이블 행 수 |
| **DQ 이슈** | 심각도별 미해결 이슈 수 |
| **기간 상태** | 각 기간의 OPEN/CLOSED/LOCKED 상태 |
| **커버리지** | 현재 기간의 커버리지율 |

---

### `--unlock` -- 강제 잠금 해제

```bash
python run.py --unlock
```

**동작 내용:**

- 이전 실행이 잠금을 해제하지 못하고 비정상 종료된 경우 배치 잠금을 강제 해제.
- `--unlock`이 기간 작업과 함께 사용된 경우 가장 최근에 마감된 기간도 재개.

**사용 시점:** 다른 파이프라인 인스턴스가 실행 중이지 않음을 확인한 후에만.

**안전성:** 해제 전 잠금 메타데이터 (잠금자, 시각)를 출력하고, 대화형 터미널에서는 확인을 요청합니다.

---

### `--rollback N` -- 최근 N개 배치 롤백

```bash
python run.py --rollback 2
```

**동작 내용:**

1. 최근 `N`개 배치 실행 ID 식별.
2. 해당 배치로 적재된 모든 `raw.*` 및 `core.*` 행 삭제 (`_loaded_at` 범위 사용).
3. 나머지 core 데이터로 모든 마트 테이블 재구축.
4. 롤백 작업을 `ops.ops_adjustment_log`에 기록.

**사용 시점:** DQ 검사를 통과했지만 부정확한 것으로 확인된 데이터가 배치에 포함된 경우.

**비가역적:** 롤백된 데이터는 소스 파일에서 다시 수집해야 합니다.

---

## Streamlit 대시보드 명령

### SCM 운영 대시보드

```bash
streamlit run app/scm_app.py --server.port 8501
```

페이지: 재고현황(**재고금액/QC/창고유형**), 입고/발주(**리드타임**), 출고(**백로그/매칭율**), 반품, 품절, 과재고(**회전율/금액**), 유통기한(**위험금액**), 서비스레벨, 제약/병목(**근본원인/효과**), **대사/검증 센터(통합)**, 비용 시뮬레이터.

### P&L / 재무 대시보드

```bash
streamlit run app/pnl_app.py --server.port 8502
```

페이지: 손익 요약, 매출 분해, 매출원가, 매출총이익, 변동비 상세, 공헌이익, **영업이익 (신규)**, **수익성 순위 (신규)**, 비용 배분, 정산 검증, **커버리지 트래픽 라이트**.

> **주의 (v2025.06 변경사항):**
> - FX 환율 누락 시 KRW 값 = NULL + coverage_flag = PARTIAL (이전: 1.0 폴백)
> - 원가 누락 시 COGS = NULL (이전: 0 채우기)
> - 대시보드 시작 시 필수 컬럼 검증 → 누락 시 오류 표시 + 중단

### 공통 Streamlit 옵션

```bash
# 사용자 지정 데이터베이스 경로
streamlit run app/scm_app.py -- --db-path /path/to/scm.duckdb

# 자동 새로고침 비활성화
streamlit run app/scm_app.py --server.runOnSave false
```

---

## 테스트 실행

```bash
pytest -q -p no:cacheprovider
```

테스트 카테고리:

| 디렉토리 | 테스트 내용 |
|---|---|
| `tests/unit/` | 개별 함수: DQ 검사, 배분 연산, UOM 환산 |
| `tests/integration/` | 샘플 데이터 파일을 사용한 엔드투엔드 파이프라인 |
| `tests/dq/` | 정상/비정상 파일에 대한 DQ 규칙 검증 |

---

## 파일 명명 규칙

`inbox/`의 파일은 다음 패턴을 따라야 합니다:

```
{table_name}_{YYYYMMDD}.{csv|xlsx}
```

예시:

| 파일명 | 대상 테이블 |
|---|---|
| `fact_order_20250115.csv` | `core.fact_order` |
| `fact_shipment_20250115.csv` | `core.fact_shipment` |
| `dim_item_20250115.xlsx` | `core.dim_item` |
| `fact_charge_actual_20250115.csv` | `core.fact_charge_actual` |

파일명이 어떤 알려진 테이블과도 매칭되지 않으면 `inbox/failed/`로 이동되고 로그가 기록됩니다.

---

## 문제 해결

| 문제 | 원인 | 해결 방법 |
|---|---|---|
| `"Pipeline is locked"` | 이전 실행이 비정상 종료되었거나 아직 실행 중 | 다른 프로세스가 없는지 확인 후 `python run.py --unlock` |
| 모든 파일에서 DQ 실패 | 스키마 변경 또는 컬럼 별칭 미설정 | `config/column_aliases.yaml` 확인; `python run.py --dry-run`으로 상세 확인 |
| 마트에 데이터 누락 | 새 파일이 아직 수집되지 않음 | `inbox/`에 파일을 넣고 `python run.py --once` 실행 |
| `"Period is closed"` 오류 | 마감된 기간에 데이터 수집 시도 | `post_close_adjustment()` 사용 또는 `python run.py --unlock`으로 재개 |
| 실행 후 마트 테이블 비어 있음 | DQ 실패로 데이터가 적재되지 않음 | `ops.ops_issue_log`에서 CRITICAL/HIGH 이슈 확인 |
| 배분 보존 실패 | 버그 또는 데이터 경합 | `ops.ops_issue_log`에서 CRITICAL 배분 이슈 확인; 버그 리포트 제출 |
| Streamlit에 오래된 데이터 표시 | 대시보드 캐시 | 브라우저 새로고침; Streamlit은 페이지 로드마다 DuckDB를 다시 조회 |
| DuckDB에서 `"Database is locked"` | 동시 쓰기 시도 | DuckDB는 단일 작성자 허용; `--once`가 한 번에 하나만 실행되도록 확인 |
| 마트 구축 느림 | 대량 데이터 | `--status`로 행 수 확인; 파티셔닝 또는 과거 기간 아카이빙 고려 |
| 특정 통화에 환율 누락 | 시장 데이터 피드 공백 | `core.fact_exchange_rate`에 수동 삽입 또는 `inbox/`에 환율 파일 추가 |

---

## 환경 변수

| 변수 | 기본값 | 설명 |
|---|---|---|
| `SCM_DB_PATH` | `data/scm.duckdb` | DuckDB 데이터베이스 파일 경로 |
| `SCM_INBOX_DIR` | `inbox/` | 수집 파일 스캔 디렉토리 |
| `SCM_CONFIG_DIR` | `config/` | YAML 설정 파일 디렉토리 |
| `SCM_LOG_LEVEL` | `INFO` | 로깅 레벨 (DEBUG, INFO, WARNING, ERROR) |
