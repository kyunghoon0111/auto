# 기간 마감 프로세스

> 기간 마감 절차, 마감 후 조정, 잠긴 기간 재개.

---

## 개요

기간 마감은 특정 월의 데이터를 확정하고, 추가 수정을 방지하며, 감사를 위해 상태를 스냅샷하는 과정입니다. 마감 프로세스는 해당 기간의 재무 보고서와 비용 배분이 안정적이고 재현 가능하도록 보장합니다.

### 기간 상태

| 상태 | 설명 | 데이터 수집 | 조정 | 마트 재구축 |
|---|---|---|---|---|
| `OPEN` | 활성 기간; 데이터가 정상적으로 흐름 | 허용 | 해당 없음 (직접 쓰기) | 예 |
| `CLOSED` | 기간 확정; 직접 쓰기 차단 | 차단 | `ops_adjustment_log`를 통해서만 | 예 (조정 포함) |
| `LOCKED` | 감사용 하드 잠금; 변경 불가 | 차단 | 차단 | 동결된 스냅샷 사용 |

---

## 마감 전 체크리스트

기간 마감 전 다음을 확인하세요:

| # | 확인 항목 | 명령 / 위치 | 통과 기준 |
|---|---|---|---|
| 1 | 예상된 모든 소스 파일 수집 완료 | `python run.py --status` | 해당 기간에 누락 파일 없음 |
| 2 | REQUIRED 도메인 커버리지율 100% | `--status`의 커버리지 섹션 | 모든 필수 테이블에 데이터 존재 |
| 3 | 해당 기간에 CRITICAL DQ 이슈 없음 | `ops.ops_issue_log` | 해당 기간에 CRITICAL 행 0개 |
| 4 | 대사 마트에 FAIL 상태 없음 | `mart.reco_*` 테이블 | 모든 대사 검사 OK 또는 WARN |
| 5 | 배분 보존 유지 | `mart.reco_charges_invoice_vs_allocated` | 모든 행 BALANCED |
| 6 | 사용된 모든 통화에 환율 존재 | `core.fact_exchange_rate` | 모든 거래 일자에 환율 존재 |
| 7 | 이해관계자 승인 | 수동 프로세스 | 재무/운영 승인 확보 |

---

## 기간 마감

### Python API 사용

```python
from src.period_close import close_period

close_period(
    con=con,                    # DuckDB 연결
    period_key="2025-01",       # YYYY-MM 형식
    closed_by="finance_lead",   # 사용자 또는 시스템 식별자
    notes="2025년 1월 마감"      # 선택적 비고
)
```

### `close_period()` 동작

1. **마감 전 조건 검증:**
   - REQUIRED 도메인 커버리지율 확인; 100% 미만이면 `ValueError` 발생.
   - 미해결 CRITICAL DQ 이슈 확인; 있으면 `ValueError` 발생.

2. **PRE_CLOSE 스냅샷 생성:**
   - 해당 기간 필터된 모든 core 테이블의 행 수와 체크섬 캡처.
   - `snapshot_type = 'PRE_CLOSE'`로 `ops.ops_snapshot`에 기록.

3. **기간 상태 업데이트:**
   - `ops.ops_period_close`에서 `status = 'CLOSED'`, `closed_at = NOW()`, `closed_by` 설정.

4. **마트 최종 재구축:**
   - 마지막 수정사항을 포함한 최신 데이터가 모든 마트 테이블에 반영되도록 보장.

5. **POST_CLOSE 스냅샷 생성:**
   - 마트 재구축 후 최종 상태 캡처.
   - `snapshot_type = 'POST_CLOSE'`로 `ops.ops_snapshot`에 기록.

---

## 마감 후 조정

기간이 마감되면 직접 데이터 수집이 차단됩니다. 모든 변경은 완전한 감사 추적을 제공하는 조정 로그를 통해야 합니다.

### Python API 사용

```python
from src.period_close import post_close_adjustment

post_close_adjustment(
    con=con,
    period_key="2025-01",
    table_name="fact_order",
    record_key="ORD-2025-0001234|0001",   # 비즈니스 키 (파이프 구분 복합 키)
    adjustment_type="UPDATE",              # INSERT / UPDATE / DELETE
    old_value='{"ordered_qty": 10}',       # 이전 값 JSON
    new_value='{"ordered_qty": 12}',       # 새 값 JSON
    reason="고객 요청에 의한 수정 (티켓 #4567)",
    adjusted_by="ops_analyst"
)
```

### 처리 내용

1. 조정이 `ops.ops_adjustment_log`에 기록됨.
2. core 테이블의 실제 데이터가 현장에서 업데이트됨.
3. 조정을 반영하여 마트 재구축.
4. 조정이 Streamlit 대시보드 감사 추적에 표시됨.

### 조정 제약조건

- `period_key`는 `CLOSED` 기간을 참조해야 함 (`OPEN` 또는 `LOCKED` 아님).
- `table_name`은 유효한 core 테이블이어야 함.
- `record_key`는 테이블의 기존 비즈니스 키와 매칭되어야 함.
- `reason`은 필수이며 비어 있으면 안 됨.
- `adjusted_by`는 필수.

---

## 마감 시 커버리지 강화

기간 마감 시 커버리지 정책이 강화됩니다. 정상 운영 중 `OPTIONAL`인 일부 테이블이 마감 시 `REQUIRED`로 승격됩니다:

| 테이블 / 도메인 | 일반 | 마감 시 | 근거 |
|---|---|---|---|
| `fact_exchange_rate` | OPTIONAL | **REQUIRED** | 다중 통화 비용 통합에 환율 필요 |
| `fact_settlement` | OPTIONAL | **REQUIRED** | 정확한 P&L을 위해 실제 인보이스 필요 |
| `fact_cost_structure` | OPTIONAL | **REQUIRED** | 마진 보고에 완전한 COGS 필요 |
| `fact_charge_actual` | OPTIONAL | **REQUIRED** | 대사에 배분된 비용 필수 |

마감하려는 기간에 이 테이블 중 데이터가 없는 것이 있으면 `close_period()`가 오류를 발생시킵니다. 명시적 승인이 있을 때만 `force=True`로 재정의:

```python
close_period(con, "2025-01", "finance_lead", force=True,
             notes="강제 마감: 정산 데이터 다음 주 도착 예정")
```

---

## 기간 재개

재개는 긴급 상황에서만 수행해야 합니다. 기간을 `CLOSED`에서 `OPEN`으로 되돌려 직접 데이터 수집을 다시 허용합니다.

### Python API 사용

```python
from src.period_close import reopen_period

reopen_period(
    con=con,
    period_key="2025-01",
    reason="인시던트 #789에 따른 대규모 데이터 수정 필요"
)
```

### CLI 사용

```bash
python run.py --unlock
```

`--unlock` 명령은 가장 최근에 마감된 기간을 재개하고 배치 잠금을 해제합니다.

### 재개 시 동작

1. 기간 상태를 `OPEN`으로 복원.
2. `closed_at` 및 `closed_by` 필드 초기화.
3. 재개자와 사유를 `ops.ops_adjustment_log`에 기록.
4. 해당 기간에 대한 직접 수집 재활성화.
5. **POST_CLOSE 스냅샷은 감사 비교를 위해 보존.**

### 제한사항

- `LOCKED` 기간은 `reopen_period()`로 재개 불가. 먼저 데이터베이스 관리자가 직접 SQL로 잠금을 해제해야 함.
- 기간 재개는 POST_CLOSE 스냅샷을 무효화함. 새로운 마감 사이클 (새 스냅샷 포함)이 필요.

---

## 기간 잠금 (감사 동결)

마감 후 기간을 `LOCKED`로 추가 강화할 수 있습니다:

```python
from src.period_close import lock_period

lock_period(con, "2025-01", locked_by="cfo")
```

잠금 후:
- 조정도 허용되지 않음 (`ops_adjustment_log`를 통해서도 불가).
- 해당 기간의 마트 데이터는 동결된 POST_CLOSE 스냅샷에서 제공.
- 직접 SQL로만 잠금 해제 가능 (API나 CLI로 불가).

---

## 타임라인 예시

```
1~31일:    2025-01 기간 OPEN
           -> --once로 매일 파일 수집
           -> 매 실행마다 마트 재구축

2월 3일:   마감 전 체크리스트 완료
           -> close_period(con, "2025-01", "finance_lead")
           -> 상태: CLOSED
           -> PRE_CLOSE 및 POST_CLOSE 스냅샷 생성

2월 5일:   마감 후 조정 필요
           -> post_close_adjustment(..., reason="지연 인보이스")
           -> 조정을 반영하여 마트 재구축

2월 10일:  감사 동결
           -> lock_period(con, "2025-01", "cfo")
           -> 상태: LOCKED
           -> 더 이상 변경 불가
```
